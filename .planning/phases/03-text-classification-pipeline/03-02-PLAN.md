---
phase: 03-text-classification-pipeline
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - mobile/app/capture/text.tsx
  - mobile/lib/ag-ui-client.ts
  - mobile/lib/types.ts
  - backend/tests/test_classification.py
  - backend/tests/conftest.py
autonomous: true
requirements: [ORCH-06, CLAS-03]

must_haves:
  truths:
    - "After submitting text, user sees 'Filed -> {Bucket} ({confidence})' toast instead of generic 'Sent' toast"
    - "After successful filing, user stays on text input screen with cleared text field (not navigated back)"
    - "Error state shows 'Couldn't file your capture. Try again.' toast"
    - "Classification tool correctly writes bi-directionally linked records to Inbox and bucket container"
    - "Junk input creates Inbox-only record with status 'unclassified'"
  artifacts:
    - path: "mobile/app/capture/text.tsx"
      provides: "Updated text capture screen with classification result toast and stay-on-screen behavior"
      contains: "Filed"
    - path: "mobile/lib/ag-ui-client.ts"
      provides: "Updated SSE client that extracts TEXT_MESSAGE_CONTENT for classification result"
      contains: "TEXT_MESSAGE_CONTENT"
    - path: "backend/tests/test_classification.py"
      provides: "Unit tests for ClassificationTools classify_and_file and mark_as_junk"
      contains: "test_classify_and_file"
  key_links:
    - from: "mobile/app/capture/text.tsx"
      to: "mobile/lib/ag-ui-client.ts"
      via: "sendCapture onComplete callback receives classification result string"
      pattern: "onComplete.*result"
    - from: "mobile/lib/ag-ui-client.ts"
      to: "backend AG-UI endpoint"
      via: "SSE TEXT_MESSAGE_CONTENT events accumulated for classification result"
      pattern: "TEXT_MESSAGE_CONTENT"
    - from: "backend/tests/test_classification.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "direct import and mock-based testing"
      pattern: "ClassificationTools"
---

<objective>
Update the mobile text capture screen to display classification results (e.g., "Filed -> Projects (0.85)") and stay on-screen for rapid-fire capture. Add backend unit tests for the classification tool.

Purpose: Close the user feedback loop -- Will sees exactly where his capture was filed and can immediately capture the next thought without navigating back. Tests ensure the classification tool correctly handles all paths (high confidence, low confidence, junk).
Output: Updated mobile capture screen with classification-aware toast + backend test suite for classification.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-text-classification-pipeline/03-CONTEXT.md
@.planning/phases/03-text-classification-pipeline/03-RESEARCH.md
@.planning/phases/03-text-classification-pipeline/03-01-SUMMARY.md
@mobile/app/capture/text.tsx
@mobile/lib/ag-ui-client.ts
@mobile/lib/types.ts
@backend/tests/conftest.py
@backend/src/second_brain/tools/classification.py
@backend/src/second_brain/models/documents.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update mobile text capture to show classification result and stay on screen</name>
  <files>
    mobile/lib/ag-ui-client.ts
    mobile/lib/types.ts
    mobile/app/capture/text.tsx
  </files>
  <action>
**1. Update types** (`mobile/lib/types.ts`):

- Add `"TEXT_MESSAGE_CONTENT"` to the `AGUIEventType` union type (currently only has event types for fire-and-forget; now we need to capture content)
- Update `SendCaptureOptions` interface:
  - Change `onComplete` from `() => void` to `(result: string) => void` -- it now receives the accumulated classification result text

**2. Update AG-UI client** (`mobile/lib/ag-ui-client.ts`):

- Accumulate TEXT_MESSAGE_CONTENT delta events to build the full classification result string
- Add a mutable `result` string variable (empty initially)
- Add event listener for `"TEXT_MESSAGE_CONTENT"`: parse the event data as JSON, extract `delta` field, append to `result`
  - AG-UI TEXT_MESSAGE_CONTENT events have JSON data: `{"message_id":"...","delta":"Filed"}`
  - The delta comes in chunks; accumulate them: `result += parsed.delta`
- Update the `"RUN_FINISHED"` handler to pass `result` to `onComplete(result)`
- Keep error handler unchanged
- Note: Phase 3 research mentions the echo bug (Issue #3206) where user input may be echoed. The accumulated result will include the echo. The classifier's final confirmation ("Filed -> Projects (0.85)") is the LAST part of the accumulated text. For Phase 3, accept this -- the echo is cosmetic and the toast will show the full result including any echo prefix. Phase 4 will add proper filtering.

**3. Update text capture screen** (`mobile/app/capture/text.tsx`):

- Change `onComplete` callback to accept `result: string` parameter
- Update success flow per locked CONTEXT.md decisions:
  - **Toast message**: Use `result` as the toast message (e.g., "Filed -> Projects (0.85)"). If `result` is empty/falsy, fall back to "Captured" as a generic success message.
  - **Stay on screen**: Remove the `setTimeout(() => { router.back(); }, 500)` line. Per CONTEXT.md: "After toast: Stay on text input screen (clear field, ready for next capture). This changes Phase 2's auto-navigate-back behavior."
  - **Clear input**: After successful filing, set `setThought("")` to clear the text field for the next capture
  - Keep haptic feedback on success
  - Toast auto-dismiss stays at 2 seconds (existing useEffect handles this)
- Update error flow per locked CONTEXT.md decisions:
  - Change error message to: "Couldn\u2019t file your capture. Try again." (per CONTEXT.md: "Generic error toast 'Couldn't file your capture. Try again.' -- no technical details"). Use unicode escape \u2019 for curly apostrophe and \u2014 is NOT needed here -- the CONTEXT.md specifies this exact string.
  - Text is preserved on error (already the case -- no `setThought("")` on error path)
- Update toast display duration: 2-3 seconds per CONTEXT.md. Keep 2 seconds (already set).
  </action>
  <verify>
- `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit` passes with no type errors
- Manual inspection: `text.tsx` no longer calls `router.back()` on success
- Manual inspection: `text.tsx` calls `setThought("")` on success
- Manual inspection: `ag-ui-client.ts` listens for TEXT_MESSAGE_CONTENT and accumulates delta
- Manual inspection: `ag-ui-client.ts` passes accumulated result to onComplete
  </verify>
  <done>
- Mobile text capture shows classification result toast (e.g., "Filed -> Projects (0.85)")
- After successful capture, user stays on text input screen with cleared text field
- Error toast shows "Couldn't file your capture. Try again."
- SSE client accumulates TEXT_MESSAGE_CONTENT deltas to build result string
  </done>
</task>

<task type="auto">
  <name>Task 2: Backend unit tests for classification tools</name>
  <files>
    backend/tests/test_classification.py
    backend/tests/conftest.py
  </files>
  <action>
**1. Update conftest** (`backend/tests/conftest.py`):

- No major changes needed -- the `mock_cosmos_manager` fixture already provides mock containers for all 5 containers (Inbox, People, Projects, Ideas, Admin) with `create_item` AsyncMock
- Ensure `create_item` returns a dict with at least `{"id": "..."}` by default (set `return_value` if not already)

**2. Create classification tests** (`backend/tests/test_classification.py`):

Write tests using the `mock_cosmos_manager` fixture. Create a `ClassificationTools` instance with the mock manager.

**Test cases (minimum 7 tests):**

a. **test_classify_and_file_high_confidence** -- bucket="Projects", confidence=0.85
   - Assert Inbox container.create_item called once with doc containing: rawText, classificationMeta with all four scores, status="classified", filedRecordId set
   - Assert Projects container.create_item called once with doc containing: rawText, title, inboxRecordId set, classificationMeta
   - Assert return value matches `"Filed â†’ Projects (0.85)"`
   - Verify bi-directional link: inbox filedRecordId matches bucket doc id, and bucket inboxRecordId matches inbox doc id

b. **test_classify_and_file_low_confidence** -- bucket="People", confidence=0.45
   - Assert Inbox container.create_item called with status="low_confidence"
   - Assert People container.create_item STILL called (per CONTEXT.md: "still file to best bucket")
   - Assert return value still matches the confirmation format

c. **test_classify_and_file_each_bucket** -- parametrize over ["People", "Projects", "Ideas", "Admin"]
   - Assert correct container receives the document
   - Assert People uses `name` field, others use `title` field

d. **test_classify_and_file_invalid_bucket** -- bucket="Unknown"
   - Assert returns error string, no container writes

e. **test_classify_and_file_confidence_clamping** -- confidence=1.5 -> clamped to 1.0, confidence=-0.1 -> clamped to 0.0
   - Assert clamped values appear in the stored ClassificationMeta

f. **test_mark_as_junk** -- raw_text="asdfghjkl"
   - Assert Inbox container.create_item called with status="unclassified", no classificationMeta
   - Assert NO bucket container.create_item called
   - Assert return value matches "Capture logged as unclassified"

g. **test_classification_meta_fields** -- Verify the ClassificationMeta stored in the document has all required fields: bucket, confidence, allScores (4 entries), classifiedBy, agentChain, classifiedAt

h. **test_bidirectional_links** -- Verify inbox doc filedRecordId equals bucket doc id, and bucket doc inboxRecordId equals inbox doc id. Extract IDs from the create_item call args.

Use `pytest.mark.asyncio` decorator (or rely on `asyncio_mode = "auto"` from pyproject.toml). Mock the `create_item` to return the body it was called with (set side_effect to echo the body arg back as the return value).
  </action>
  <verify>
- `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -m pytest tests/test_classification.py -v` -- all tests pass
- `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -m pytest tests/ -v` -- all existing + new tests pass (no regressions)
- `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check tests/test_classification.py` -- no lint errors
  </verify>
  <done>
- 7+ unit tests for ClassificationTools covering high confidence, low confidence, all four buckets, invalid bucket, confidence clamping, junk handling, classification meta completeness, and bi-directional linking
- All tests pass with mocked CosmosManager (no Azure calls)
- No test regressions in existing test suite
  </done>
</task>

</tasks>

<verification>
1. Mobile TypeScript compiles: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit`
2. All backend tests pass: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -m pytest tests/ -v`
3. Mobile capture stays on screen (no router.back in success path): `grep -c "router.back" mobile/app/capture/text.tsx` should return 0
4. Classification result flows from SSE to toast: `grep "TEXT_MESSAGE_CONTENT" mobile/lib/ag-ui-client.ts` finds the event listener
</verification>

<success_criteria>
- User sees "Filed -> Projects (0.85)" toast after submitting text (classification result, not generic "Sent")
- User stays on text input screen with cleared field after successful capture
- Error toast says "Couldn't file your capture. Try again."
- 7+ classification unit tests pass covering all paths
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/03-text-classification-pipeline/03-02-SUMMARY.md`
</output>
