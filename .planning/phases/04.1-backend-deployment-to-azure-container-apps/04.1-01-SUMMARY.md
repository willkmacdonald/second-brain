---
phase: 04.1-backend-deployment-to-azure-container-apps
plan: 01
subsystem: infra
tags: [docker, uv, multi-stage-build, containerization, fastapi, uvicorn]

# Dependency graph
requires:
  - phase: 01-backend-foundation
    provides: FastAPI app with lifespan, health endpoint, pydantic-settings config
provides:
  - Multi-stage Dockerfile producing slim Python 3.12 runtime image
  - .dockerignore excluding dev files and secrets from build context
  - Graceful startup fallback when Azure credentials unavailable
affects: [04.1-02 CI/CD pipeline, future deployment phases]

# Tech tracking
tech-stack:
  added: [ghcr.io/astral-sh/uv:0.5.4 (Docker COPY source)]
  patterns: [multi-stage Docker build with uv, two-step dependency caching, non-root container user]

key-files:
  created:
    - backend/Dockerfile
    - backend/.dockerignore
  modified:
    - backend/src/second_brain/main.py

key-decisions:
  - "uv 0.5.4 pinned for reproducible builds (COPY --from=ghcr.io/astral-sh/uv:0.5.4)"
  - "Port 8000 in container (standard), not 8003 (local dev only)"
  - "Graceful chat client fallback: server starts without Azure OpenAI credentials"
  - "uv.lock tracked in git for reproducible Docker builds"

patterns-established:
  - "Multi-stage uv build: builder installs deps, runtime copies .venv + src only"
  - "Two-step uv sync: deps layer cached separately from source layer"
  - "Non-root app user (uid 1001) in all production containers"

requirements-completed: [INFRA-01]

# Metrics
duration: 3min
completed: 2026-02-23
---

# Phase 04.1 Plan 01: Dockerfile Summary

**Multi-stage Dockerfile with uv 0.5.4 producing slim Python 3.12 container that starts uvicorn on port 8000 with non-root user and graceful Azure credential fallback**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-23T18:23:50Z
- **Completed:** 2026-02-23T18:27:32Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Multi-stage Dockerfile with two-step uv sync for optimal layer caching
- Container responds to /health on port 8000, runs as non-root user (app:1001)
- .dockerignore excludes .venv, .env, tests, and dev tooling from build context
- Graceful startup without Azure credentials (server starts, AG-UI endpoints degraded)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Dockerfile with multi-stage uv build** - `97b80da` (feat)
2. **Task 2: Create .dockerignore for clean build context** - `43cd015` (chore)

## Files Created/Modified
- `backend/Dockerfile` - Multi-stage uv build producing slim Python 3.12 runtime image
- `backend/.dockerignore` - Exclusion rules for Docker build context (dev files, secrets, tests)
- `backend/src/second_brain/main.py` - Wrapped chat client creation in try/except for graceful startup
- `backend/uv.lock` - Tracked for reproducible Docker builds (was untracked)

## Decisions Made
- **uv version pinned to 0.5.4:** Matches lockfile resolution; avoids build drift from floating latest
- **Port 8000 in container:** Standard ASGI port; local dev uses 8003 via `__main__` block which Docker CMD bypasses
- **Graceful chat client fallback added:** AzureOpenAIChatClient creation crashes without Azure creds; wrapped in try/except matching existing Key Vault and Cosmos DB fallback pattern
- **uv.lock committed to git:** Required by `COPY pyproject.toml uv.lock .python-version ./` in Dockerfile; was untracked

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Committed untracked uv.lock file**
- **Found during:** Task 1 (Dockerfile creation)
- **Issue:** uv.lock was not tracked by git; Dockerfile COPY would fail in CI/CD where only tracked files are available
- **Fix:** Added uv.lock to git tracking
- **Files modified:** backend/uv.lock
- **Verification:** Docker build succeeds with COPY pyproject.toml uv.lock .python-version
- **Committed in:** 97b80da (Task 1 commit)

**2. [Rule 1 - Bug] Wrapped AzureOpenAIChatClient creation in try/except**
- **Found during:** Task 1 (Docker container startup verification)
- **Issue:** Container crashed on startup because AzureOpenAIChatClient requires valid Azure credentials (DefaultAzureCredential fails without Azure CLI/managed identity); unlike Key Vault and Cosmos DB init, this was not wrapped in graceful fallback
- **Fix:** Wrapped chat client + agent creation in try/except, setting app.state.workflow_agent and app.state.classification_tools to None on failure (matching existing fallback pattern)
- **Files modified:** backend/src/second_brain/main.py
- **Verification:** Container starts, /health returns 200 with {"status":"ok"}, logs warning about unavailable credentials
- **Committed in:** 97b80da (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both fixes necessary for Docker build and container startup. No scope creep.

## Issues Encountered
None beyond the auto-fixed deviations documented above.

## User Setup Required
None - no external service configuration required. Docker must be installed locally to build/test.

## Next Phase Readiness
- Dockerfile and .dockerignore ready for CI/CD pipeline (Plan 02)
- Container image can be built and pushed to ACR by GitHub Actions
- Health endpoint verified working for Container Apps health probes
- Pre-existing config changes (.env.example, config.py secret name rename) remain unstaged -- not part of this plan

## Self-Check: PASSED

All artifacts verified:
- backend/Dockerfile: FOUND
- backend/.dockerignore: FOUND
- Commit 97b80da: FOUND
- Commit 43cd015: FOUND
- SUMMARY.md: FOUND

---
*Phase: 04.1-backend-deployment-to-azure-container-apps*
*Completed: 2026-02-23*
