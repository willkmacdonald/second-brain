---
phase: 04.1-backend-deployment-to-azure-container-apps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/Dockerfile
  - backend/.dockerignore
autonomous: true
requirements:
  - INFRA-01
must_haves:
  truths:
    - "Docker build succeeds and produces a runnable container image"
    - "Container starts uvicorn on port 8000 and responds to /health"
    - "Production image excludes dev dependencies, tests, .env, and .venv"
    - "Image runs as non-root user for security"
  artifacts:
    - path: "backend/Dockerfile"
      provides: "Multi-stage uv build producing slim Python 3.12 runtime image"
      contains: "FROM python:3.12-slim-bookworm"
    - path: "backend/.dockerignore"
      provides: "Exclusion rules for Docker build context"
      contains: ".venv"
  key_links:
    - from: "backend/Dockerfile"
      to: "backend/pyproject.toml"
      via: "uv sync reads pyproject.toml and uv.lock for dependency installation"
      pattern: "COPY pyproject.toml uv.lock"
    - from: "backend/Dockerfile"
      to: "second_brain.main:app"
      via: "uvicorn CMD references the FastAPI app entrypoint"
      pattern: "uvicorn.*second_brain\\.main:app"
---

<objective>
Create the Dockerfile and .dockerignore for the FastAPI backend, using a multi-stage build with uv for fast, reproducible dependency installation.

Purpose: Containerize the backend so it can be deployed to Azure Container Apps. This is the foundation for the CI/CD pipeline in Plan 02.
Output: backend/Dockerfile, backend/.dockerignore -- verified by local Docker build and container health check.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-backend-deployment-to-azure-container-apps/04.1-RESEARCH.md
@backend/pyproject.toml
@backend/src/second_brain/main.py
@backend/src/second_brain/config.py
@backend/.python-version
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with multi-stage uv build</name>
  <files>backend/Dockerfile</files>
  <action>
Create a multi-stage Dockerfile following the research Pattern 1 exactly:

**Build stage (python:3.12-slim-bookworm AS builder):**
- COPY uv binary from `ghcr.io/astral-sh/uv:0.5.4` (pinned for reproducibility)
- Set WORKDIR /app
- Set uv environment variables: UV_COMPILE_BYTECODE=1, UV_LINK_MODE=copy, UV_PYTHON_DOWNLOADS=never, UV_PROJECT_ENVIRONMENT=/app/.venv
- Two-step dependency install for layer caching:
  1. COPY pyproject.toml uv.lock .python-version -> `uv sync --frozen --no-install-project --no-dev`
  2. COPY src/ -> `uv sync --frozen --no-dev --no-editable`

**Runtime stage (python:3.12-slim-bookworm AS runtime):**
- Create non-root user: groupadd app (gid 1001), useradd app (uid 1001)
- WORKDIR /app
- Set PATH="/app/.venv/bin:$PATH", PYTHONDONTWRITEBYTECODE=1, PYTHONUNBUFFERED=1
- COPY --from=builder --chown=app:app /app/.venv and /app/src
- USER app
- EXPOSE 8000
- CMD: `uvicorn second_brain.main:app --host 0.0.0.0 --port 8000`

Note: Port 8000 in the container (standard), not 8003 (local dev). This is fine because config.py uses pydantic-settings which reads env vars directly -- the port is only set in the CMD, not in app config. The `if __name__ == "__main__"` block in main.py (port 8003) is for local dev only and is not used by the CMD.
  </action>
  <verify>
Run `docker build -t second-brain-api:test ./backend` from the repo root. Build should complete without errors.
Then run `docker run --rm -p 8000:8000 -e AZURE_OPENAI_ENDPOINT=https://test.openai.azure.com/ -e KEY_VAULT_URL=https://test.vault.azure.net/ second-brain-api:test` and verify with `curl http://localhost:8000/health` returning `{"status":"ok"}`.
Note: The app will log warnings about Key Vault and Cosmos DB not being available -- this is expected and handled by the existing graceful fallback in the lifespan (per Phase 1 decision).
  </verify>
  <done>Docker build succeeds, container starts uvicorn on port 8000, /health returns 200 with {"status":"ok"}, container runs as non-root user (uid 1001).</done>
</task>

<task type="auto">
  <name>Task 2: Create .dockerignore for clean build context</name>
  <files>backend/.dockerignore</files>
  <action>
Create backend/.dockerignore to exclude files that should not be in the Docker build context:

```
# Virtual environment (built fresh in Docker)
.venv/
__pycache__/
*.pyc

# Environment files (secrets, local config)
.env
.env.*

# Testing (not needed in production image)
tests/
.pytest_cache/
.coverage
htmlcov/

# Development tools
.ruff_cache/
.git/
.gitignore

# IDE
.vscode/
.idea/

# OS
.DS_Store

# Documentation
*.md
```

This ensures the build context is small and no secrets (.env) or dev files leak into the image. The .env.example is excluded by the *.md pattern... actually no, .env.* covers .env.example. And *.md covers markdown files. Good.

Wait -- .env.example is matched by `.env.*` pattern. Correct. No issues.
  </action>
  <verify>Run `docker build -t second-brain-api:test ./backend` -- the build context should be small (no .venv, no tests, no .env). Check build output for "Sending build context to Docker daemon" size -- should be well under 10 MB.</verify>
  <done>.dockerignore exists and excludes .venv, .env, tests, __pycache__, .ruff_cache, and IDE files from the Docker build context.</done>
</task>

</tasks>

<verification>
1. `docker build -t second-brain-api:test ./backend` completes without errors
2. `docker run --rm -d -p 8000:8000 -e AZURE_OPENAI_ENDPOINT=https://test.openai.azure.com/ -e KEY_VAULT_URL=https://test.vault.azure.net/ --name sb-test second-brain-api:test` starts the container
3. `curl http://localhost:8000/health` returns `{"status":"ok"}`
4. `docker exec sb-test whoami` returns `app` (non-root)
5. `docker stop sb-test` cleans up
</verification>

<success_criteria>
- Dockerfile produces a working container image with the FastAPI app
- Container responds to /health on port 8000
- Image uses non-root user
- .dockerignore excludes dev files and secrets from build context
- Two-step uv sync provides layer caching (dependency changes don't rebuild source layer)
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-backend-deployment-to-azure-container-apps/04.1-01-SUMMARY.md`
</output>
