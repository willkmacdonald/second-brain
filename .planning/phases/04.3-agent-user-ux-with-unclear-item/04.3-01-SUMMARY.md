---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 01
subsystem: api
tags: [classification, misunderstood, dual-threshold, ag-ui, custom-events]

# Dependency graph
requires:
  - phase: 04-hitl-clarification-and-ag-ui-streaming
    provides: "Classification tools, classifier agent, AG-UI workflow adapter with HITL detection"
provides:
  - "request_misunderstood tool for truly unclear input"
  - "Dual-threshold classification (misunderstood < 0.3, low-confidence 0.3-0.59, high >= 0.6)"
  - "MISUNDERSTOOD custom event emission from adapter"
  - "Silent pending filing for low-confidence items (no HITL interruption)"
affects: [04.3-02, 04.3-03, 04.3-04]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Dual-threshold classification with distinct tool per outcome"
    - "MISUNDERSTOOD custom AG-UI event for conversational follow-up flow"
    - "Pending status with 'Filed (needs review)' return string for capture screen toast"

key-files:
  created: []
  modified:
    - backend/src/second_brain/tools/classification.py
    - backend/src/second_brain/agents/classifier.py
    - backend/src/second_brain/agents/workflow.py
    - backend/tests/test_classification.py

key-decisions:
  - "request_clarification replaced entirely by request_misunderstood (not kept alongside)"
  - "Low-confidence items get status='pending' (was 'low_confidence') -- consistent with mobile isPendingStatus"
  - "Pending return string 'Filed (needs review)' distinct from classified 'Filed' for capture screen toast"
  - "Misunderstood tool creates inbox doc with no classificationMeta and no bucket filing"
  - "Low-confidence HITL_REQUIRED fallback removed -- pending items complete silently"

patterns-established:
  - "Dual-threshold pattern: misunderstood (<0.3) uses conversational tool, low-confidence (0.3-0.59) silently files"
  - "MISUNDERSTOOD event payload: {threadId, inboxItemId, questionText} -- same shape as HITL_REQUIRED for client consistency"

requirements-completed: [CLAS-04, APPX-04]

# Metrics
duration: 4min
completed: 2026-02-24
---

# Phase 04.3 Plan 01: Backend Dual-Threshold Classification Summary

**Dual-threshold classification system replacing single-threshold HITL: misunderstood input triggers conversational follow-up via MISUNDERSTOOD event, low-confidence items silently file as pending**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-24T03:46:47Z
- **Completed:** 2026-02-24T03:50:50Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Replaced request_clarification with request_misunderstood tool for truly unclear input (creates misunderstood inbox doc with conversational question)
- Updated classify_and_file to set status="pending" for low-confidence items with distinct "Filed (needs review)" return string
- Rewrote classifier instructions with three-tier decision flow (misunderstood / low-confidence / high-confidence)
- Added MISUNDERSTOOD custom event emission to AG-UI adapter, removed low-confidence HITL_REQUIRED fallback
- All 38 backend tests pass (14 classification tests, 24 other tests)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add request_misunderstood tool and update classify_and_file** - `4fd67f9` (feat)
2. **Task 2: Update classifier instructions and adapter for misunderstood detection** - `8f7eb47` (feat)

## Files Created/Modified
- `backend/src/second_brain/tools/classification.py` - Removed request_clarification, added request_misunderstood, classify_and_file now sets "pending" status
- `backend/src/second_brain/agents/classifier.py` - Three-tier classifier instructions, request_misunderstood in tool list
- `backend/src/second_brain/agents/workflow.py` - _MISUNDERSTOOD_RE regex, _extract_misunderstood method, MISUNDERSTOOD event emission, removed low-confidence HITL fallback
- `backend/tests/test_classification.py` - Replaced request_clarification tests with request_misunderstood tests, updated low-confidence status assertion

## Decisions Made
- request_clarification replaced entirely by request_misunderstood (not kept alongside) -- the old tool conflated "uncertain between buckets" with "truly can't understand", the new system splits these cleanly
- Low-confidence items get status="pending" (was "low_confidence") -- consistent with mobile app's isPendingStatus check and simpler for the inbox UI
- Pending return string "Filed (needs review)" is distinct from classified "Filed" so the capture screen can show appropriate toast
- Misunderstood tool creates inbox doc with no classificationMeta and no bucket filing -- truly unclear input has no meaningful classification to store
- Low-confidence HITL_REQUIRED fallback removed from adapter -- pending items now complete the normal capture flow without interruption

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Backend classification pipeline fully supports three outcomes: classified, pending, misunderstood
- MISUNDERSTOOD event ready for mobile capture screen consumption (Plan 03)
- Pending status ready for inbox detail card bucket buttons (Plan 04)
- request_clarification still referenced in workflow.py _CLARIFICATION_RE for respond endpoint backward compatibility (existing HITL flow for conversational responses)

## Self-Check: PASSED

All 4 modified files verified on disk. Both task commits (4fd67f9, 8f7eb47) found in git history. 38/38 backend tests passing.

---
*Phase: 04.3-agent-user-ux-with-unclear-item*
*Completed: 2026-02-24*
