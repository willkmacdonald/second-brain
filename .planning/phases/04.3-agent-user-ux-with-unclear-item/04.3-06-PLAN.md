---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/app/(tabs)/inbox.tsx
  - mobile/components/InboxItem.tsx
autonomous: true
requirements: [CLAS-04, APPX-04]
gap_closure: true

must_haves:
  truths:
    - "Inbox detail card shows 4 bucket buttons for ALL item statuses (classified, pending, misunderstood, unresolved)"
    - "Misunderstood items show 'Needs Clarification' label in inbox list (not 'Pending')"
    - "Misunderstood items included in inbox badge count"
    - "Misunderstood items show clarificationText in detail card instead of 'Unknown' bucket metadata"
  artifacts:
    - path: "mobile/app/(tabs)/inbox.tsx"
      provides: "Always-visible bucket buttons, misunderstood detail card rendering, badge count fix"
      contains: "misunderstood"
    - path: "mobile/components/InboxItem.tsx"
      provides: "Needs Clarification label for misunderstood items"
      contains: "Needs Clarification"
  key_links:
    - from: "mobile/app/(tabs)/inbox.tsx"
      to: "backend/src/second_brain/api/inbox.py"
      via: "PATCH recategorize for all item types"
      pattern: "recategorize"
---

<objective>
Fix mobile inbox display issues diagnosed in UAT: (1) bucket buttons not shown for classified items (Test 6), (2) misunderstood items show broken display with 'Unknown' bucket and 'Pending' label (Test 9), and (3) misunderstood items not counted in badge.

Purpose: UAT Tests 6 and 9 fail due to inbox UI logic being too narrow in its status checks. These are independent of the backend streaming fixes in Plan 05.
Output: Updated inbox.tsx and InboxItem.tsx with correct status handling for all item types.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-04-SUMMARY.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-UAT.md
@mobile/app/(tabs)/inbox.tsx
@mobile/components/InboxItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix inbox detail card bucket buttons visibility for all statuses</name>
  <files>mobile/app/(tabs)/inbox.tsx</files>
  <action>
Three changes to inbox.tsx:

**Change 1: Show bucket buttons for ALL items (not just pending/classified).**

Current code (lines 313-320 in the IIFE):
```typescript
const isPendingItem =
  selectedItem?.status === "pending" ||
  selectedItem?.status === "low_confidence";
const isClassifiedItem = selectedItem?.status === "classified";
const showBucketButtons = isPendingItem || isClassifiedItem;
if (!showBucketButtons) return null;
```

The `showBucketButtons` condition excludes misunderstood and unresolved items. Change to always show bucket buttons when an item is selected:
```typescript
const isPendingItem =
  selectedItem?.status === "pending" ||
  selectedItem?.status === "low_confidence" ||
  selectedItem?.status === "misunderstood" ||
  selectedItem?.status === "unresolved";
const isClassifiedItem = selectedItem?.status === "classified";
// Always show bucket buttons -- all items can be manually categorized
```

Remove the `if (!showBucketButtons) return null;` line entirely. Bucket buttons should always render in the detail card.

Update the button label: for misunderstood/unresolved items use "File to bucket" (same as pending), for classified use "Move to bucket". The label logic becomes:
```typescript
<Text style={styles.detailLabel}>
  {isClassifiedItem ? "Move to bucket" : "File to bucket"}
</Text>
```

For the handler: misunderstood and unresolved items should use `handlePendingResolve` (not `handleRecategorize`) since they don't have an existing bucket doc to move from. The `isPendingItem` definition above already includes misunderstood/unresolved, so the existing ternary `isPendingItem ? handlePendingResolve(...) : handleRecategorize(...)` will correctly route.

**Change 2: Add 'misunderstood' to badge count.**

Current code (line 80-81):
```typescript
const isPendingStatus = (s: string) =>
  s === "pending" || s === "low_confidence" || s === "unresolved";
```

Add `s === "misunderstood"` to the condition:
```typescript
const isPendingStatus = (s: string) =>
  s === "pending" || s === "low_confidence" || s === "unresolved" || s === "misunderstood";
```

**Change 3: Add conditional detail card rendering for misunderstood items.**

Currently the detail card always shows Bucket/Confidence/Agent Chain metadata from `classificationMeta`. For misunderstood items, `classificationMeta` is null, causing "Unknown" bucket, "N/A" confidence, "N/A" agent chain -- a broken-looking display.

Add a conditional section: if `selectedItem?.status === "misunderstood"` or `selectedItem?.status === "unresolved"`, show the `clarificationText` from the item instead of classification metadata. Specifically:

Replace the Bucket/Confidence/Agent Chain section (lines 283-305) with a conditional:

```tsx
{selectedItem?.classificationMeta ? (
  <>
    <View style={styles.detailRow}>
      <View style={styles.detailCol}>
        <Text style={styles.detailLabel}>Bucket</Text>
        <Text style={styles.detailValue}>
          {selectedItem.classificationMeta.bucket}
        </Text>
      </View>
      <View style={styles.detailCol}>
        <Text style={styles.detailLabel}>Confidence</Text>
        <Text style={styles.detailValue}>
          {Math.round(selectedItem.classificationMeta.confidence * 100)}%
        </Text>
      </View>
    </View>
    <Text style={styles.detailLabel}>Agent Chain</Text>
    <Text style={styles.detailValue}>
      {selectedItem.classificationMeta.agentChain?.join(" -> ") ?? "N/A"}
    </Text>
  </>
) : (
  <>
    <Text style={styles.detailLabel}>Status</Text>
    <Text style={[styles.detailValue, { color: selectedItem?.status === "unresolved" ? "#ef4444" : "#f97316" }]}>
      {selectedItem?.status === "unresolved" ? "Unresolved" : "Needs Clarification"}
    </Text>
    {selectedItem?.clarificationText && (
      <>
        <Text style={styles.detailLabel}>Agent Question</Text>
        <Text style={styles.detailValue}>{selectedItem.clarificationText}</Text>
      </>
    )}
  </>
)}
```

This replaces the "Unknown" bucket / "N/A" display with meaningful content for misunderstood/unresolved items.
  </action>
  <verify>Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit` -- must pass with no TypeScript errors.</verify>
  <done>
(1) Bucket buttons visible in detail card for ALL item statuses including classified, misunderstood, and unresolved.
(2) 'misunderstood' status included in inbox badge count.
(3) Misunderstood/unresolved items show meaningful status and clarificationText in detail card instead of "Unknown" metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix InboxItem label for misunderstood status</name>
  <files>mobile/components/InboxItem.tsx</files>
  <action>
Change the bucket label logic for misunderstood items from "Pending" to "Needs Clarification".

Current code (lines 93-99):
```typescript
const isPending = item.status === "pending" || item.status === "low_confidence" || item.status === "misunderstood";
const isUnresolved = item.status === "unresolved";
const bucketLabel = isPending
  ? "Pending"
  : isUnresolved
    ? "Unresolved"
    : item.classificationMeta?.bucket ?? "Unknown";
```

Change to distinguish misunderstood from other pending statuses:
```typescript
const isMisunderstood = item.status === "misunderstood";
const isPending = item.status === "pending" || item.status === "low_confidence";
const isUnresolved = item.status === "unresolved";
const bucketLabel = isMisunderstood
  ? "Needs Clarification"
  : isPending
    ? "Pending"
    : isUnresolved
      ? "Unresolved"
      : item.classificationMeta?.bucket ?? "Unknown";
```

Also update the style application on line 127 to include `isMisunderstood` with the orange pending color:
```tsx
<Text style={[styles.bucket, (isPending || isMisunderstood) && styles.bucketPending, isUnresolved && styles.bucketUnresolved]}>
  {bucketLabel}
</Text>
```
  </action>
  <verify>Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit` -- must pass with no TypeScript errors.</verify>
  <done>
Misunderstood items show "Needs Clarification" label in orange in the inbox list, distinct from "Pending" for low-confidence items.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` in mobile directory: no TypeScript errors
- Bucket buttons render in detail card for classified, pending, misunderstood, and unresolved items
- Misunderstood items show "Needs Clarification" in list and meaningful content in detail card
- Badge count includes misunderstood items
</verification>

<success_criteria>
- All item statuses show bucket buttons in the detail card modal
- Misunderstood items display "Needs Clarification" label (not "Pending") with orange styling
- Misunderstood items show clarificationText (not "Unknown" bucket) in detail card
- Inbox badge count includes misunderstood items alongside pending and unresolved
- TypeScript type check passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-06-SUMMARY.md`
</output>
