---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 09
subsystem: api
tags: [ag-ui, regex, confidence, workflow-adapter, toast]

# Dependency graph
requires:
  - phase: 04.3-agent-user-ux-with-unclear-item
    provides: classify_and_file return string with post-fallback confidence values
provides:
  - _parse_classify_result helper for extracting corrected bucket/confidence from tool return string
  - clean_result text uses post-fallback confidence (0.75) instead of pre-fallback (0.00)
  - CLASSIFIED custom event carries corrected confidence for downstream consumers
affects: [04.3-agent-user-ux-with-unclear-item]

# Tech tracking
tech-stack:
  added: []
  patterns: [return-string-as-source-of-truth, fallback-to-raw-args]

key-files:
  created: []
  modified:
    - backend/src/second_brain/agents/workflow.py

key-decisions:
  - "Tool return string is the authoritative source for confidence -- not function_call.arguments (pre-fallback)"
  - "Fallback to detected_tool_args if return string is not parseable (safety net for unexpected formats)"

patterns-established:
  - "Return string parsing: _parse_classify_result extracts corrected values from classify_and_file return string"
  - "5-tuple _process_update: classify_result_str tracked alongside other state through event stream"

requirements-completed: [CLAS-04, APPX-04]

# Metrics
duration: 2min
completed: 2026-02-24
---

# Phase 04.3 Plan 09: Toast Confidence Fix Summary

**Parse classify_and_file return string for post-fallback confidence (0.75) instead of stale function_call.arguments (0.00)**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-24T18:22:29Z
- **Completed:** 2026-02-24T18:24:27Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Added _parse_classify_result helper to extract corrected bucket, confidence, and needs_review from classify_and_file return string
- Updated _process_update to capture full function_result string and return it as 5th tuple element
- clean_result text (capture toast) now uses parsed post-fallback confidence (e.g., 0.75 instead of 0.00)
- CLASSIFIED custom event now carries corrected confidence for downstream consumers
- Safe fallback to detected_tool_args if return string format is unexpected

## Task Commits

Each task was committed atomically:

1. **Task 1: Parse tool return string for corrected confidence in clean_result and CLASSIFIED event** - `fe21a7e` (fix)

**Plan metadata:** [pending] (docs: complete plan)

## Files Created/Modified
- `backend/src/second_brain/agents/workflow.py` - Added _parse_classify_result, _CLASSIFY_RESULT_RE regex, 5-tuple _process_update, parsed return string usage in clean_result and CLASSIFIED event

## Decisions Made
- Tool return string is the authoritative source for confidence -- not function_call.arguments (pre-fallback). The return string contains values AFTER the 0.0 -> 0.75 fallback and score derivation.
- Fallback to detected_tool_args if return string is not parseable (safety net for unexpected formats).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Toast confidence fix complete, ready for UAT retest (Tests 1 and 2 should now show corrected confidence)
- Plan 10 (junk/misunderstood overlap) is the remaining gap closure plan

## Self-Check: PASSED

- FOUND: backend/src/second_brain/agents/workflow.py
- FOUND: fe21a7e (task 1 commit)
- FOUND: 04.3-09-SUMMARY.md

---
*Phase: 04.3-agent-user-ux-with-unclear-item*
*Completed: 2026-02-24*
