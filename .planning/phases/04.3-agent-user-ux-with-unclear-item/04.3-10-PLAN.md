---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/agents/classifier.py
autonomous: true
requirements: [CLAS-04, APPX-04]
gap_closure: true

must_haves:
  truths:
    - "Single-word inputs that are recognizable words or could be names/terms trigger request_misunderstood (conversation mode), not mark_as_junk"
    - "mark_as_junk is only called for true gibberish: keyboard mashing, random characters, empty/whitespace input"
    - "Ambiguous single-word inputs like 'Xyzzy' enter conversation mode and ask for clarification"
  artifacts:
    - path: "backend/src/second_brain/agents/classifier.py"
      provides: "Narrowed junk definition and reordered decision flow"
      contains: "keyboard mashing"
  key_links:
    - from: "backend/src/second_brain/agents/classifier.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "Classifier correctly routes ambiguous words to request_misunderstood instead of mark_as_junk"
      pattern: "request_misunderstood"
---

<objective>
Fix unclear captures skipping conversation mode by narrowing the junk definition and reordering the classifier decision flow so misunderstood is checked before junk.

Purpose: UAT Test 5 fails because "Xyzzy" is classified as junk (mark_as_junk -> "Capture logged as unclassified") instead of entering conversation mode (request_misunderstood). The junk description ("gibberish, accidental, or nonsensical") overlaps with the misunderstood description ("single ambiguous word with no context"), and the decision flow checks junk FIRST, creating an ordering bias.
Output: Updated classifier.py with narrowed junk definition, explicit exclusions, and reordered decision flow.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-RETEST2-UAT.md
@.planning/debug/unclear-captures-skip-conversation.md
@backend/src/second_brain/agents/classifier.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Narrow junk definition, add exclusions, and reorder decision flow</name>
  <files>backend/src/second_brain/agents/classifier.py</files>
  <action>
Three targeted changes to the classifier instructions string in `create_classifier_agent`. All changes are to the `instructions` string parameter.

**Change 1: Narrow the Junk Detection section.**

Replace the current "## Junk Detection" section (lines 87-89 in the instructions string):
```
"## Junk Detection\n\n"
"If the input is gibberish, accidental, or nonsensical (random "
"characters, empty phrases, keyboard mashing), call mark_as_junk "
"instead of classify_and_file.\n\n"
```

With this narrowed definition:
```
"## Junk Detection\n\n"
"Call mark_as_junk ONLY for true gibberish:\n"
"- Keyboard mashing (e.g., 'asdfghjkl', 'qwerty123')\n"
"- Random characters with no recognizable words (e.g., 'xkcd2!@#')\n"
"- Empty or whitespace-only input\n"
"- Repeated single characters (e.g., 'aaaaaaa')\n\n"
"IMPORTANT: If the input contains ANY recognizable word, name, or "
"term -- even one you don't understand -- do NOT call mark_as_junk. "
"Use request_misunderstood instead. Examples:\n"
"- 'Xyzzy' -> request_misunderstood (could be a name, project, or reference)\n"
"- 'Quux' -> request_misunderstood (could be a name or term)\n"
"- 'Banana' -> classify_and_file (recognizable word with clear meaning)\n"
"- 'asdfjkl;' -> mark_as_junk (keyboard mashing)\n\n"
```

**Change 2: Reorder the Classification Decision Flow.**

Replace the current "## Classification Decision Flow" section (lines 91-100):
```
"## Classification Decision Flow\n\n"
"After analyzing the text, follow this decision tree:\n\n"
"1. **Junk/gibberish**: Call mark_as_junk\n"
"2. **High confidence (>= 0.6)**: Call classify_and_file with your "
"best bucket\n"
"3. **Low confidence (0.3-0.59)**: Call classify_and_file with your "
"best guess -- the system will automatically mark it as pending for "
"user review. Do NOT ask the user anything -- just file your best "
"guess\n"
"4. **Misunderstood (< 0.3 OR you genuinely cannot determine "
"intent)**: Call request_misunderstood with a friendly question\n\n"
```

With this reordered flow that checks misunderstood BEFORE junk:
```
"## Classification Decision Flow\n\n"
"After analyzing the text, follow this decision tree:\n\n"
"1. **High confidence (>= 0.6)**: Call classify_and_file with your "
"best bucket\n"
"2. **Low confidence (0.3-0.59)**: Call classify_and_file with your "
"best guess -- the system will automatically mark it as pending for "
"user review. Do NOT ask the user anything -- just file your best "
"guess\n"
"3. **Misunderstood (< 0.3 OR you genuinely cannot determine "
"intent)**: Call request_misunderstood with a friendly question. "
"When in doubt between junk and misunderstood, ALWAYS prefer "
"request_misunderstood\n"
"4. **True junk (keyboard mashing, random characters only)**: "
"Call mark_as_junk. See Junk Detection above for strict criteria\n\n"
```

**Change 3: Add "when in doubt" tiebreaker to the Misunderstood vs Low Confidence section.**

After the existing "Signals of 'misunderstood'" list (around line 110), add this paragraph before the examples:

```
"When in doubt between 'junk' and 'misunderstood', ALWAYS choose "
"request_misunderstood. It is better to ask the user what they meant "
"than to silently discard potentially meaningful input. The user can "
"always dismiss a clarification question, but they can't recover "
"a thought that was marked as junk.\n\n"
```

These three changes work together:
1. Narrowed junk definition removes the "nonsensical" word that overlapped with misunderstood
2. Reordered decision flow ensures the LLM considers classification and misunderstood before junk
3. Explicit tiebreaker ("when in doubt prefer misunderstood") eliminates the overlap zone
  </action>
  <verify>
Run backend tests:
```bash
cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -m pytest tests/ -v
```

Verify the key instruction changes are present:
```bash
grep -c "keyboard mashing" /Users/willmacdonald/Documents/Code/claude/second-brain/backend/src/second_brain/agents/classifier.py
```
Should return at least 1.

```bash
grep -c "ALWAYS prefer request_misunderstood" /Users/willmacdonald/Documents/Code/claude/second-brain/backend/src/second_brain/agents/classifier.py
```
Should return at least 1.

Verify decision flow order (misunderstood before junk):
```bash
cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -c "
from second_brain.agents import classifier
import inspect
src = inspect.getsource(classifier.create_classifier_agent)
misunderstood_pos = src.find('Misunderstood')
junk_pos = src.find('True junk')
assert misunderstood_pos < junk_pos, f'Misunderstood ({misunderstood_pos}) should come before True junk ({junk_pos})'
print('Decision flow order correct: misunderstood before junk')
"
```
  </verify>
  <done>
(1) Junk definition narrowed to ONLY keyboard mashing, random characters, empty input, repeated characters.
(2) Explicit exclusion: any recognizable word/name/term must NOT be marked as junk.
(3) Decision flow reordered: high confidence -> low confidence -> misunderstood -> junk (was: junk -> high -> low -> misunderstood).
(4) "When in doubt" tiebreaker added: ALWAYS prefer request_misunderstood over mark_as_junk.
(5) Examples added showing boundary cases (Xyzzy -> misunderstood, asdfjkl -> junk).
(6) All existing backend tests pass.
  </done>
</task>

</tasks>

<verification>
- `python3 -m pytest tests/ -v` in backend directory: all tests pass
- Junk Detection section now lists ONLY true gibberish criteria (no "nonsensical" overlap)
- Explicit exclusion: recognizable words/names/terms must use request_misunderstood
- Decision flow: misunderstood (step 3) comes before junk (step 4)
- "When in doubt" tiebreaker: prefer request_misunderstood over mark_as_junk
</verification>

<success_criteria>
- Ambiguous single-word inputs like "Xyzzy" enter conversation mode (request_misunderstood) instead of being silently marked as junk
- True keyboard mashing (e.g., "asdfghjkl") still correctly triggers mark_as_junk
- The overlap zone between junk and misunderstood is eliminated by narrowed definitions and explicit tiebreaker
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-10-SUMMARY.md`
</output>
