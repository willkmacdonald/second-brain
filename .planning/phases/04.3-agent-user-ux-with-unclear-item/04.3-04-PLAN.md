---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 04
type: execute
wave: 2
depends_on:
  - "04.3-02"
files_modified:
  - mobile/app/(tabs)/inbox.tsx
  - mobile/components/InboxItem.tsx
autonomous: true
requirements:
  - CLAS-04
  - APPX-04

must_haves:
  truths:
    - "Inbox list shows orange dot for pending/low_confidence, red dot for unresolved, no dot for classified"
    - "Tapping a classified item opens detail card with 4 bucket buttons"
    - "Current bucket is visually highlighted in the bucket buttons"
    - "Tapping a different bucket calls the recategorize endpoint and shows 'Moved to [Bucket]' toast"
    - "Tapping a pending item opens detail card with 4 bucket buttons (instead of conversation screen)"
    - "Pending item resolution via bucket buttons calls the existing respond endpoint"
    - "After recategorize, inbox list updates optimistically (bucket label changes)"
  artifacts:
    - path: "mobile/components/InboxItem.tsx"
      provides: "Color-coded status dots (orange for pending, red for unresolved, green/none for classified)"
      contains: "unresolved"
    - path: "mobile/app/(tabs)/inbox.tsx"
      provides: "Inbox detail card with 4 bucket buttons for both classified and pending items"
      contains: "handleRecategorize"
  key_links:
    - from: "mobile/app/(tabs)/inbox.tsx"
      to: "backend/src/second_brain/api/inbox.py"
      via: "PATCH fetch call for recategorize"
      pattern: "recategorize"
    - from: "mobile/app/(tabs)/inbox.tsx"
      to: "backend/src/second_brain/main.py"
      via: "sendClarification for pending item resolution"
      pattern: "sendClarification"
---

<objective>
Update the mobile inbox to support all three classification outcome flows: color-coded status dots, detail card with bucket buttons for recategorize (classified items) and manual resolution (pending items), and optimistic UI updates.

Purpose: Users need to fix mis-categorized items (Flow 3) and resolve pending items (Flow 2) from the inbox. The detail card is the unified interface for both, with bucket buttons at the bottom.

Output: Updated InboxItem with status dots, updated inbox screen with bucket buttons in detail card.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-RESEARCH.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-02-SUMMARY.md
@mobile/app/(tabs)/inbox.tsx
@mobile/components/InboxItem.tsx
@mobile/lib/ag-ui-client.ts
@mobile/constants/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update InboxItem with color-coded status dots</name>
  <files>mobile/components/InboxItem.tsx</files>
  <action>
    Update the InboxItem component to display different colored status dots based on item status.

    1. **Add helper function** for status dot color:
       ```typescript
       function getStatusDotColor(status: string): string | null {
         switch (status) {
           case "pending":
           case "low_confidence":
           case "misunderstood":
             return "#f97316"; // Orange -- needs user attention
           case "unresolved":
             return "#ef4444"; // Red -- agent gave up
           default:
             return null; // No dot for classified/other
         }
       }
       ```

    2. **Replace the existing `isPending` logic** for the dot. Currently:
       ```typescript
       const isPending = item.status === "pending" || item.status === "low_confidence";
       ```
       Replace with:
       ```typescript
       const dotColor = getStatusDotColor(item.status);
       const isPending = item.status === "pending" || item.status === "low_confidence" || item.status === "misunderstood";
       const isUnresolved = item.status === "unresolved";
       ```

    3. **Update the dot rendering**. Replace:
       ```jsx
       {isPending && <View style={styles.orangeDot} />}
       ```
       With:
       ```jsx
       {dotColor && (
         <View style={[styles.statusDot, { backgroundColor: dotColor }]} />
       )}
       ```

    4. **Update the bucket label** to handle unresolved:
       ```typescript
       const bucketLabel = isPending
         ? "Pending"
         : isUnresolved
           ? "Unresolved"
           : item.classificationMeta?.bucket ?? "Unknown";
       ```

    5. **Update styles**: Rename `orangeDot` to `statusDot` (same dimensions -- 8x8 circle with 4 borderRadius):
       ```typescript
       statusDot: {
         width: 8,
         height: 8,
         borderRadius: 4,
         marginRight: 10,
       },
       ```
       Remove the old `orangeDot` style (or keep it as an alias if needed). Add `bucketUnresolved` style for the red text color:
       ```typescript
       bucketUnresolved: {
         color: "#ef4444",
       },
       ```

    6. **Apply the unresolved style** to the bucket label text:
       ```jsx
       <Text style={[styles.bucket, isPending && styles.bucketPending, isUnresolved && styles.bucketUnresolved]}>
         {bucketLabel}
       </Text>
       ```
  </action>
  <verify>
    Verify no TypeScript errors by inspecting the file. Check that all statuses map to correct colors.
  </verify>
  <done>
    InboxItem shows orange dot for pending/low_confidence/misunderstood, red dot for unresolved, no dot for classified items. Bucket label text is color-coded to match.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bucket buttons to inbox detail card for recategorize and pending resolution</name>
  <files>mobile/app/(tabs)/inbox.tsx</files>
  <action>
    Update the inbox screen to show 4 bucket buttons in the detail card for both classified items (recategorize) and pending items (manual resolution). Also change pending items to open the detail card instead of navigating to the conversation screen.

    1. **Add imports**: Import `sendClarification` from `../../lib/ag-ui-client` (for pending resolution via existing respond endpoint). Add `import { API_BASE_URL } from "../../constants/config"` if not already imported (it is already imported).

    2. **Add state for recategorize/resolution**:
       ```typescript
       const [isRecategorizing, setIsRecategorizing] = useState(false);
       const [recategorizeToast, setRecategorizeToast] = useState<string | null>(null);
       ```

    3. **Add BUCKETS constant**: `const BUCKETS = ["People", "Projects", "Ideas", "Admin"];`

    4. **Change `handleItemPress`** so ALL items open the detail card (not just classified). Remove the router.push to conversation screen for pending items:
       ```typescript
       const handleItemPress = useCallback(
         (item: InboxItemData) => {
           setSelectedItem(item);
         },
         [],
       );
       ```

    5. **Add `handleRecategorize` function** for classified items:
       ```typescript
       const handleRecategorize = useCallback(
         async (itemId: string, newBucket: string) => {
           if (isRecategorizing) return;
           setIsRecategorizing(true);

           try {
             const res = await fetch(
               `${API_BASE_URL}/api/inbox/${itemId}/recategorize`,
               {
                 method: "PATCH",
                 headers: {
                   Authorization: `Bearer ${API_KEY}`,
                   "Content-Type": "application/json",
                 },
                 body: JSON.stringify({ new_bucket: newBucket }),
               },
             );

             if (res.ok) {
               // Optimistic UI: update item in list
               setItems((prev) =>
                 prev.map((i) =>
                   i.id === itemId
                     ? {
                         ...i,
                         status: "classified",
                         classificationMeta: i.classificationMeta
                           ? { ...i.classificationMeta, bucket: newBucket, classifiedBy: "User" }
                           : null,
                       }
                     : i,
                 ),
               );
               setSelectedItem(null);
               setRecategorizeToast(`Moved to ${newBucket}`);
             }
           } catch {
             // Silently fail -- detail card stays open
           } finally {
             setIsRecategorizing(false);
           }
         },
         [isRecategorizing],
       );
       ```

    6. **Add `handlePendingResolve` function** for pending items. This calls the existing respond endpoint via `sendClarification`:
       ```typescript
       const handlePendingResolve = useCallback(
         (itemId: string, bucket: string) => {
           if (isRecategorizing) return;
           setIsRecategorizing(true);

           const threadId = `resolve-${itemId}`;
           const cleanup = sendClarification({
             threadId,
             bucket,
             apiKey: API_KEY!,
             inboxItemId: itemId,
             callbacks: {
               onComplete: (result: string) => {
                 void result;
                 setIsRecategorizing(false);
                 // Update item in list optimistically
                 setItems((prev) =>
                   prev.map((i) =>
                     i.id === itemId
                       ? {
                           ...i,
                           status: "classified",
                           classificationMeta: i.classificationMeta
                             ? { ...i.classificationMeta, bucket, classifiedBy: "User" }
                             : { bucket, confidence: 0.85, agentChain: ["User"] },
                         }
                       : i,
                   ),
                 );
                 setSelectedItem(null);
                 setRecategorizeToast(`Filed to ${bucket}`);
               },
               onError: () => {
                 setIsRecategorizing(false);
               },
             },
           });
           // Store cleanup for potential unmount
           void cleanup;
         },
         [isRecategorizing],
       );
       ```

    7. **Add toast auto-dismiss** for recategorize toast:
       ```typescript
       useEffect(() => {
         if (!recategorizeToast) return;
         const timer = setTimeout(() => setRecategorizeToast(null), 2000);
         return () => clearTimeout(timer);
       }, [recategorizeToast]);
       ```

    8. **Update the detail card Modal JSX** to add bucket buttons at the bottom. After the existing Close button area, add the bucket buttons section:

       Determine which handler to use based on item status:
       ```typescript
       const isPendingItem = selectedItem?.status === "pending" || selectedItem?.status === "low_confidence";
       const isClassifiedItem = selectedItem?.status === "classified";
       const showBucketButtons = isPendingItem || isClassifiedItem;
       ```

       Then in the Modal, before the Close button, add:
       ```jsx
       {showBucketButtons && (
         <View style={styles.bucketSection}>
           <Text style={styles.detailLabel}>
             {isPendingItem ? "File to bucket" : "Move to bucket"}
           </Text>
           <View style={styles.bucketRow}>
             {BUCKETS.map((bucket) => {
               const isCurrent = !isPendingItem && selectedItem?.classificationMeta?.bucket === bucket;
               return (
                 <Pressable
                   key={bucket}
                   onPress={() =>
                     isPendingItem
                       ? handlePendingResolve(selectedItem!.id, bucket)
                       : handleRecategorize(selectedItem!.id, bucket)
                   }
                   disabled={isCurrent || isRecategorizing}
                   style={({ pressed }) => [
                     styles.bucketButton,
                     isCurrent && styles.bucketButtonCurrent,
                     pressed && !isCurrent && styles.bucketButtonPressed,
                     isRecategorizing && styles.bucketButtonDisabled,
                   ]}
                 >
                   <Text
                     style={[
                       styles.bucketButtonText,
                       isCurrent && styles.bucketButtonTextCurrent,
                     ]}
                   >
                     {bucket}
                   </Text>
                 </Pressable>
               );
             })}
           </View>
         </View>
       )}
       ```

    9. **Add the recategorize toast** to the screen (outside the modal, at the bottom of the SafeAreaView):
       ```jsx
       {recategorizeToast && (
         <View style={styles.toastBar}>
           <Text style={styles.toastText}>{recategorizeToast}</Text>
         </View>
       )}
       ```

    10. **Update badge count** to also count unresolved items:
        ```typescript
        const isPendingStatus = (s: string) =>
          s === "pending" || s === "low_confidence" || s === "unresolved";
        ```

    11. **Add styles** for new elements:
        ```typescript
        bucketSection: {
          marginTop: 16,
        },
        bucketRow: {
          flexDirection: "row",
          gap: 8,
          marginTop: 4,
        },
        bucketButton: {
          flex: 1,
          backgroundColor: "#2a2a4e",
          paddingVertical: 10,
          borderRadius: 8,
          alignItems: "center",
        },
        bucketButtonCurrent: {
          backgroundColor: "#4a90d9",
        },
        bucketButtonPressed: {
          opacity: 0.7,
        },
        bucketButtonDisabled: {
          opacity: 0.4,
        },
        bucketButtonText: {
          fontSize: 13,
          fontWeight: "600",
          color: "#ccc",
        },
        bucketButtonTextCurrent: {
          color: "#ffffff",
        },
        toastBar: {
          position: "absolute",
          bottom: 40,
          left: 20,
          right: 20,
          backgroundColor: "#1a1a2e",
          borderRadius: 10,
          padding: 12,
          alignItems: "center",
          borderWidth: 1,
          borderColor: "#4a90d9",
        },
        toastText: {
          color: "#4ade80",
          fontSize: 14,
          fontWeight: "500",
        },
        ```
  </action>
  <verify>
    Verify no TypeScript errors by inspecting the file.
    Check that the detail card renders bucket buttons for classified items with current bucket highlighted.
    Check that pending items open the detail card (not conversation screen).
    Check that recategorize calls the PATCH endpoint.
  </verify>
  <done>
    Inbox detail card shows 4 bucket buttons for both classified (recategorize) and pending (resolve) items. Current bucket is highlighted. Tapping a different bucket calls the appropriate endpoint and optimistically updates the list. Toast confirms the action. Unresolved items show in badge count.
  </done>
</task>

</tasks>

<verification>
1. InboxItem shows correct status dot colors (orange for pending, red for unresolved, none for classified)
2. Tapping any item opens detail card (no more conversation screen redirect for pending)
3. Detail card shows bucket buttons for classified and pending items
4. Recategorize calls PATCH endpoint, updates UI optimistically, shows toast
5. Pending resolution calls respond endpoint, updates UI optimistically
6. Badge count includes unresolved items
</verification>

<success_criteria>
Inbox provides a unified detail card with bucket buttons for resolving pending items and recategorizing mis-classified items. Status dots provide at-a-glance visual feedback. All flows work end-to-end with optimistic UI updates.
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-04-SUMMARY.md`
</output>
