---
status: diagnosed
phase: 04.3-agent-user-ux-with-unclear-item
source: [04.3-07-SUMMARY.md, 04.3-08-SUMMARY.md]
started: 2026-02-24T14:30:00Z
updated: 2026-02-24T15:00:00Z
---

## Current Test

[testing complete]

## Tests

### 1. High-Confidence Capture — Non-Zero Confidence Score
expected: Type a clear, unambiguous thought (e.g., "Buy groceries tomorrow") and tap Send. The classification result should show a non-zero confidence score (e.g., "Filed -> Admin (0.85)") — NOT "Filed -> Admin (0.00)".
result: issue
reported: "Showed me 0.00, but did file it under Admin"
severity: major

### 2. Low-Confidence Capture — Differentiated Scores
expected: Type an ambiguous thought that could fit multiple buckets (e.g., "Had coffee with Mike, he mentioned a new project idea"). The result should show "Filed (needs review)" with a non-zero confidence — NOT 0.00. The item should file silently (no HITL interruption) with a meaningful bucket assignment.
result: issue
reported: "Same thing, 0.00 confidence in capture screen toast, filed under People. But inbox detail card shows 85% confidence correctly. Fallback works in DB but streamed text shows old 0.00 value."
severity: major

### 3. Misunderstood Capture — Conversation Mode (No Duplicates)
expected: Type something very unclear (e.g., "Aardvark" or random text). The capture screen shows a conversational question from the agent. Check the Inbox tab — there should be exactly ONE "Needs Clarification" entry for this capture, not two.
result: pass

### 4. Follow-Up Reply — Updates Original (No Duplicates)
expected: After receiving the agent's question (from Test 3), type a clarifying reply (e.g., "It's the name of my friend's new startup project") and tap Reply. The system re-classifies. Check the Inbox — the ORIGINAL item should now show as classified (e.g., "Projects"), and there should be NO extra duplicate entries.
result: pass

### 5. Follow-Up Reply — Still Misunderstood (Round 2 Unresolved)
expected: Send another unclear capture (e.g., "Xyzzy"). When the agent asks for clarification, reply with something equally unclear (e.g., "It's a thing"). The system should give up after round 2 and mark the ORIGINAL item as "Unresolved" in the inbox. No duplicate entries should appear.
result: issue
reported: "Capture logged as unclassified. It did not ask for clarification — went straight to unclassified without entering conversation mode."
severity: major

### 6. Inbox Display — Confidence Values Visible
expected: Open the Inbox tab and tap on a recently classified item. The detail card should show a meaningful confidence value (not 0.00) and the correct bucket assignment.
result: pass

## Summary

total: 6
passed: 3
issues: 3
pending: 0
skipped: 0

## Gaps

- truth: "Capture screen toast shows corrected confidence score (not 0.00 from raw LLM args)"
  status: failed
  reason: "User reported: Showed me 0.00 in toast, but inbox detail card shows correct 85%. Fallback works in DB but streamed text uses stale pre-fallback values."
  severity: major
  test: 1,2
  root_cause: "The workflow adapter (workflow.py) constructs clean_result and CLASSIFIED event from detected_tool_args — the LLM's raw function_call.arguments captured BEFORE tool execution. The score fallback in classify_and_file corrects confidence from 0.0 to 0.75 and writes to Cosmos DB, but the adapter never sees these corrected values. Specifically: workflow.py line 384 reads detected_tool_args.get('confidence', 0.0) for clean_result, and line 433 reads the same stale value for the CLASSIFIED event."
  artifacts:
    - path: "backend/src/second_brain/agents/workflow.py"
      issue: "Lines 382-388 and 425-435: clean_result and CLASSIFIED event use stale detected_tool_args instead of corrected tool return values"
    - path: "backend/src/second_brain/tools/classification.py"
      issue: "Lines 96-129 and 190-191: fallback corrects values locally but they stay in tool scope, never propagated to adapter"
  missing:
    - "Parse the tool's return string in the adapter to extract corrected confidence and bucket (return string already contains corrected values like 'Filed -> People (0.75) | {uuid}')"
    - "Use parsed return string values instead of detected_tool_args for clean_result text and CLASSIFIED event"
  debug_session: ".planning/debug/capture-toast-zero-confidence.md"

- truth: "Unclear capture enters conversation mode and asks for clarification before giving up"
  status: failed
  reason: "User reported: Capture logged as unclassified. Did not ask for clarification — went straight to unclassified without entering conversation mode."
  severity: major
  test: 5
  root_cause: "Classifier instructions have overlapping junk vs misunderstood definitions. mark_as_junk description ('nonsensical') overlaps with request_misunderstood signals ('single ambiguous word with no context'). Decision flow checks junk FIRST (step 1) before misunderstood (step 4), creating ordering bias. 'Xyzzy' looks like random characters to the LLM and falls into the overlap zone. mark_as_junk returns 'Capture logged as unclassified'."
  artifacts:
    - path: "backend/src/second_brain/agents/classifier.py"
      issue: "Lines 87-110: junk definition ('nonsensical') overlaps misunderstood signals ('single ambiguous word'); decision flow ordering biases toward junk"
    - path: "backend/src/second_brain/tools/classification.py"
      issue: "Line 259: mark_as_junk returns 'Capture logged as unclassified' — tool works correctly but gets invoked for the wrong inputs"
  missing:
    - "Narrow junk definition to ONLY true keyboard mashing / random characters / empty input"
    - "Add explicit exclusion: if input is a recognizable word or could be a name/term, do NOT call mark_as_junk — use request_misunderstood instead"
    - "Reorder decision flow: check misunderstood BEFORE junk, or add 'when in doubt prefer misunderstood'"
  debug_session: ".planning/debug/unclear-captures-skip-conversation.md"
