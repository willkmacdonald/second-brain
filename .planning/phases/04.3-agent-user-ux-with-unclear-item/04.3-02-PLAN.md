---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/api/inbox.py
  - backend/tests/test_inbox_api.py
autonomous: true
requirements:
  - CLAS-04
  - APPX-04

must_haves:
  truths:
    - "A classified inbox item can be moved to a different bucket via PATCH request"
    - "Recategorize creates new bucket doc, updates inbox doc, deletes old bucket doc (in that order)"
    - "Recategorize to the same bucket is a no-op"
    - "Invalid bucket names return 400 error"
    - "Non-existent inbox items return 404 error"
    - "Failed old-bucket-doc deletion is non-fatal (logged warning, operation succeeds)"
  artifacts:
    - path: "backend/src/second_brain/api/inbox.py"
      provides: "PATCH /api/inbox/{item_id}/recategorize endpoint"
      contains: "recategorize_inbox_item"
    - path: "backend/tests/test_inbox_api.py"
      provides: "Tests for recategorize endpoint"
      contains: "test_recategorize"
  key_links:
    - from: "backend/src/second_brain/api/inbox.py"
      to: "Cosmos DB containers"
      via: "create-update-delete sequence across containers"
      pattern: "create_item.*upsert_item.*delete_item"
---

<objective>
Add a PATCH endpoint to recategorize already-classified inbox items by moving them to a different bucket container in Cosmos DB.

Purpose: When the classifier was confidently wrong (Flow 3), users need to fix mis-categorized items from the inbox detail card. This endpoint handles the cross-container move: create new bucket doc, update inbox metadata, delete old bucket doc.

Output: New recategorize endpoint in inbox.py with tests.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-RESEARCH.md
@backend/src/second_brain/api/inbox.py
@backend/src/second_brain/models/documents.py
@backend/src/second_brain/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement recategorize endpoint</name>
  <files>backend/src/second_brain/api/inbox.py</files>
  <action>
    Add a new `PATCH /api/inbox/{item_id}/recategorize` endpoint to `inbox.py`.

    1. **Add imports**: `from datetime import UTC, datetime`, `from uuid import uuid4`. Also import `CONTAINER_MODELS` and `ClassificationMeta` from `second_brain.models.documents`.

    2. **Add VALID_BUCKETS constant** at module level: `VALID_BUCKETS = {"People", "Projects", "Ideas", "Admin"}` (same as in classification.py).

    3. **Add request model**:
       ```python
       class RecategorizeRequest(BaseModel):
           """Request body for recategorizing an inbox item to a different bucket."""
           new_bucket: str  # "People", "Projects", "Ideas", or "Admin"
       ```

    4. **Add the endpoint**:
       ```python
       @router.patch("/api/inbox/{item_id}/recategorize")
       async def recategorize_inbox_item(
           request: Request, item_id: str, body: RecategorizeRequest
       ) -> dict:
       ```

       Logic:
       a. Get cosmos_manager from request.app.state (503 if None).
       b. Validate `body.new_bucket` is in VALID_BUCKETS (400 if not).
       c. Read the inbox item by ID (404 if not found using CosmosResourceNotFoundError).
       d. Extract `old_bucket` from `item.get("classificationMeta", {}).get("bucket")` and `old_filed_id` from `item.get("filedRecordId")`.
       e. If `old_bucket == body.new_bucket`, return `dict(item)` immediately (no-op).
       f. **Step 1: Create new bucket document** using CONTAINER_MODELS[new_bucket]:
          - Generate `new_bucket_doc_id = str(uuid4())`
          - Build kwargs: `id`, `rawText` from item, `classificationMeta` (updated with new bucket, classifiedBy="User", agentChain appended with "User"), `inboxRecordId` = item_id
          - For People: set `name` from item title or "Unnamed"
          - For Projects/Ideas/Admin: set `title` from item title or "Untitled"
          - Create the document in the new bucket container
       g. **Step 2: Update inbox document**:
          - Update `item["classificationMeta"]["bucket"]` = new_bucket
          - Update `item["classificationMeta"]["classifiedBy"]` = "User"
          - Append "User" to `item["classificationMeta"]["agentChain"]` if not already there
          - Update `item["filedRecordId"]` = new_bucket_doc_id
          - Update `item["status"]` = "classified"
          - Update `item["updatedAt"]` = `datetime.now(UTC).isoformat()`
          - Upsert the item
       h. **Step 3: Delete old bucket document** (non-fatal):
          - If `old_filed_id` and `old_bucket`, try to delete from old bucket container
          - Catch all exceptions, log warning: "Could not delete old bucket doc %s/%s during recategorize"
          - This is non-fatal per CONTEXT.md research (orphaned doc is harmless)
       i. Log: `logger.info("Recategorized inbox %s: %s -> %s", item_id, old_bucket, body.new_bucket)`
       j. Return `dict(item)` (the updated inbox document).

    Note on ClassificationMeta construction for the new bucket doc: Build a fresh ClassificationMeta from the existing item's metadata, but override `bucket`, `classifiedBy`, `agentChain`, and `classifiedAt`. Keep the original `confidence` and `allScores` to preserve the original classification context.
  </action>
  <verify>
    Verify the endpoint is registered by checking `router.routes` or by inspection.
    Verify the file compiles: `cd /Users/willmacdonald/Documents/Code/claude/second-brain && python3 -c "from second_brain.api.inbox import router"` succeeds.
  </verify>
  <done>
    PATCH /api/inbox/{item_id}/recategorize endpoint exists in inbox.py. It validates bucket, creates new bucket doc, updates inbox doc, and deletes old bucket doc (non-fatal). Returns updated inbox document.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add recategorize endpoint tests</name>
  <files>backend/tests/test_inbox_api.py</files>
  <action>
    Create a new test file `backend/tests/test_inbox_api.py` (or add to existing if it exists) with tests for the recategorize endpoint.

    Use the project's established test patterns: `mock_cosmos_manager` fixture from conftest.py, `AsyncMock` for container operations, httpx `AsyncClient` with ASGI transport for endpoint testing.

    Check conftest.py first to understand available fixtures. If there's an `app_with_mocks` fixture or similar, use it. Otherwise, create a minimal test app that includes the inbox router and mocks cosmos_manager on app.state.

    Tests to write:

    1. **test_recategorize_success**: Mock read_item to return a classified inbox item (status="classified", classificationMeta with bucket="Ideas", filedRecordId="old-id"). Call PATCH with new_bucket="Projects". Verify:
       - New bucket container's `create_item` called once with correct bucket doc
       - Inbox container's `upsert_item` called with updated bucket, classifiedBy="User"
       - Old bucket container's `delete_item` called with old-id
       - Response is 200 with updated item

    2. **test_recategorize_same_bucket_noop**: Mock read_item to return item with bucket="People". Call PATCH with new_bucket="People". Verify no create_item, no upsert_item, no delete_item called. Response is 200.

    3. **test_recategorize_invalid_bucket**: Call PATCH with new_bucket="Unknown". Verify 400 response.

    4. **test_recategorize_not_found**: Mock read_item to raise `CosmosResourceNotFoundError`. Verify 404 response.

    5. **test_recategorize_old_delete_fails_nonfatal**: Mock read_item to return a classified item. Mock delete_item on old bucket container to raise an exception. Verify recategorize still succeeds (200), new bucket doc created, inbox updated.
  </action>
  <verify>
    Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain && python3 -m pytest backend/tests/test_inbox_api.py -v` -- all tests pass.
  </verify>
  <done>
    Recategorize endpoint has 5 tests covering: success, same-bucket no-op, invalid bucket, not found, and non-fatal delete failure. All pass.
  </done>
</task>

</tasks>

<verification>
1. `python3 -m pytest backend/tests/test_inbox_api.py -v` -- all 5 recategorize tests pass
2. `python3 -m pytest backend/tests/ -v` -- all backend tests pass (no regressions)
3. PATCH /api/inbox/{item_id}/recategorize endpoint handles: success, no-op, invalid bucket (400), not found (404), non-fatal delete failure
</verification>

<success_criteria>
Recategorize endpoint moves classified items between bucket containers with create-first ordering for data safety. All tests pass with no regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-02-SUMMARY.md`
</output>
