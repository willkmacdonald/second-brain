---
phase: 04.3-agent-user-ux-with-unclear-item
verified: 2026-02-24T19:00:00Z
status: passed
score: 39/39 must-haves verified
re_verification:
  previous_status: passed
  previous_score: 33/33
  context: >
    Previous verification (2026-02-24) covered Plans 01-08 (33/33). Plans 09 and 10 were
    subsequently executed (commits fe21a7e, e50f089) to fix two RETEST2-UAT gaps:
    (1) toast showing stale 0.00 confidence from pre-fallback function_call.arguments,
    (2) ambiguous single-word inputs routing to mark_as_junk instead of request_misunderstood.
    This re-verification adds 6 new must-haves from Plans 09-10 as full verifications
    and confirms the original 33 as regression checks. All 43 backend tests pass.
  gaps_closed:
    - "Capture screen toast shows corrected confidence score (0.75 not stale 0.00 from raw LLM args)"
    - "CLASSIFIED custom event carries corrected post-fallback confidence from tool return string"
    - "When tool return string says 'Filed -> People (0.75)', toast shows 0.75 not pre-fallback 0.00"
    - "Single-word inputs that are recognizable words or could be names/terms trigger request_misunderstood, not mark_as_junk"
    - "mark_as_junk is only called for true gibberish: keyboard mashing, random characters, empty/whitespace input"
    - "Ambiguous single-word inputs like 'Xyzzy' enter conversation mode and ask for clarification"
  gaps_remaining: []
  regressions: []
gaps: []
human_verification:
  - test: "High-confidence capture — corrected confidence in toast"
    expected: "Type 'Buy groceries tomorrow' and tap Send. Step dots animate. Toast shows 'Filed -> Admin (0.90)' with a non-zero confidence — NOT '0.00'. Screen auto-resets after ~2.5s."
    why_human: "Requires live Azure OpenAI. Verifies _parse_classify_result extracts post-fallback confidence from the tool return string (not stale detected_tool_args). Toast bug is fixed in Plan 09 but can only be confirmed end-to-end with a live run."
  - test: "Low-confidence capture — non-zero confidence scores in toast and Cosmos DB"
    expected: "Type 'Had coffee with Mike, he mentioned a project idea' and tap Send. Result: clean 'Filed (needs review) -> People (0.55)' toast with non-zero confidence. Inbox detail card also shows non-zero confidence (previously 0.00 in RETEST2 test 2 before Plan 07 fixed Cosmos DB and Plan 09 fixed the toast)."
    why_human: "Requires live classifier. Verifies both Plan 07 (score fallback in Cosmos) and Plan 09 (parsed return string in toast) working together end-to-end."
  - test: "Ambiguous single-word — enters conversation mode (not marked as junk)"
    expected: "Type 'Xyzzy' and tap Send. Agent question bubble appears (conversation mode). No 'Capture logged as unclassified' toast. Inbox shows 1 item with 'Needs Clarification' status."
    why_human: "Requires live Azure OpenAI. Verifies Plan 10 classifier instruction changes route ambiguous words to request_misunderstood instead of mark_as_junk. Cannot unit-test LLM routing decisions."
  - test: "Misunderstood follow-up — no duplicate items"
    expected: "Type 'Aardvark'. Agent question appears. Check Inbox: exactly 1 item. Reply 'It is my friend's startup name'. If re-classified: 'Filed -> Projects (0.80)' toast with correct confidence. Inbox: original item now classified, no duplicate."
    why_human: "Requires live Azure OpenAI. Verifies Plan 08 orphan reconciliation + Plan 09 corrected confidence in CLASSIFIED event propagated to main.py post-stream reconciliation."
  - test: "Misunderstood item in inbox"
    expected: "After misunderstood capture: inbox item shows orange dot and 'Needs Clarification' label. Tap it: detail card shows agent's question text (not 'Unknown'). Bucket buttons present."
    why_human: "Requires live backend with a misunderstood item in Cosmos DB."
  - test: "Inbox detail card for classified item — recategorize"
    expected: "Tap a classified item (no dot). Detail card opens with correct Bucket/Confidence. 4 bucket buttons visible. Tap a different bucket: 'Moved to [Bucket]' toast, card closes, item updates."
    why_human: "Requires live backend with classified Cosmos DB items."
---

# Phase 04.3: agent-user UX with unclear item — Verification Report

**Phase Goal:** Three distinct classification failure flows: misunderstood (conversational follow-up), low-confidence (silent pending filing), and mis-categorized (inbox recategorize)
**Verified:** 2026-02-24T19:00:00Z
**Status:** PASSED
**Re-verification:** Yes — after Plans 09 and 10 gap closure (RETEST2-UAT findings)

---

## Re-Verification Context

The previous VERIFICATION.md (2026-02-24, Plans 01-08, 33/33) was followed by RETEST2-UAT
(04.3-RETEST2-UAT.md, 2026-02-24) which found 3 issues in 6 tests:

- **Tests 1 and 2** (major): Toast shows 0.00 confidence even though Cosmos DB stores correct
  values. Root cause: workflow adapter builds clean_result from `detected_tool_args` (LLM's
  raw function_call.arguments, captured BEFORE tool execution). The 0.0 -> 0.75 fallback in
  `classify_and_file` writes corrected values to Cosmos DB but never propagates them back to
  the adapter. The adapter's stale pre-fallback args still say 0.00.

- **Test 5** (major): Sending "Xyzzy" shows "Capture logged as unclassified" (mark_as_junk)
  instead of entering conversation mode (request_misunderstood). Root cause: junk definition
  included "nonsensical" which overlapped with misunderstood signals, and the decision flow
  checked junk FIRST (step 1), biasing the LLM to call mark_as_junk for ambiguous words.

Plans 09 and 10 were created and executed:

- **Plan 09** (commit `fe21a7e`): Added `_parse_classify_result` helper and `_CLASSIFY_RESULT_RE`
  regex to parse the tool's return string (post-fallback authoritative values). Updated
  `_process_update` to capture `classify_result_str` as 5th return element. Updated
  clean_result construction and CLASSIFIED event emission to use parsed return string values
  instead of stale `detected_tool_args`.

- **Plan 10** (commit `e50f089`): Narrowed junk definition to ONLY keyboard mashing, random
  characters, empty input, and repeated characters. Added explicit exclusion: any recognizable
  word/name/term must route to request_misunderstood. Reordered decision flow from junk-first
  (old: 1.junk, 2.high, 3.low, 4.misunderstood) to classify-first (new: 1.high, 2.low,
  3.misunderstood, 4.junk). Added "when in doubt prefer request_misunderstood" tiebreaker
  in two locations.

This re-verification treats the 6 Plan 09/10 must-haves as new full verifications and the
original 33 must-haves as regression checks.

---

## Goal Achievement

### Observable Truths

#### Original 33 Truths (Regression Check)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | Classifier agent distinguishes misunderstood / low-confidence / high-confidence | VERIFIED | `classifier.py`: three-tier thresholds in instructions (< 0.3 misunderstood, 0.3-0.59 low-confidence, >= 0.6 high-confidence) |
| 2  | Misunderstood input creates inbox doc with status 'misunderstood' and clarificationText | VERIFIED | `classification.py`: `request_misunderstood` creates `InboxDocument(status="misunderstood", clarificationText=question_text)` |
| 3  | Low-confidence (0.3-0.59) files as pending with "Filed (needs review)" return string | VERIFIED | `classification.py`: `status = "pending"` when `confidence < self._threshold`; return string includes "(needs review)" |
| 4  | MISUNDERSTOOD custom event emitted (distinct from HITL_REQUIRED) | VERIFIED | `workflow.py`: `CustomEvent(name="MISUNDERSTOOD", ...)` emitted when `detected_tool == "request_misunderstood"` |
| 5  | request_clarification removed; request_misunderstood is the misunderstood tool | VERIFIED | No `request_clarification` in `classification.py`; tools list has `request_misunderstood` only |
| 6  | Classified inbox item can be moved via PATCH request | VERIFIED | `inbox.py`: `@router.patch("/api/inbox/{item_id}/recategorize")` present |
| 7  | Recategorize creates new bucket doc, updates inbox, deletes old bucket (in order) | VERIFIED | `inbox.py`: Step 1 create, Step 2 upsert, Step 3 delete (non-fatal) |
| 8  | Recategorize to same bucket is a no-op | VERIFIED | `inbox.py`: early return when `old_bucket == body.new_bucket`; test passes |
| 9  | Invalid bucket names return 400 | VERIFIED | `inbox.py`: `HTTPException(status_code=400)` on invalid bucket; test passes |
| 10 | Non-existent inbox items return 404 | VERIFIED | `inbox.py`: `HTTPException(status_code=404)` on CosmosResourceNotFoundError; test passes |
| 11 | Misunderstood captures trigger conversational follow-up on capture screen | VERIFIED | `text.tsx`: `onMisunderstood` sets `agentQuestion`, `misunderstoodInboxItemId`, `followUpRound=1` |
| 12 | Agent question bubble visible above text input | VERIFIED | `text.tsx`: `{agentQuestion && <View style={styles.agentQuestionBubble}>...}` |
| 13 | User types reply in cleared input | VERIFIED | `text.tsx`: `setThought("")` on MISUNDERSTOOD; placeholder changes when `followUpRound > 0` |
| 14 | Re-classification runs on original text + clarification combined | VERIFIED | `main.py`: `combined_text = f"{original_text}\n\n---\nUser clarification: {body.follow_up_text}"` |
| 15 | Max 2 follow-up rounds; unresolved after 2 goes to inbox with status 'unresolved' | VERIFIED | `main.py`: `body.follow_up_round >= 2` intercepts MISUNDERSTOOD, marks original "unresolved", emits UNRESOLVED event |
| 16 | Follow-up endpoint streams SSE events | VERIFIED | `main.py`: `StreamingResponse(generate(), media_type="text/event-stream")` |
| 17 | Inbox list shows orange dot for pending/low_confidence/misunderstood, red for unresolved | VERIFIED | `InboxItem.tsx`: `getStatusDotColor` switch |
| 18 | Tapping any item opens detail card with bucket buttons | VERIFIED | `inbox.tsx`: all items call `setSelectedItem(item)`; bucket buttons always rendered |
| 19 | Tapping a different bucket calls recategorize endpoint and shows toast | VERIFIED | `inbox.tsx`: `handleRecategorize` calls `PATCH /api/inbox/{itemId}/recategorize` |
| 20 | Classifier chain-of-thought reasoning is buffered and NOT yielded to SSE stream | VERIFIED | `workflow.py`: `_is_classifier_text` checks author and type; `classifier_buffer += update.text; continue` |
| 21 | Only the clean tool result line is yielded to the SSE stream for Classifier output | VERIFIED | `workflow.py`: clean_result constructed from parsed return string (Plan 09) or tool args fallback, yielded as single update |
| 22 | Misunderstood detection uses function_call.name inspection (not regex on streamed text) | VERIFIED | `workflow.py`: `_extract_function_call_info` checks `content.type == "function_call"` and `name in _CLASSIFICATION_TOOLS` |
| 23 | Inbox detail card shows bucket buttons for ALL item statuses (no showBucketButtons guard) | VERIFIED | `inbox.tsx` IIFE has no early return; bucket section always rendered |
| 24 | Misunderstood items show "Needs Clarification" label (not "Pending") with orange styling | VERIFIED | `InboxItem.tsx`: `isMisunderstood` flag; `bucketLabel = isMisunderstood ? "Needs Clarification" : ...` |
| 25 | When LLM provides valid four bucket scores, they are used as-is in allScores | VERIFIED | `classification.py`: `scores_provided` flag true when any score != 0.0; `all_scores = {"People": people_score, ...}` |
| 26 | When four bucket scores are all 0.0, allScores are derived from bucket + confidence | VERIFIED | `classification.py`: `all_scores = _derive_scores_from_bucket(bucket, confidence)` when `scores_provided == False` |
| 27 | When confidence itself is 0.0 but a valid bucket was chosen, a default confidence (0.75) is applied | VERIFIED | `classification.py`: `if confidence == 0.0 and bucket in VALID_BUCKETS: confidence = 0.75` |
| 28 | Debug logging shows actual received argument values for every classify_and_file call | VERIFIED | `classification.py`: `logger.debug("classify_and_file called: bucket=%s confidence=%.4f ...")` at method entry |
| 29 | Classifier instructions treat individual bucket scores as preferred but optional | VERIFIED | `classifier.py` Rule 4: "when possible. If omitted, scores are derived from your confidence and chosen bucket" |
| 30 | classify_and_file return string includes inbox_doc_id UUID suffix | VERIFIED | `classification.py`: `return f"Filed ... | {inbox_doc_id}"` in both return paths |
| 31 | Workflow adapter emits CLASSIFIED custom event with inboxItemId, bucket, confidence | VERIFIED | `workflow.py`: `CustomEvent(name="CLASSIFIED", value={"inboxItemId": classified_inbox_id, "bucket": ..., "confidence": ...})` |
| 32 | Follow-up reply that successfully classifies updates the ORIGINAL inbox item (not creates a new one) | VERIFIED | `main.py` CLASSIFIED path: reads orphan doc, copies to original via `upsert_item`, deletes orphan |
| 33 | Follow-up reply that triggers request_misunderstood at round 1 updates original clarificationText and deletes orphan | VERIFIED | `main.py` MISUNDERSTOOD round 1: updates `existing["clarificationText"]`, calls `upsert_item`, deletes orphan |

#### 6 Plan 09/10 Must-Haves (Full Verification)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 34 | Capture screen toast shows corrected confidence score (e.g., 0.75), not stale 0.00 from raw LLM args | VERIFIED | `workflow.py` lines 419-427: `parsed = _parse_classify_result(classify_result_str or ""); if parsed: clean_result = f"Filed ... {parsed['confidence']:.2f}"` — parsed post-fallback values used, not `detected_tool_args` |
| 35 | CLASSIFIED custom event carries the corrected confidence from the tool return string, not from function_call.arguments | VERIFIED | `workflow.py` lines 476-484: `parsed = _parse_classify_result(classify_result_str or ""); if parsed: yield CustomEvent(name="CLASSIFIED", value={"confidence": parsed["confidence"]})` |
| 36 | When tool return string says 'Filed -> People (0.75)', the toast shows 0.75 (not the pre-fallback 0.00) | VERIFIED | `_parse_classify_result` tested programmatically: `'Filed -> People (0.75) | abc-123'` returns `{"bucket": "People", "confidence": 0.75, "needs_review": False}`. `_CLASSIFY_RESULT_RE` handles both ASCII `->` and Unicode arrow forms. |
| 37 | Single-word inputs that are recognizable words or could be names/terms trigger request_misunderstood (not mark_as_junk) | VERIFIED | `classifier.py` lines 92-98: "IMPORTANT: If the input contains ANY recognizable word, name, or term -- even one you don't understand -- do NOT call mark_as_junk. Use request_misunderstood instead." with explicit example "Xyzzy -> request_misunderstood" |
| 38 | mark_as_junk is only called for true gibberish: keyboard mashing, random characters, empty/whitespace input | VERIFIED | `classifier.py` lines 87-98: junk definition restricted to keyboard mashing, random chars, empty input, repeated single characters — word "nonsensical" removed |
| 39 | Ambiguous single-word inputs like 'Xyzzy' enter conversation mode and ask for clarification | VERIFIED | `classifier.py` decision flow step 3 (line 107) comes before step 4/junk (line 111); explicit "Xyzzy -> request_misunderstood" example at line 95; tiebreaker "ALWAYS prefer request_misunderstood" at line 109 and "ALWAYS choose request_misunderstood" at line 123 |

**Score:** 39/39 truths verified

---

## Required Artifacts

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/tools/classification.py` | `classify_and_file` (score fallback, debug logging, UUID in return), `request_misunderstood`, `mark_as_junk` | VERIFIED | `_derive_scores_from_bucket` helper; confidence 0.0 fallback to 0.75; both return strings include `| {inbox_doc_id}` |
| `backend/src/second_brain/agents/classifier.py` | Three-tier decision flow, tools list, softened Rule 4, narrowed junk definition, tiebreaker, boundary examples | VERIFIED | Decision flow: high -> low -> misunderstood -> junk; junk restricted to keyboard mashing/random chars; "Xyzzy -> request_misunderstood" example; dual tiebreaker at lines 109 and 123 |
| `backend/src/second_brain/agents/workflow.py` | `_parse_classify_result`, `_CLASSIFY_RESULT_RE`, 5-tuple `_process_update`, parsed return string in clean_result and CLASSIFIED event, MISUNDERSTOOD/CLASSIFIED custom events | VERIFIED | `_parse_classify_result` at line 69; `_CLASSIFY_RESULT_RE` at line 64; `classify_result_str` tracked through both `_process_update` call sites; clean_result uses parsed values at lines 419-427; CLASSIFIED event uses parsed values at lines 476-484 |
| `backend/src/second_brain/api/inbox.py` | `PATCH /api/inbox/{item_id}/recategorize` endpoint | VERIFIED | `recategorize_inbox_item` present; full create-update-delete logic |
| `backend/src/second_brain/main.py` | `POST /api/ag-ui/follow-up` with 3-path orphan reconciliation, UNRESOLVED event | VERIFIED | CLASSIFIED reconciliation path; MISUNDERSTOOD round 1 path; unresolved (round >= 2) path |
| `mobile/app/capture/text.tsx` | Conversation mode UI, `handleFollowUpSubmit`, `followUpRound` state | VERIFIED | `followUpRound` state; agent question bubble; `sendFollowUp` in `handleFollowUpSubmit` |
| `mobile/lib/ag-ui-client.ts` | `sendFollowUp`, MISUNDERSTOOD/UNRESOLVED/CLASSIFIED event handling | VERIFIED | `sendFollowUp`; MISUNDERSTOOD handler; UNRESOLVED handler; CLASSIFIED handler |
| `mobile/app/(tabs)/inbox.tsx` | Detail card, `handleRecategorize`, bucket buttons for all statuses | VERIFIED | Both handlers present; bucket buttons always rendered |
| `mobile/components/InboxItem.tsx` | Color-coded status dots, `isMisunderstood` flag, "Needs Clarification" label | VERIFIED | `getStatusDotColor`; `isMisunderstood`; "Needs Clarification" label |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `classifier.py` | `classification.py` | `request_misunderstood` in tools list | WIRED | `classification_tools.request_misunderstood` in tools list |
| `workflow.py` | SSE stream (toast) | `_parse_classify_result(classify_result_str)` for clean_result construction | WIRED | Lines 419-427: parsed post-fallback values used; fallback to `detected_tool_args` if unparseable |
| `workflow.py` | CLASSIFIED event | `_parse_classify_result(classify_result_str)` for CLASSIFIED event confidence | WIRED | Lines 476-484: parsed post-fallback confidence in CLASSIFIED event value |
| `workflow.py` | MISUNDERSTOOD detection | `_extract_function_call_info` on every update | WIRED | Lines 228-246: `_process_update` inspects `function_call.name` |
| `workflow.py` | `classify_result_str` | `_process_update` 5th return element captures function_result string | WIRED | Lines 272-276: `classify_result_str = str(getattr(content, "result", "") or "")` |
| `mobile/app/capture/text.tsx` | `mobile/lib/ag-ui-client.ts` | `sendFollowUp` called in `handleFollowUpSubmit` | WIRED | `sendFollowUp({...})` called in follow-up handler |
| `mobile/lib/ag-ui-client.ts` | `backend/src/second_brain/main.py` | POST to `/api/ag-ui/follow-up` | WIRED | `${API_BASE_URL}/api/ag-ui/follow-up` in sendFollowUp |
| `mobile/app/(tabs)/inbox.tsx` | `backend/src/second_brain/api/inbox.py` | PATCH fetch for recategorize | WIRED | `fetch(${API_BASE_URL}/api/inbox/${itemId}/recategorize, {method: "PATCH",...})` |
| `main.py` follow-up CLASSIFIED path | CosmosDB Inbox + bucket containers | `upsert_item` on original, `delete_item` on orphan, `upsert_item` on bucket doc | WIRED | Reads orphan, reads original, upserts original, deletes orphan, updates bucket doc |

---

## Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| CLAS-04 | 04.3-01, 02, 03, 05, 07, 08, 09, 10 | When confidence < 0.6, Classifier asks the user a focused clarifying question before filing | SATISFIED | Three sub-flows: (1) misunderstood (< 0.3) triggers conversational follow-up via MISUNDERSTOOD event — now correctly routes "Xyzzy"-style inputs instead of marking as junk (Plan 10); (2) low-confidence (0.3-0.59) silently files as pending with non-zero scores (Plan 07 fallback); toast now shows correct confidence (Plan 09 parsed return string). (3) mis-categorized resolved via inbox recategorize. |
| APPX-04 | 04.3-03, 04, 06, 08, 09 | Conversation view opens when a specialist needs clarification, showing a focused chat | SATISFIED | Misunderstood captures show agent question bubble above text input. Confidence shown in toast matches stored value (Plan 09). Follow-up round 1 updates original item without duplicates (Plan 08). |

No orphaned requirements. Both CLAS-04 and APPX-04 marked "Complete" in REQUIREMENTS.md traceability table at Phase 4.

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `workflow.py` | 428-435 | Fallback to `detected_tool_args` if return string not parseable | Info | Intentional defensive safety net. Handles unexpected LLM return format without breaking the stream. |
| `workflow.py` | 486-493 | Fallback to `detected_tool_args` for CLASSIFIED event if return string not parseable | Info | Same safety net as above, consistent with clean_result fallback. |
| `workflow.py` | 497-499 | Log warning when Classifier stream ends without calling any classification tool | Info | Intentional defensive fallback. Indicates unexpected LLM response. Does not block any of the three target flows. |

No blockers. No stubs. No placeholder implementations found.

---

## Test Coverage

| Test Suite | Tests | Status |
|------------|-------|--------|
| `test_classification.py` | 17 tests | 17/17 PASSING |
| `test_inbox_api.py` | 5 recategorize tests | 5/5 PASSING |
| `test_inbox_delete.py` | 5 delete tests | 5/5 PASSING |
| `test_cosmos_crud.py` | 7 CRUD tests | 7/7 PASSING |
| `test_auth.py` | 3 auth tests | 3/3 PASSING |
| `test_health.py` | 1 health test | 1/1 PASSING |
| `test_integration.py` | 3 integration tests | 3/3 PASSING |
| **All backend tests** | **43 total** | **43/43 PASSING** |

All 43 backend tests pass after Plans 09 and 10 changes. No new test changes were required:
`_parse_classify_result` logic does not affect tool behavior (only the adapter's presentation
layer), and classifier instruction changes are prompt-only with no unit-testable Python surface.

---

## Commit Verification

| Plan | Commit | Status | Summary |
|------|--------|--------|---------|
| 09 | `fe21a7e` | VERIFIED | fix: parse tool return string for corrected confidence in toast and CLASSIFIED event |
| 10 | `e50f089` | VERIFIED | fix: narrow junk definition and reorder classifier decision flow |

---

## Human Verification Required

### 1. High-Confidence Capture — Corrected Confidence in Toast

**Test:** Type "Buy groceries tomorrow" and tap Send.
**Expected:** Step dots animate through Orchestrator and Classifier. Toast shows "Filed -> Admin (0.90)" — non-zero, not "0.00". Screen auto-resets after ~2.5 seconds.
**Why human:** Requires live Azure OpenAI. Verifies `_parse_classify_result` extracts post-fallback confidence from the tool return string instead of stale `detected_tool_args`. This is the root cause fixed by Plan 09 (RETEST2-UAT Tests 1 and 2).

### 2. Low-Confidence Capture — Non-Zero Confidence in Toast and Cosmos DB

**Test:** Type "Had coffee with Mike, he mentioned a project idea" and tap Send.
**Expected:** "Filed (needs review) -> People (0.55)" toast — non-zero confidence, not "0.00". Inbox item appears with orange dot. Tap it: detail card shows non-zero confidence matching toast.
**Why human:** Requires live classifier. Verifies Plan 07 (score fallback in Cosmos) and Plan 09 (parsed return string in toast) working together. Inbox card previously showed correct confidence but toast showed 0.00 (RETEST2-UAT Test 2).

### 3. Ambiguous Single-Word — Conversation Mode (Not Junk)

**Test:** Type "Xyzzy" and tap Send.
**Expected:** Agent question bubble appears above text input (conversation mode). No "Capture logged as unclassified" toast. Inbox shows 1 item with orange dot and "Needs Clarification" label.
**Why human:** Requires live Azure OpenAI. Verifies Plan 10 classifier instruction changes — junk definition narrowed, decision flow reordered (misunderstood before junk), tiebreaker added. "Xyzzy" should now route to request_misunderstood instead of mark_as_junk.

### 4. Misunderstood Follow-Up — No Duplicate, Correct Confidence

**Test:** Type "Aardvark". Agent question appears. Reply "It's my friend's startup name".
**Expected:** "Filed -> Projects (0.80)" toast with correct non-zero confidence. Open Inbox: the ORIGINAL "Aardvark" item is now classified. No second "Aardvark" item. Total Inbox items for "Aardvark" = 1.
**Why human:** Requires live Azure OpenAI. Verifies Plan 08 orphan reconciliation + Plan 09 corrected confidence in CLASSIFIED event (which is used by the main.py post-stream reconciliation to know what to copy to the original doc).

### 5. Inbox Detail Card — Classified Item Recategorize

**Test:** Open Inbox tab. Tap a classified item (no status dot).
**Expected:** Detail card shows correct Bucket/Confidence metadata. 4 bucket buttons at bottom with "Move to bucket" label. Tap a different bucket: "Moved to [Bucket]" toast, card closes, item updates.
**Why human:** Requires live backend with classified Cosmos DB items.

### 6. Misunderstood Item in Inbox

**Test:** After a failed misunderstood capture, open Inbox.
**Expected:** Item shows orange dot and "Needs Clarification" label. Badge count includes item. Tap item: detail card shows "Needs Clarification" status and agent's question text. Bucket buttons present.
**Why human:** Requires live backend with a misunderstood item in Cosmos DB.

---

## Gaps Summary

No gaps. All 39 observable truths verified (33 original regression checks + 6 Plan 09/10 must-haves).
All 9 key artifacts substantive and wired. All 9 key links confirmed. Requirements CLAS-04 and
APPX-04 satisfied. 43/43 backend tests passing.

The 3 RETEST2-UAT issues were each closed by targeted code changes in Plans 09 and 10:

- **Tests 1 and 2 (stale 0.00 confidence in toast):** Fixed by Plan 09's `_parse_classify_result`
  helper. The tool's return string (e.g., "Filed -> People (0.75) | {uuid}") already contains
  post-fallback values. The adapter now parses this string to extract `bucket` and `confidence`
  for clean_result text and the CLASSIFIED custom event. `_CLASSIFY_RESULT_RE` handles both
  ASCII `->` and Unicode arrow formats. Safe fallback to `detected_tool_args` if the
  return string format is unexpected.

- **Test 5 (ambiguous word goes to junk instead of conversation mode):** Fixed by Plan 10's
  three targeted changes to classifier instructions. Junk definition narrowed to ONLY keyboard
  mashing, random characters, empty input, and repeated single characters — the word
  "nonsensical" that created overlap was removed. Explicit exclusion added: any recognizable
  word/name/term must use request_misunderstood, not mark_as_junk (with "Xyzzy -> request_misunderstood"
  as a concrete example). Decision flow reordered so high confidence (step 1), low confidence
  (step 2), and misunderstood (step 3) are all evaluated before junk (step 4). "When in doubt
  prefer request_misunderstood" tiebreaker added in two locations for reinforcement.

---

_Verified: 2026-02-24T19:00:00Z_
_Verifier: Claude (gsd-verifier)_
_Re-verification after RETEST2-UAT gap closure (Plans 09 and 10)_
