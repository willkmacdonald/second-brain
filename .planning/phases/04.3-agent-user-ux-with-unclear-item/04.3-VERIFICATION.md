---
phase: 04.3-agent-user-ux-with-unclear-item
verified: 2026-02-23T12:00:00Z
status: passed
score: 24/24 must-haves verified
re_verification:
  previous_status: passed
  previous_score: 19/19
  context: >
    Previous verification (2026-02-23) was created before UAT ran. UAT (also 2026-02-23) found
    5 real failures. Plans 05 and 06 were created to close those gaps. This re-verification
    covers the original 19 truths (regression check) plus 5 UAT-derived truths (full verification).
  gaps_closed:
    - "High-confidence capture streams only clean tool result text, not classifier chain-of-thought reasoning"
    - "Low-confidence capture streams only clean tool result text and auto-resets"
    - "Misunderstood capture emits MISUNDERSTOOD event and capture screen enters conversation mode"
    - "Inbox detail card shows bucket buttons for ALL item statuses (classified, pending, misunderstood, unresolved)"
    - "Misunderstood items display correctly in inbox (Needs Clarification label, clarificationText in detail card, counted in badge)"
  gaps_remaining: []
  regressions: []
gaps: []
human_verification:
  - test: "High-confidence capture clean toast and auto-reset on device"
    expected: "Type a clear unambiguous thought (e.g., 'Buy groceries tomorrow'). Tap Send. Step dots animate. Header shows 'Filed -> Admin (0.90)' (or similar bucket), NOT verbose scores breakdown. Screen auto-resets after ~2.5 seconds."
    why_human: "Requires live Azure OpenAI to generate actual classifier output; verifies the buffering suppresses chain-of-thought in production"
  - test: "Misunderstood flow end-to-end on device"
    expected: "Type something very unclear (e.g., 'Aardvark'). Tap Send. Agent question bubble appears above text input. Input cleared for reply. Send button shows 'Reply'. Type a reply, tap Reply -- step dots animate, re-classification runs. If still unclear after 2 rounds, shows 'Couldn't classify. Check inbox later.' toast and resets."
    why_human: "Requires live Azure OpenAI to produce < 0.3 confidence and emit MISUNDERSTOOD via function_result content inspection"
  - test: "Low-confidence capture silent pending flow on device"
    expected: "Type an ambiguous thought. After Send: clean 'Filed (needs review) -> People (0.55)' toast (no verbose reasoning), no bucket buttons, auto-reset after ~2.5 seconds. Item appears in inbox with orange dot."
    why_human: "Requires live classifier producing 0.3-0.59 confidence result; verifies buffering in production"
  - test: "Inbox detail card for classified item"
    expected: "Tap a classified (no dot) item. Detail card opens. Bucket/Confidence/Agent Chain metadata shown. 4 bucket buttons at bottom with 'Move to bucket' label; current bucket highlighted blue. Tap a different bucket: 'Moved to [Bucket]' toast, card closes, item updates."
    why_human: "Requires live backend and populated Cosmos DB; verifies the showBucketButtons guard removal works for classified items"
  - test: "Misunderstood item in inbox"
    expected: "After a failed misunderstood capture: inbox shows item with orange dot and 'Needs Clarification' label (not 'Pending'). Tap it: detail card shows 'Needs Clarification' status and the agent's question text (not 'Unknown bucket / N/A'). Badge count includes this item. Bucket buttons present with 'File to bucket' label."
    why_human: "Requires live backend and a genuinely misunderstood item in Cosmos DB"
---

# Phase 04.3: agent-user UX with unclear item — Verification Report

**Phase Goal:** Three distinct classification failure flows: misunderstood (conversational follow-up), low-confidence (silent pending filing), and mis-categorized (inbox recategorize)
**Verified:** 2026-02-23
**Status:** PASSED
**Re-verification:** Yes — after UAT gap closure (Plans 05 and 06)

---

## Re-Verification Context

The original VERIFICATION.md (2026-02-23) was created before UAT ran and passed with 19/19. UAT
then found 5 real failures revealing that the original verification had verified code structure but
not runtime behavior. Plans 05 and 06 were executed to close these gaps:

- **Plan 05** (`c6eae8e`): Classifier text buffering in `workflow.py` — suppresses chain-of-thought
  reasoning from SSE stream; multi-strategy misunderstood detection via function_result content
  inspection, request_info data extraction, and buffer regex.
- **Plan 06** (`25680fa`, `4745ec0`): Inbox display fixes — bucket buttons for all statuses,
  "Needs Clarification" label for misunderstood items, misunderstood in badge count, conditional
  detail card rendering using `classificationMeta` presence.

This re-verification treats the 5 UAT-derived truths as new full verifications (exists +
substantive + wired) and the original 19 truths as regression checks.

---

## Goal Achievement

### Observable Truths

#### Original 19 Truths (Regression Check)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | Classifier agent distinguishes misunderstood / low-confidence / high-confidence | VERIFIED | `classifier.py`: three-tier thresholds in instructions (< 0.3 misunderstood, 0.3-0.59 low-confidence, >= 0.6 high-confidence) |
| 2  | Misunderstood input creates inbox doc with status 'misunderstood' and clarificationText | VERIFIED | `classification.py`: `request_misunderstood` creates `InboxDocument(status="misunderstood", clarificationText=question_text)` |
| 3  | Low-confidence (0.3-0.59) files as pending with "Filed (needs review)" return string | VERIFIED | `classification.py` line 97: `status = "pending"` when confidence < threshold; return string includes "(needs review)" |
| 4  | MISUNDERSTOOD custom event emitted (distinct from HITL_REQUIRED) | VERIFIED | `workflow.py` lines 559-572: `CustomEvent(name="MISUNDERSTOOD", ...)` emitted when `detected_misunderstood is not None` |
| 5  | request_clarification removed; request_misunderstood is the misunderstood tool | VERIFIED | `classification.py` has no `request_clarification`; `classifier.py` tools list includes `request_misunderstood` only |
| 6  | Classified inbox item can be moved via PATCH request | VERIFIED | `inbox.py`: `@router.patch("/api/inbox/{item_id}/recategorize")` at line 192 |
| 7  | Recategorize creates new bucket doc, updates inbox, deletes old bucket (in order) | VERIFIED | `inbox.py` lines 233-283: Step 1 create, Step 2 upsert, Step 3 delete (non-fatal) |
| 8  | Recategorize to same bucket is a no-op | VERIFIED | `inbox.py`: early return when `old_bucket == body.new_bucket`; test `test_recategorize_same_bucket_noop` passes |
| 9  | Invalid bucket names return 400 | VERIFIED | `inbox.py`: `HTTPException(status_code=400)` on invalid bucket; test passes |
| 10 | Non-existent inbox items return 404 | VERIFIED | `inbox.py`: `HTTPException(status_code=404)` on CosmosResourceNotFoundError; test passes |
| 11 | Misunderstood captures trigger conversational follow-up on capture screen | VERIFIED | `text.tsx` lines 174-182: `onMisunderstood` sets `agentQuestion`, `misunderstoodInboxItemId`, `followUpRound=1`, clears input |
| 12 | Agent question bubble visible above text input | VERIFIED | `text.tsx` lines 304-311: `{agentQuestion && <View style={styles.agentQuestionBubble}>...}` renders above `<TextInput>` |
| 13 | User types reply in cleared input | VERIFIED | `text.tsx` line 179: `setThought("")` on MISUNDERSTOOD; placeholder changes to "Add more context..." when `followUpRound > 0` |
| 14 | Re-classification runs on original text + clarification combined | VERIFIED | `main.py` lines 517-521: `combined_text = f"{original_text}\n\n---\nUser clarification: {body.follow_up_text}"` |
| 15 | Max 2 follow-up rounds; unresolved after 2 goes to inbox with status 'unresolved' | VERIFIED | `main.py` lines 544-614: `follow_up_round >= 2` intercepts MISUNDERSTOOD, updates inbox to "unresolved", emits UNRESOLVED event |
| 16 | Follow-up endpoint streams SSE events | VERIFIED | `main.py`: `StreamingResponse(generate(), media_type="text/event-stream")` at follow-up endpoint |
| 17 | Inbox list shows orange dot for pending/low_confidence/misunderstood, red for unresolved, no dot for classified | VERIFIED | `InboxItem.tsx` lines 72-83: `getStatusDotColor` switch — orange for pending/low_confidence/misunderstood, red for unresolved, null otherwise |
| 18 | Tapping any item opens detail card with bucket buttons | VERIFIED | `inbox.tsx` line 131: all items call `setSelectedItem(item)`; IIFE at line 326 always renders bucket buttons (no `showBucketButtons` guard) |
| 19 | Tapping a different bucket calls recategorize endpoint and shows toast | VERIFIED | `inbox.tsx` lines 137-180: `handleRecategorize` calls `PATCH /api/inbox/{itemId}/recategorize`, sets `recategorizeToast` |

#### 5 UAT-Derived Truths (Full Verification)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 20 | Classifier chain-of-thought reasoning is buffered and NOT yielded to SSE stream | VERIFIED | `workflow.py` line 170: `_is_classifier_text` checks `author_name == "classifier"` and all contents `type == "text"`; lines 398-415: `classifier_buffer += update.text; continue` — never yields buffered text |
| 21 | Only the clean tool result line is yielded to the SSE stream for Classifier output | VERIFIED | `workflow.py` lines 529-556: after stream loop, `_TOOL_RESULT_RE.search(classifier_buffer)` extracts `"Filed -> Admin (0.90)"` or `"Filed (needs review) -> People (0.55)"` and yields a single `AgentResponseUpdate`; reasoning discarded |
| 22 | Misunderstood detection uses function_result content inspection (not just regex on streamed text) | VERIFIED | `workflow.py` lines 203-221: `_extract_misunderstood_from_content` checks content items with `type == "function_result"` and `name == "request_misunderstood"`; called on every update at lines 390-395 and 481-487 |
| 23 | Inbox detail card shows bucket buttons for ALL item statuses (no showBucketButtons guard) | VERIFIED | `inbox.tsx` lines 326-375: IIFE has no early return; `isPendingItem` includes `misunderstood` and `unresolved` at lines 327-331; bucket section always rendered |
| 24 | Misunderstood items show "Needs Clarification" label (not "Pending") with orange styling | VERIFIED | `InboxItem.tsx` lines 93-102: `isMisunderstood` flag separate from `isPending`; `bucketLabel = isMisunderstood ? "Needs Clarification" : ...`; line 130 applies `bucketPending` style for both `isPending` and `isMisunderstood` |

**Score:** 24/24 truths verified

---

## Required Artifacts

### Original Artifacts (Regression)

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/tools/classification.py` | `request_misunderstood` tool, pending status for low-confidence | VERIFIED | 211 lines; `request_misunderstood` at line 144; `status = "pending"` at line 97 |
| `backend/src/second_brain/agents/classifier.py` | Three-tier decision flow, tools list with `request_misunderstood` | VERIFIED | 142 lines; "Classification Decision Flow" section lines 91-132 |
| `backend/src/second_brain/api/inbox.py` | `PATCH /api/inbox/{item_id}/recategorize` endpoint | VERIFIED | `recategorize_inbox_item` at line 192; full create-update-delete logic |
| `backend/src/second_brain/main.py` | `POST /api/ag-ui/follow-up` endpoint, UNRESOLVED event | VERIFIED | `follow_up_misunderstood` at line 487; UNRESOLVED emission at line 609 |
| `mobile/app/capture/text.tsx` | Conversation mode UI, `handleFollowUpSubmit`, `followUpRound` state | VERIFIED | `followUpRound` at line 38; agent question bubble at lines 304-311 |
| `mobile/lib/ag-ui-client.ts` | `sendFollowUp`, MISUNDERSTOOD/UNRESOLVED event handling | VERIFIED | `sendFollowUp` at line 204; MISUNDERSTOOD at line 76; UNRESOLVED at line 84 |
| `mobile/app/(tabs)/inbox.tsx` | Detail card, `handleRecategorize`, `handlePendingResolve` | VERIFIED | Both handlers present; bucket buttons always rendered in IIFE |
| `mobile/components/InboxItem.tsx` | Color-coded status dots, bucket labels | VERIFIED | `getStatusDotColor` at line 72; `isMisunderstood` at line 93 |

### Gap-Closure Artifacts (Full Verification)

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/agents/workflow.py` | Classifier text buffering, `_TOOL_RESULT_RE`, multi-strategy misunderstood detection | VERIFIED | 640 lines; `_TOOL_RESULT_RE` at line 64; `_is_classifier_text` at line 170; `_has_misunderstood_tool_call` at line 187; `_extract_misunderstood_from_content` at line 204; `classifier_buffer` at line 332; buffer flush at lines 529-556 |
| `mobile/app/(tabs)/inbox.tsx` | Badge count includes misunderstood; bucket buttons for all statuses; conditional detail card | VERIFIED | `isPendingStatus` at line 80 includes `"misunderstood"`; IIFE at line 326 has no guard; `classificationMeta` null-check at line 283 branches to clarificationText display |
| `mobile/components/InboxItem.tsx` | `isMisunderstood` flag with "Needs Clarification" label | VERIFIED | `isMisunderstood` at line 93; `bucketLabel = isMisunderstood ? "Needs Clarification" : ...` at line 96 |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `classifier.py` | `classification.py` | `request_misunderstood` in tools list | WIRED | `classification_tools.request_misunderstood` in tools list |
| `workflow.py` | SSE stream | `_is_classifier_text` gates buffer; `_TOOL_RESULT_RE` extracts result | WIRED | Lines 398-415: text-only Classifier updates buffered; lines 541-551: clean result yielded at stream end |
| `workflow.py` | MISUNDERSTOOD detection | `_extract_misunderstood_from_content` on every update; `_extract_misunderstood` on request_info data | WIRED | Lines 390-395 and 481-487: content inspection; lines 444-451: request_info extraction |
| `mobile/app/capture/text.tsx` | `mobile/lib/ag-ui-client.ts` | `sendFollowUp` called in `handleFollowUpSubmit` | WIRED | Line 87: `const cleanup = sendFollowUp({...})` |
| `mobile/lib/ag-ui-client.ts` | `backend/src/second_brain/main.py` | POST to `/api/ag-ui/follow-up` | WIRED | Line 212: `${API_BASE_URL}/api/ag-ui/follow-up` |
| `ag-ui-client.ts` `onComplete` | `text.tsx` `resetState` | `RUN_FINISHED` triggers `onComplete(result)` only when `!hitlTriggered` | WIRED | `attachCallbacks` line 92: `if (!hitlTriggered) callbacks.onComplete(result)`; `text.tsx` line 207: `setTimeout(resetState, AUTO_RESET_MS)` |
| `mobile/app/(tabs)/inbox.tsx` | `backend/src/second_brain/api/inbox.py` | PATCH fetch for recategorize | WIRED | Lines 143-153: `fetch(\`${API_BASE_URL}/api/inbox/${itemId}/recategorize\`, {method: "PATCH",...})` |

---

## Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| CLAS-04 | 04.3-01, 04.3-02, 04.3-03, 04.3-05 | When confidence < 0.6, Classifier asks the user a focused clarifying question before filing | SATISFIED (EXTENDED) | Phase 04.3 splits into three sub-flows: (1) truly misunderstood (< 0.3) triggers conversational follow-up via MISUNDERSTOOD event with reliable function_result detection; (2) low-confidence (0.3-0.59) silently files as pending; (3) mis-categorized resolved via inbox recategorize |
| APPX-04 | 04.3-03, 04.3-04, 04.3-06 | Conversation view opens when a specialist needs clarification, showing a focused chat | SATISFIED (EXTENDED) | Misunderstood captures show agent question bubble above text input on capture screen. Inbox detail card (bucket buttons for all statuses) is the clarification view for pending/misunderstood resolution. |

**No orphaned requirements.** REQUIREMENTS.md maps CLAS-04 and APPX-04 to "Phase 4" with status "Complete". Phase 04.3 is an inserted phase extending these requirements — no Phase 04.3 row in the traceability table is expected.

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `workflow.py` | 587-596 | Fallback generic HITL_REQUIRED emission when `saw_request_info` is true but no pattern matched | Info | Intentional defensive fallback for unknown edge cases. Correct behavior — does not block any of the three target flows. |
| `text.tsx` | 339-364 | HITL bucket buttons (`hitlContainer`) still present alongside misunderstood conversation mode | Info | The `hitlContainer` renders only when `hitlQuestion !== null`. For misunderstood flow, only `agentQuestion` is set. The two flows are mutually exclusive by state. No user-visible conflict. |

No blockers. No stubs. No placeholder implementations found in any gap-closure code.

---

## Test Coverage

| Test Suite | Tests | Status |
|------------|-------|--------|
| `test_classification.py` | 14 tests (incl. 2 `request_misunderstood` tests, 1 low-confidence test) | 14/14 PASSING |
| `test_inbox_api.py` | 5 recategorize tests | 5/5 PASSING |
| All backend tests | 43 total | 43/43 PASSING |
| TypeScript type-check | `npx tsc --noEmit` (mobile) | PASSING (exit 0) |

All 43 backend tests pass after Plan 05 changes to `workflow.py`. TypeScript type check passes after Plan 06 changes to `inbox.tsx` and `InboxItem.tsx`. No regressions.

---

## Human Verification Required

### 1. High-Confidence Capture: Clean Toast and Auto-Reset

**Test:** Type a clear, unambiguous thought (e.g., "Buy groceries tomorrow") and tap Send.
**Expected:** Step dots animate through Orchestrator and Classifier. Header shows clean "Filed -> Admin (0.90)" (NOT a wall of classifier reasoning text). Screen auto-resets after ~2.5 seconds.
**Why human:** Requires live Azure OpenAI to produce real classifier output. Verifies `_is_classifier_text` buffering correctly identifies and suppresses Classifier text-only deltas while yielding the clean `_TOOL_RESULT_RE` match.

### 2. Misunderstood Flow End-to-End

**Test:** Type a completely ambiguous single word (e.g., "Aardvark") and tap Send.
**Expected:** Instead of bucket buttons or a filed toast, an agent question bubble appears above the text input (blue left border, question text inside). Input is cleared. Send button shows "Reply". "Reply below (follow-up 1 of 2)" hint visible. Type "It's my friend's startup name" and tap Reply. If re-classified: "Filed -> Projects (0.80)" toast and auto-reset. If still unclear: another question (follow-up 2 of 2). After 2 failed rounds: "Couldn't classify. Check inbox later." toast and state reset.
**Why human:** Requires live Azure OpenAI producing < 0.3 confidence result. Verifies `_has_misunderstood_tool_call` / `_extract_misunderstood_from_content` detect the `request_misunderstood` tool call in function_result content items (core fix for UAT Test 3).

### 3. Low-Confidence Silent Pending

**Test:** Type an ambiguous thought (e.g., "Had coffee with Mike, he mentioned a project idea") and tap Send.
**Expected:** Step dots animate. Clean "Filed (needs review) -> People (0.55)" toast (NOT verbose reasoning). No bucket buttons appear. Screen auto-resets after ~2.5 seconds. Item appears in inbox with orange dot.
**Why human:** Requires live classifier to produce 0.3-0.59 confidence. Verifies the buffering fix for the "needs review" pattern.

### 4. Inbox Detail Card for Classified Item

**Test:** Open Inbox tab. Tap a classified item (no status dot).
**Expected:** Detail card opens showing Bucket / Confidence / Agent Chain metadata (not "Unknown"). 4 bucket buttons at bottom with "Move to bucket" label. Current bucket highlighted in blue. Tap a different bucket: "Moved to [Bucket]" toast, card closes, item updates in list.
**Why human:** Requires live backend with classified Cosmos DB items. Verifies removal of `showBucketButtons` guard that blocked classified items from seeing buttons (UAT Test 6 fix).

### 5. Misunderstood Item in Inbox

**Test:** After a misunderstood capture, open Inbox.
**Expected:** Item shows orange dot and "Needs Clarification" label (not "Pending"). Badge count includes this item. Tap item: detail card shows "Needs Clarification" status (orange text) and the agent's original question under "Agent Question" (not "Unknown" bucket / "N/A"). Bucket buttons present with "File to bucket" label. Tap a bucket: item resolved.
**Why human:** Requires live backend with a misunderstood item in Cosmos DB. Verifies UAT Test 9 fixes: badge count, label, and conditional detail card rendering.

---

## Gaps Summary

No gaps. All 24 observable truths verified (19 original regression checks + 5 UAT-derived truths). All 11 artifacts substantive and wired. All 7 key links confirmed. Requirements CLAS-04 and APPX-04 satisfied. 43/43 backend tests passing. TypeScript type check passing.

The 5 UAT failures from 2026-02-23 were each closed by targeted code changes:

- **Tests 1 and 2 (verbose streaming, no auto-reset):** Fixed by `classifier_buffer` pattern in `workflow.py`. All Classifier text-only deltas are buffered; only `_TOOL_RESULT_RE` match is yielded at stream end. The `onComplete(result)` callback in `ag-ui-client.ts` now receives the clean tool result string and triggers `setTimeout(resetState, AUTO_RESET_MS)`.

- **Test 3 (MISUNDERSTOOD event never fired, HITL bucket buttons shown instead):** Fixed by `_extract_misunderstood_from_content` inspecting `function_result` content items for `name == "request_misunderstood"`. Previously relied on regex matching `update.text`, which never contained tool return values (consumed internally by the LLM).

- **Test 6 (no bucket buttons for classified items):** Fixed by removing the `if (!showBucketButtons) return null` guard in `inbox.tsx`. Bucket buttons now always render in the IIFE; `isPendingItem` and `isClassifiedItem` only control label text and handler selection.

- **Test 9 (misunderstood items broken in inbox):** Fixed by three changes: (1) `isPendingStatus` in badge count now includes `"misunderstood"`; (2) detail card branches on `classificationMeta` presence — misunderstood/unresolved items show `clarificationText` instead of "Unknown" metadata; (3) `InboxItem.tsx` separates `isMisunderstood` from `isPending` to display "Needs Clarification" label with orange styling.

---

_Verified: 2026-02-23_
_Verifier: Claude (gsd-verifier)_
_Re-verification after UAT gap closure (Plans 05 and 06)_
