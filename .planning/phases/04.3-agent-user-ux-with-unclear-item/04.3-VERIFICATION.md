---
phase: 04.3-agent-user-ux-with-unclear-item
verified: 2026-02-23T00:00:00Z
status: passed
score: 19/19 must-haves verified
re_verification: null
gaps: []
human_verification:
  - test: "Misunderstood flow end-to-end on device"
    expected: "Agent question bubble appears above text input when input is ambiguous; user can type a reply; classification retries; after 2 failed rounds shows 'Couldn't classify. Check inbox later.' toast and resets"
    why_human: "Requires live device with running backend and Azure OpenAI to trigger a genuine misunderstood classification (< 0.3 confidence)"
  - test: "Low-confidence capture silent pending flow"
    expected: "A low-confidence input (0.3-0.59) shows 'Filed (needs review) -> Bucket (0.xx)' toast on capture screen and auto-resets without showing bucket buttons or HITL UI"
    why_human: "Requires live backend with real classifier producing a low-confidence result"
  - test: "Inbox recategorize from detail card"
    expected: "Tapping a classified item opens detail card; current bucket highlighted in blue; tapping a different bucket shows 'Moved to [Bucket]' toast and dismisses card; list item updates to new bucket"
    why_human: "Requires live backend and populated Cosmos DB inbox"
  - test: "Pending item resolution from inbox detail card"
    expected: "Tapping a pending item opens detail card with 'File to bucket' label; selecting a bucket calls the respond endpoint and shows 'Filed to [Bucket]' toast"
    why_human: "Requires live backend with pending inbox items"
---

# Phase 04.3: agent-user UX with unclear item — Verification Report

**Phase Goal:** Three distinct classification failure flows: misunderstood (conversational follow-up), low-confidence (silent pending filing), and mis-categorized (inbox recategorize)
**Verified:** 2026-02-23
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | Classifier agent distinguishes misunderstood input from low-confidence classification | VERIFIED | `classifier.py` lines 91-132: "Classification Decision Flow" with explicit three-tier thresholds (< 0.3 = misunderstood, 0.3-0.59 = low-confidence, >= 0.6 = high confidence) |
| 2  | Misunderstood input creates an inbox doc with status 'misunderstood' and a conversational question | VERIFIED | `classification.py` lines 169-187: `request_misunderstood` creates `InboxDocument(status="misunderstood", clarificationText=question_text, filedRecordId=None, classificationMeta=None)` |
| 3  | Low-confidence input (0.3-0.59) calls classify_and_file with pending status instead of request_clarification | VERIFIED | `classification.py` line 97: `status = "classified" if confidence >= self._threshold else "pending"`; return string line 141: `"Filed (needs review) \u2192 {bucket} ({confidence:.2f})"` |
| 4  | Adapter emits MISUNDERSTOOD custom event for misunderstood input (distinct from HITL_REQUIRED) | VERIFIED | `workflow.py` lines 325-338: detects `_MISUNDERSTOOD_RE`, emits `CustomEvent(name="MISUNDERSTOOD", value={threadId, inboxItemId, questionText})`; low-confidence HITL_REQUIRED fallback block removed |
| 5  | request_clarification tool is removed; request_misunderstood replaces it for the misunderstood flow | VERIFIED | `classification.py` has no `request_clarification` method; `classifier.py` tools list has `request_misunderstood` only |
| 6  | A classified inbox item can be moved to a different bucket via PATCH request | VERIFIED | `inbox.py` lines 191-288: `@router.patch("/api/inbox/{item_id}/recategorize")` with full create-update-delete sequence |
| 7  | Recategorize creates new bucket doc, updates inbox doc, deletes old bucket doc (in that order) | VERIFIED | `inbox.py` lines 233-283: Step 1 (create_item), Step 2 (upsert_item), Step 3 (delete_item, non-fatal); test `test_recategorize_success` verifies all three calls |
| 8  | Recategorize to the same bucket is a no-op | VERIFIED | `inbox.py` lines 229-231: `if old_bucket == body.new_bucket: return dict(item)`; confirmed by `test_recategorize_same_bucket_noop` |
| 9  | Invalid bucket names return 400 error | VERIFIED | `inbox.py` lines 207-213: `HTTPException(status_code=400)`; `test_recategorize_invalid_bucket` passes |
| 10 | Non-existent inbox items return 404 error | VERIFIED | `inbox.py` lines 217-222: `HTTPException(status_code=404)` on CosmosResourceNotFoundError; `test_recategorize_not_found` passes |
| 11 | Misunderstood captures trigger a conversational follow-up on the capture screen | VERIFIED | `text.tsx` lines 174-181: `onMisunderstood` callback sets `agentQuestion`, `misunderstoodInboxItemId`, `followUpRound=1`, clears input |
| 12 | Agent question text is visible above the text input when in follow-up mode | VERIFIED | `text.tsx` lines 304-311: `{agentQuestion && <View style={styles.agentQuestionBubble}>...}` renders above `<TextInput>` |
| 13 | User types a reply in the same text input (cleared for response) | VERIFIED | `text.tsx` line 179: `setThought("")` clears input on MISUNDERSTOOD; line 317: placeholder changes to "Add more context..." when `followUpRound > 0` |
| 14 | Re-classification runs on original text + user clarification combined | VERIFIED | `main.py` lines 517-521: `combined_text = f"{original_text}\n\n---\nUser clarification: {body.follow_up_text}"` |
| 15 | Maximum 2 follow-up rounds; unresolved after 2 rounds goes to inbox with status 'unresolved' | VERIFIED | `main.py` lines 543-556: at `follow_up_round >= 2`, intercepts MISUNDERSTOOD event, updates inbox status to "unresolved", emits UNRESOLVED event; `text.tsx` line 114: toast shown and state reset on UNRESOLVED |
| 16 | Follow-up endpoint streams SSE events for progress feedback | VERIFIED | `main.py` lines 532-616: full SSE streaming via `StreamingResponse(generate(), media_type="text/event-stream")` |
| 17 | Inbox list shows orange dot for pending/low_confidence/misunderstood, red dot for unresolved, no dot for classified | VERIFIED | `InboxItem.tsx` lines 72-83: `getStatusDotColor` returns `#f97316` (orange) for pending/low_confidence/misunderstood, `#ef4444` (red) for unresolved, null for others |
| 18 | Tapping a classified item opens detail card with 4 bucket buttons (current bucket highlighted) | VERIFIED | `inbox.tsx` lines 130-135: all items call `setSelectedItem(item)`; lines 313-362: IIFE renders bucket buttons for `isClassifiedItem`; `isCurrent` check at line 329 drives `bucketButtonCurrent` style |
| 19 | Tapping a different bucket calls the recategorize endpoint and shows 'Moved to [Bucket]' toast | VERIFIED | `inbox.tsx` lines 137-180: `handleRecategorize` calls `PATCH /api/inbox/{itemId}/recategorize`, sets `recategorizeToast(`Moved to ${newBucket}`)` |

**Score:** 19/19 truths verified

---

## Required Artifacts

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/tools/classification.py` | `request_misunderstood` tool, updated `classify_and_file` pending status | VERIFIED | 211 lines; `request_misunderstood` method at line 144; `status = "pending"` at line 97; distinct return string at line 141 |
| `backend/src/second_brain/agents/classifier.py` | Three-tier classifier instructions, `request_misunderstood` in tool list | VERIFIED | 142 lines; full "Classification Decision Flow" section lines 91-132; `request_misunderstood` in tools list line 139 |
| `backend/src/second_brain/agents/workflow.py` | MISUNDERSTOOD regex, `_extract_misunderstood` method, MISUNDERSTOOD event emission | VERIFIED | `_MISUNDERSTOOD_RE` at line 52; `_extract_misunderstood` at line 165; MISUNDERSTOOD emission at line 331; low-confidence fallback absent |
| `backend/tests/test_classification.py` | Tests for `request_misunderstood` and updated `classify_and_file` | VERIFIED | `test_request_misunderstood_creates_misunderstood_inbox` at line 297; `test_request_misunderstood_returns_parseable_string` at line 328; low-confidence asserts `status == "pending"` and `"(needs review)" in result` |
| `backend/src/second_brain/api/inbox.py` | `PATCH /api/inbox/{item_id}/recategorize` endpoint | VERIFIED | `recategorize_inbox_item` at line 192; full create-update-delete logic; validation complete |
| `backend/tests/test_inbox_api.py` | 5 recategorize endpoint tests | VERIFIED | 5 tests: success, no-op, invalid bucket, not found, non-fatal delete failure — all passing |
| `backend/src/second_brain/main.py` | `POST /api/ag-ui/follow-up` endpoint | VERIFIED | `follow_up_misunderstood` at line 487; `FollowUpRequest` model at line 173; full SSE stream with MISUNDERSTOOD intercept |
| `mobile/app/capture/text.tsx` | Conversation mode UI, `handleFollowUpSubmit`, `followUpRound` state | VERIFIED | `followUpRound` state at line 38; `handleFollowUpSubmit` at line 77; `agentQuestion` bubble at lines 304-311; Send button text adapts at line 297 |
| `mobile/lib/ag-ui-client.ts` | `sendFollowUp` function, MISUNDERSTOOD/UNRESOLVED event handling | VERIFIED | `sendFollowUp` at line 204; MISUNDERSTOOD handler at line 76-83; UNRESOLVED handler at line 84-86 |
| `mobile/lib/types.ts` | `onMisunderstood`, `onUnresolved` callbacks, `SendFollowUpOptions` interface | VERIFIED | `onMisunderstood` at line 20; `onUnresolved` at line 21; `SendFollowUpOptions` at lines 40-46 |
| `mobile/components/InboxItem.tsx` | Color-coded status dots | VERIFIED | `getStatusDotColor` at lines 72-83; `statusDot` style; `bucketUnresolved` style at line 178 |
| `mobile/app/(tabs)/inbox.tsx` | Detail card with bucket buttons, `handleRecategorize` | VERIFIED | `handleRecategorize` at line 137; `handlePendingResolve` at line 182; bucket buttons in modal at lines 313-362; `recategorizeToast` at line 35 |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `classifier.py` | `classification.py` | `request_misunderstood` registered in tools list | WIRED | Line 139: `classification_tools.request_misunderstood` in `tools=[...]` |
| `workflow.py` | `classification.py` | `_MISUNDERSTOOD_RE` matches `request_misunderstood` return format | WIRED | Regex `r"Misunderstood\s*→\s*..."` matches tool's return `f"Misunderstood \u2192 {inbox_doc_id} | {question_text}"` |
| `mobile/app/capture/text.tsx` | `mobile/lib/ag-ui-client.ts` | `sendFollowUp` called in `handleFollowUpSubmit` | WIRED | Line 87: `const cleanup = sendFollowUp({...})` |
| `mobile/lib/ag-ui-client.ts` | `backend/src/second_brain/main.py` | POST to `/api/ag-ui/follow-up` | WIRED | Line 212: `\`${API_BASE_URL}/api/ag-ui/follow-up\`` |
| `backend/src/second_brain/main.py` | `backend/src/second_brain/agents/workflow.py` | Re-runs workflow with combined text | WIRED | Lines 527-530: `stream = workflow_agent.run(messages, stream=True, ...)` |
| `mobile/app/(tabs)/inbox.tsx` | `backend/src/second_brain/api/inbox.py` | PATCH fetch for recategorize | WIRED | Lines 143-153: `fetch(\`${API_BASE_URL}/api/inbox/${itemId}/recategorize\`, {method: "PATCH", ...})` |
| `mobile/app/(tabs)/inbox.tsx` | `backend/src/second_brain/main.py` (respond endpoint) | `sendClarification` for pending item resolution | WIRED | Line 15 import, line 188: `const cleanup = sendClarification({threadId, bucket, ...})` |

---

## Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| CLAS-04 | 04.3-01, 04.3-02, 04.3-03 | When confidence < 0.6, Classifier asks the user a focused clarifying question before filing | SATISFIED (EXTENDED) | Phase 04.3 extends CLAS-04 to three distinct sub-flows: (1) truly misunderstood (< 0.3) triggers conversational follow-up via MISUNDERSTOOD event; (2) low-confidence (0.3-0.59) silently files as pending with "Filed (needs review)" toast; (3) mis-categorized resolved via inbox recategorize. The original CLAS-04 single clarification flow is now three distinct UX paths. |
| APPX-04 | 04.3-03, 04.3-04 | Conversation view opens when a specialist needs clarification, showing a focused chat | SATISFIED (EXTENDED) | Misunderstood captures show agent question bubble above text input (capture screen conversation mode). Inbox detail card provides bucket buttons for pending resolution and classified recategorization. Both are the "conversation/clarification view" per APPX-04. |

**Note on traceability:** REQUIREMENTS.md maps CLAS-04 and APPX-04 to "Phase 4" with status "Complete". Phase 04.3 extends these requirements with three distinct failure flows. The traceability table does not have a Phase 04.3 row — this is expected for an inserted phase. The requirements are satisfied at a higher fidelity than Phase 4 achieved.

**No orphaned requirements found** for Phase 04.3 (no requirements in REQUIREMENTS.md reference Phase 04.3 by name).

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `workflow.py` | 93, 396 | Stale doc comments reference `request_clarification` (comments only, not functional code) | Info | Comments in docstrings reference the old tool name. No functional impact — the actual logic uses `request_misunderstood`. |
| `mobile/app/(tabs)/inbox.tsx` | 313-318 | Bucket buttons not shown for `misunderstood` status items in detail card | Info | Intentional design: misunderstood items are resolved on the capture screen via conversation follow-up, not from inbox. The badge count also does not include `misunderstood` for the same reason. Consistent with phase design. |

No blockers. No stubs. No placeholder implementations found.

---

## Test Coverage

| Test Suite | Tests | Status |
|------------|-------|--------|
| `test_classification.py` | 14 tests (incl. 2 new `request_misunderstood` tests, 1 updated low-confidence test) | 14/14 PASSING |
| `test_inbox_api.py` | 5 new recategorize tests | 5/5 PASSING |
| All backend tests | 43 total | 43/43 PASSING |
| TypeScript type-check | `npx tsc --noEmit` | PASSING (exit 0) |

---

## Human Verification Required

### 1. Misunderstood Flow End-to-End

**Test:** Capture a genuinely ambiguous single word (e.g., "Aardvark") that should produce confidence < 0.3. Submit on the capture screen.
**Expected:** Agent question bubble appears above text input (e.g., "I'm not sure what you meant by 'Aardvark'. Could you tell me more?"); step dots animate; Send button becomes "Reply"; user types a reply and submits; follow-up round 2 triggers if still unclear; after 2 rounds shows "Couldn't classify. Check inbox later." and resets.
**Why human:** Requires live Azure OpenAI classifier to actually produce a < 0.3 confidence result on an ambiguous input.

### 2. Low-Confidence Silent Pending Flow

**Test:** Capture an ambiguous text that should produce confidence 0.3-0.59 (e.g., "Interesting conversation with Mike about moving to Austin").
**Expected:** Agent step dots animate normally; capture completes with "Filed (needs review) -> People (0.55)" toast (or similar); no HITL bucket buttons appear; screen auto-resets after 2.5 seconds; item appears in inbox with orange dot.
**Why human:** Requires live classifier to produce a low-confidence result; verifies the absence of the old HITL bucket button behavior.

### 3. Inbox Recategorize from Detail Card

**Test:** Open inbox screen; tap a classified item (green/no dot); verify detail card opens with the 4 bucket buttons showing current bucket highlighted blue; tap a different bucket.
**Expected:** "Moved to [NewBucket]" toast appears; detail card closes; item in list shows new bucket label with no status dot.
**Why human:** Requires live backend and Cosmos DB with classified inbox items.

### 4. Pending Item Resolution from Inbox

**Test:** Open inbox screen; tap an item with orange "Pending" label; verify detail card opens with "File to bucket" label; tap a bucket.
**Expected:** "Filed to [Bucket]" toast appears; detail card closes; item in list changes to classified status (no orange dot).
**Why human:** Requires live backend with pending inbox items.

---

## Gaps Summary

No gaps. All 19 observable truths verified, all 12 artifacts substantive and wired, all 7 key links confirmed, both requirements satisfied. 43/43 backend tests passing, TypeScript type check passing.

The two info-level findings are intentional design decisions:
1. Stale `request_clarification` doc comments in `workflow.py` — harmless, no functional code affected
2. `misunderstood` items show no bucket buttons in inbox detail card — correct by design; misunderstood resolution happens on the capture screen via the follow-up conversation flow

---

_Verified: 2026-02-23_
_Verifier: Claude (gsd-verifier)_
