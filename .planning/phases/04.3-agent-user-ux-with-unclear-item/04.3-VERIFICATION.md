---
phase: 04.3-agent-user-ux-with-unclear-item
verified: 2026-02-24T14:30:00Z
status: passed
score: 33/33 must-haves verified
re_verification:
  previous_status: passed
  previous_score: 24/24
  context: >
    Previous verification (2026-02-24) covered Plans 01-06 (24/24). Plans 07 and 08 were
    subsequently executed (commits 3ee7756, 73baefa, e0e39f2, e2d3795, db4eb66) to fix
    two RETEST-UAT gaps: 0.00 confidence scores and follow-up orphan duplication.
    This re-verification adds the 9 new must-haves from Plans 07 and 08 as full
    verifications, and confirms the original 24 as regression checks.
    Note: ROADMAP.md shows Plans 07/08 as [ ] (tracking bug — summaries and commits
    confirm execution; code is fully implemented).
  gaps_closed:
    - "When all four score params are 0.0, allScores are derived from bucket + confidence (not zero-filled)"
    - "When confidence is 0.0 with a valid bucket, it defaults to 0.75 to prevent zero-confidence documents"
    - "Debug logging shows actual received argument values for every classify_and_file call"
    - "classify_and_file return string includes inbox_doc_id UUID suffix"
    - "CLASSIFIED CustomEvent emitted by workflow adapter with inboxItemId, bucket, confidence"
    - "Follow-up CLASSIFIED path: copies classification to original, deletes orphan, updates bucket inboxRecordId"
    - "Follow-up MISUNDERSTOOD round 1: updates original clarificationText, deletes orphan, re-emits with original ID"
    - "Follow-up MISUNDERSTOOD round >= 2: marks original unresolved, deletes orphan, emits UNRESOLVED"
    - "Classifier instructions treat individual bucket scores as preferred but optional (not hard MUST)"
  gaps_remaining: []
  regressions: []
gaps: []
human_verification:
  - test: "High-confidence capture clean toast and auto-reset on device"
    expected: "Type a clear unambiguous thought (e.g., 'Buy groceries tomorrow'). Tap Send. Step dots animate. Header shows 'Filed -> Admin (0.90)' (or similar bucket), NOT verbose scores breakdown. Screen auto-resets after ~2.5 seconds."
    why_human: "Requires live Azure OpenAI to generate actual classifier output; verifies the buffering suppresses chain-of-thought in production"
  - test: "Low-confidence capture — non-zero confidence scores (not 0.00)"
    expected: "Type an ambiguous thought (e.g., 'Had coffee with Mike, he mentioned a project idea'). After Send: clean 'Filed (needs review) -> People (0.55)' toast (no verbose reasoning), no bucket buttons, auto-reset. CRITICALLY: confidence score must be non-zero (not 0.00). Item appears in inbox with orange dot."
    why_human: "Requires live classifier. Verifies _derive_scores_from_bucket fallback produces meaningful allScores when Agent Framework strips score params (the RETEST-UAT Test 2 root cause)"
  - test: "Misunderstood flow end-to-end with follow-up reply creating NO duplicate"
    expected: "Type 'Aardvark'. Agent question bubble appears. Inbox shows 1 item (not 2). Type clarifying reply (e.g., 'startup name') and tap Reply. If re-classified: 'Filed -> Projects (0.80)' toast, screen resets. Inbox shows the ORIGINAL item updated (not a new duplicate). Only 1 inbox item total."
    why_human: "Requires live Azure OpenAI. Verifies the post-stream orphan reconciliation in follow_up_misunderstood: CLASSIFIED event triggers copy-to-original + orphan delete (RETEST-UAT Tests 3 and 4)"
  - test: "Misunderstood flow end-to-end on device (question bubble)"
    expected: "Type something very unclear (e.g., 'Aardvark'). Tap Send. Agent question bubble appears above text input. Input cleared for reply. Send button shows 'Reply'. Type a reply, tap Reply -- step dots animate, re-classification runs. If still unclear after 2 rounds, shows 'Couldn't classify. Check inbox later.' toast and resets."
    why_human: "Requires live Azure OpenAI to produce < 0.3 confidence and emit MISUNDERSTOOD via function_result content inspection"
  - test: "Inbox detail card for classified item"
    expected: "Tap a classified (no dot) item. Detail card opens. Bucket/Confidence/Agent Chain metadata shown. 4 bucket buttons at bottom with 'Move to bucket' label; current bucket highlighted blue. Tap a different bucket: 'Moved to [Bucket]' toast, card closes, item updates."
    why_human: "Requires live backend and populated Cosmos DB; verifies the showBucketButtons guard removal works for classified items"
  - test: "Misunderstood item in inbox"
    expected: "After a failed misunderstood capture: inbox shows item with orange dot and 'Needs Clarification' label (not 'Pending'). Tap it: detail card shows 'Needs Clarification' status and the agent's question text (not 'Unknown bucket / N/A'). Badge count includes this item. Bucket buttons present with 'File to bucket' label."
    why_human: "Requires live backend and a genuinely misunderstood item in Cosmos DB"
---

# Phase 04.3: agent-user UX with unclear item — Verification Report

**Phase Goal:** Three distinct classification failure flows: misunderstood (conversational follow-up), low-confidence (silent pending filing), and mis-categorized (inbox recategorize)
**Verified:** 2026-02-24
**Status:** PASSED
**Re-verification:** Yes — after Plans 07 and 08 gap closure (RETEST-UAT findings)

---

## Re-Verification Context

The previous VERIFICATION.md (2026-02-24) covered Plans 01-06 and passed 24/24. The RETEST-UAT
(04.3-RETEST-UAT.md, 2026-02-24) then found 4 issues:

- **Test 2** (major): All ambiguous inputs evaluated at 0.00 confidence — Agent Framework strips
  score params, `classify_and_file` builds zero-filled `allScores`.
- **Tests 3 and 4** (major): Follow-up reply creates NEW inbox doc instead of updating original.
  Original stays stuck as 'Needs clarification' forever; duplicate appears.
- **Test 7** (blocker): Compound of above two — every classification broken by 0.00 scores,
  plus inbox full of orphaned misunderstood duplicates.

Plans 07 and 08 were created and executed to close these gaps:

- **Plan 07** (commits `3ee7756`, `73baefa`): `_derive_scores_from_bucket` helper + score
  validation/fallback in `classify_and_file`. Confidence 0.0 defaults to 0.75. Classifier
  instruction softened from MUST to preferred for bucket scores.
- **Plan 08** (commits `e0e39f2`, `e2d3795`, `db4eb66`): `classify_and_file` return string
  includes `| {inbox_doc_id}` suffix. Workflow adapter emits CLASSIFIED CustomEvent. Follow-up
  endpoint has 3-path post-stream orphan reconciliation (CLASSIFIED, MISUNDERSTOOD round 1,
  MISUNDERSTOOD round >= 2).

This re-verification treats the 9 Plan 07/08 must-haves as new full verifications (exists +
substantive + wired) and the original 24 must-haves as regression checks.

---

## Goal Achievement

### Observable Truths

#### Original 24 Truths (Regression Check)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | Classifier agent distinguishes misunderstood / low-confidence / high-confidence | VERIFIED | `classifier.py`: three-tier thresholds in instructions (< 0.3 misunderstood, 0.3-0.59 low-confidence, >= 0.6 high-confidence) at lines 91-100 |
| 2  | Misunderstood input creates inbox doc with status 'misunderstood' and clarificationText | VERIFIED | `classification.py` lines 218-236: `request_misunderstood` creates `InboxDocument(status="misunderstood", clarificationText=question_text)` |
| 3  | Low-confidence (0.3-0.59) files as pending with "Filed (needs review)" return string | VERIFIED | `classification.py` line 146: `status = "pending"` when `confidence < self._threshold`; line 190: `"Filed (needs review) \u2192 ..."` |
| 4  | MISUNDERSTOOD custom event emitted (distinct from HITL_REQUIRED) | VERIFIED | `workflow.py` lines 408-424: `CustomEvent(name="MISUNDERSTOOD", ...)` emitted when `detected_tool == "request_misunderstood"` |
| 5  | request_clarification removed; request_misunderstood is the misunderstood tool | VERIFIED | `classification.py` has no `request_clarification`; `classifier.py` tools list at line 138-142 includes `request_misunderstood` only |
| 6  | Classified inbox item can be moved via PATCH request | VERIFIED | `inbox.py`: `@router.patch("/api/inbox/{item_id}/recategorize")` |
| 7  | Recategorize creates new bucket doc, updates inbox, deletes old bucket (in order) | VERIFIED | `inbox.py`: Step 1 create, Step 2 upsert, Step 3 delete (non-fatal) |
| 8  | Recategorize to same bucket is a no-op | VERIFIED | `inbox.py`: early return when `old_bucket == body.new_bucket`; test `test_recategorize_same_bucket_noop` passes |
| 9  | Invalid bucket names return 400 | VERIFIED | `inbox.py`: `HTTPException(status_code=400)` on invalid bucket; test passes |
| 10 | Non-existent inbox items return 404 | VERIFIED | `inbox.py`: `HTTPException(status_code=404)` on CosmosResourceNotFoundError; test passes |
| 11 | Misunderstood captures trigger conversational follow-up on capture screen | VERIFIED | `text.tsx`: `onMisunderstood` sets `agentQuestion`, `misunderstoodInboxItemId`, `followUpRound=1`, clears input |
| 12 | Agent question bubble visible above text input | VERIFIED | `text.tsx`: `{agentQuestion && <View style={styles.agentQuestionBubble}>...}` renders above `<TextInput>` |
| 13 | User types reply in cleared input | VERIFIED | `text.tsx`: `setThought("")` on MISUNDERSTOOD; placeholder changes to "Add more context..." when `followUpRound > 0` |
| 14 | Re-classification runs on original text + clarification combined | VERIFIED | `main.py` lines 517-521: `combined_text = f"{original_text}\n\n---\nUser clarification: {body.follow_up_text}"` |
| 15 | Max 2 follow-up rounds; unresolved after 2 goes to inbox with status 'unresolved' | VERIFIED | `main.py` lines 554-562: `body.follow_up_round >= 2` intercepts MISUNDERSTOOD, sets `misunderstood_detected=True`; lines 711-752: marks original "unresolved", emits UNRESOLVED event |
| 16 | Follow-up endpoint streams SSE events | VERIFIED | `main.py`: `StreamingResponse(generate(), media_type="text/event-stream")` at line 756 |
| 17 | Inbox list shows orange dot for pending/low_confidence/misunderstood, red for unresolved, no dot for classified | VERIFIED | `InboxItem.tsx`: `getStatusDotColor` switch — orange for pending/low_confidence/misunderstood, red for unresolved, null otherwise |
| 18 | Tapping any item opens detail card with bucket buttons | VERIFIED | `inbox.tsx`: all items call `setSelectedItem(item)`; IIFE always renders bucket buttons (no `showBucketButtons` guard) |
| 19 | Tapping a different bucket calls recategorize endpoint and shows toast | VERIFIED | `inbox.tsx`: `handleRecategorize` calls `PATCH /api/inbox/{itemId}/recategorize`, sets `recategorizeToast` |
| 20 | Classifier chain-of-thought reasoning is buffered and NOT yielded to SSE stream | VERIFIED | `workflow.py` line 156: `_is_classifier_text` checks `author_name == "classifier"` and all contents `type == "text"`; lines 338-340, 366-368: `classifier_buffer += update.text; continue` — never yields buffered text |
| 21 | Only the clean tool result line is yielded to the SSE stream for Classifier output | VERIFIED | `workflow.py` lines 380-405: after stream loop, `clean_result` constructed from `detected_tool_args` (bucket + confidence) and yielded as single `AgentResponseUpdate`; reasoning discarded |
| 22 | Misunderstood detection uses function_call.name inspection (not regex on streamed text) | VERIFIED | `workflow.py` lines 170-196: `_extract_function_call_info` checks `content.type == "function_call"` and `name in _CLASSIFICATION_TOOLS`; called in `_process_update` at lines 228-232 |
| 23 | Inbox detail card shows bucket buttons for ALL item statuses (no showBucketButtons guard) | VERIFIED | `inbox.tsx` IIFE has no early return; `isPendingItem` includes `misunderstood` and `unresolved`; bucket section always rendered |
| 24 | Misunderstood items show "Needs Clarification" label (not "Pending") with orange styling | VERIFIED | `InboxItem.tsx`: `isMisunderstood` flag separate from `isPending`; `bucketLabel = isMisunderstood ? "Needs Clarification" : ...`; `bucketPending` style for both `isPending` and `isMisunderstood` |

#### 9 Plan 07/08 Must-Haves (Full Verification)

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 25 | When LLM provides valid four bucket scores, they are used as-is in allScores | VERIFIED | `classification.py` lines 107-121: `scores_provided` flag true when any score != 0.0; `all_scores = {"People": people_score, ...}` used directly |
| 26 | When four bucket scores are all 0.0 (Agent Framework stripped them), allScores are derived from bucket + confidence | VERIFIED | `classification.py` lines 122-129: `all_scores = _derive_scores_from_bucket(bucket, confidence)` with warning log when `scores_provided == False` |
| 27 | When confidence itself is 0.0 but a valid bucket was chosen, a default confidence (0.75) is applied | VERIFIED | `classification.py` lines 99-104: `if confidence == 0.0 and bucket in VALID_BUCKETS: confidence = 0.75` with warning log |
| 28 | Debug logging shows actual received argument values for every classify_and_file call | VERIFIED | `classification.py` lines 77-88: `logger.debug("classify_and_file called: bucket=%s confidence=%.4f ...")` at method entry |
| 29 | Classifier instructions treat individual bucket scores as preferred but optional | VERIFIED | `classifier.py` lines 126-129: Rule 4 reads "Provide ALL FOUR bucket scores ... when possible. If omitted, scores are derived from your confidence and chosen bucket" |
| 30 | classify_and_file return string includes inbox_doc_id UUID suffix | VERIFIED | `classification.py` lines 189-191: `return f"Filed (needs review) \u2192 {bucket} ({confidence:.2f}) \| {inbox_doc_id}"` and `return f"Filed \u2192 {bucket} ({confidence:.2f}) \| {inbox_doc_id}"` |
| 31 | Workflow adapter emits CLASSIFIED custom event with inboxItemId, bucket, confidence | VERIFIED | `workflow.py` lines 425-435: `elif detected_tool == "classify_and_file": ... yield CustomEvent(name="CLASSIFIED", value={"inboxItemId": classified_inbox_id, "bucket": ..., "confidence": ...})` |
| 32 | Follow-up reply that successfully classifies updates the ORIGINAL inbox item (not creates a new one) | VERIFIED | `main.py` lines 643-709: CLASSIFIED path reads orphan doc, copies `classificationMeta`/`filedRecordId`/`title`/`status` to original via `upsert_item`, deletes orphan, updates bucket `inboxRecordId` |
| 33 | Follow-up reply that triggers request_misunderstood at round 1 updates the original item's clarificationText and deletes the orphan | VERIFIED | `main.py` lines 564-628: MISUNDERSTOOD round 1 updates `existing["clarificationText"]`, calls `upsert_item`, deletes orphan, re-emits MISUNDERSTOOD with `body.inbox_item_id` (not orphan ID) |

**Score:** 33/33 truths verified

---

## Required Artifacts

### Original Artifacts (Regression)

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/tools/classification.py` | `request_misunderstood` tool, pending status for low-confidence, score validation/fallback, debug logging | VERIFIED | 260 lines; `_derive_scores_from_bucket` at line 27; `classify_and_file` with fallback at lines 99-129; `request_misunderstood` at line 193; both return strings include `\| {inbox_doc_id}` |
| `backend/src/second_brain/agents/classifier.py` | Three-tier decision flow, tools list with `request_misunderstood`, softened Rule 4 | VERIFIED | 144 lines; "Classification Decision Flow" at lines 90-100; Rule 4 includes "when possible. If omitted, scores are derived" at line 128 |
| `backend/src/second_brain/api/inbox.py` | `PATCH /api/inbox/{item_id}/recategorize` endpoint | VERIFIED | `recategorize_inbox_item` present; full create-update-delete logic |
| `backend/src/second_brain/main.py` | `POST /api/ag-ui/follow-up` with 3-path orphan reconciliation, UNRESOLVED event | VERIFIED | `follow_up_misunderstood` at line 486; CLASSIFIED path at line 643; MISUNDERSTOOD round 1 at line 564; MISUNDERSTOOD round >= 2 at line 711 |
| `mobile/app/capture/text.tsx` | Conversation mode UI, `handleFollowUpSubmit`, `followUpRound` state | VERIFIED | `followUpRound` state; agent question bubble; `sendFollowUp` called in `handleFollowUpSubmit` |
| `mobile/lib/ag-ui-client.ts` | `sendFollowUp`, MISUNDERSTOOD/UNRESOLVED event handling | VERIFIED | `sendFollowUp`; MISUNDERSTOOD handler; UNRESOLVED handler |
| `mobile/app/(tabs)/inbox.tsx` | Detail card, `handleRecategorize`, bucket buttons for all statuses | VERIFIED | Both handlers present; bucket buttons always rendered in IIFE; `isPendingStatus` includes `"misunderstood"` |
| `mobile/components/InboxItem.tsx` | Color-coded status dots, `isMisunderstood` flag with "Needs Clarification" label | VERIFIED | `getStatusDotColor`; `isMisunderstood`; "Needs Clarification" label |

### Gap-Closure Artifacts (Plan 07/08 — Full Verification)

| Artifact | Provides | Status | Details |
|----------|----------|--------|---------|
| `backend/src/second_brain/tools/classification.py` | `_derive_scores_from_bucket`, score validation, confidence 0.0 fallback, inbox_doc_id in return | VERIFIED | `_derive_scores_from_bucket` at line 27; `scores_provided` check at lines 107-112; confidence fallback at lines 99-104; UUID suffix in both return strings at lines 190-191 |
| `backend/src/second_brain/agents/workflow.py` | CLASSIFIED CustomEvent, `classified_inbox_id` 4-tuple in `_process_update` | VERIFIED | `classified_inbox_id` initialized at line 276; `_process_update` returns 4-tuple at line 222; CLASSIFIED event at lines 425-435 |
| `backend/src/second_brain/main.py` | Post-stream orphan reconciliation (3 paths) in `follow_up_misunderstood` | VERIFIED | `classified_event_data` tracker at line 539; CLASSIFIED reconciliation at lines 643-709; MISUNDERSTOOD round 1 at lines 564-628; unresolved at lines 711-752 |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `classifier.py` | `classification.py` | `request_misunderstood` in tools list | WIRED | `classification_tools.request_misunderstood` in tools list at line 140 |
| `workflow.py` | SSE stream | `_is_classifier_text` gates buffer; clean result constructed from tool args | WIRED | Lines 338-340: text-only Classifier updates buffered; lines 380-405: clean result from `detected_tool_args` yielded at stream end |
| `workflow.py` | MISUNDERSTOOD detection | `_extract_function_call_info` on every update; `_extract_inbox_id_from_result` for UUID | WIRED | Lines 228-246: `_process_update` inspects `function_call.name` for tool detection and `function_result` for inbox_id extraction |
| `workflow.py` | CLASSIFIED event | `_extract_inbox_id_from_result` on `classify_and_file` function_result | WIRED | Lines 240-244: `classified_inbox_id` extracted from `function_result` content; lines 425-435: CLASSIFIED event emitted at stream end |
| `mobile/app/capture/text.tsx` | `mobile/lib/ag-ui-client.ts` | `sendFollowUp` called in `handleFollowUpSubmit` | WIRED | `sendFollowUp({...})` called in follow-up handler |
| `mobile/lib/ag-ui-client.ts` | `backend/src/second_brain/main.py` | POST to `/api/ag-ui/follow-up` | WIRED | `${API_BASE_URL}/api/ag-ui/follow-up` in sendFollowUp |
| `ag-ui-client.ts` `onComplete` | `text.tsx` `resetState` | `RUN_FINISHED` triggers `onComplete(result)` only when `!hitlTriggered` | WIRED | `attachCallbacks` line: `if (!hitlTriggered) callbacks.onComplete(result)`; `text.tsx`: `setTimeout(resetState, AUTO_RESET_MS)` |
| `mobile/app/(tabs)/inbox.tsx` | `backend/src/second_brain/api/inbox.py` | PATCH fetch for recategorize | WIRED | `fetch(\`${API_BASE_URL}/api/inbox/${itemId}/recategorize\`, {method: "PATCH",...})` |
| `main.py` follow-up CLASSIFIED path | CosmosDB Inbox + bucket containers | `upsert_item` on original, `delete_item` on orphan, `upsert_item` on bucket doc | WIRED | Lines 643-709: reads orphan, reads original, upserts original, deletes orphan, reads bucket doc, upserts bucket doc |

---

## Requirements Coverage

| Requirement | Source Plans | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| CLAS-04 | 04.3-01, 04.3-02, 04.3-03, 04.3-05, 04.3-07, 04.3-08 | When confidence < 0.6, Classifier asks the user a focused clarifying question before filing | SATISFIED (EXTENDED) | Phase 04.3 splits into three sub-flows: (1) truly misunderstood (< 0.3) triggers conversational follow-up via MISUNDERSTOOD event; (2) low-confidence (0.3-0.59) silently files as pending with non-zero scores (Plan 07 fallback); (3) mis-categorized resolved via inbox recategorize. Follow-up now updates original item without creating duplicates (Plan 08 orphan reconciliation). |
| APPX-04 | 04.3-03, 04.3-04, 04.3-06, 04.3-08 | Conversation view opens when a specialist needs clarification, showing a focused chat | SATISFIED (EXTENDED) | Misunderstood captures show agent question bubble above text input on capture screen. Inbox detail card (bucket buttons for all statuses) is the clarification view for pending/misunderstood resolution. Follow-up round 1 no longer duplicates items — original inbox item's clarificationText is updated in place. |

**No orphaned requirements.** REQUIREMENTS.md maps CLAS-04 and APPX-04 to "Phase 4" with
status "Complete". Phase 04.3 is an inserted phase extending these requirements — no Phase 04.3
row in the traceability table is expected.

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `workflow.py` | 438-441 | Log warning when Classifier stream ends without calling any classification tool | Info | Intentional defensive fallback. Correct behavior — indicates an unexpected LLM response, does not block any of the three target flows. |
| `text.tsx` | HITL bucket buttons (`hitlContainer`) | HITL bucket buttons still present alongside misunderstood conversation mode | Info | `hitlContainer` renders only when `hitlQuestion !== null`. For misunderstood flow, only `agentQuestion` is set. The two flows are mutually exclusive by state. No user-visible conflict. |
| `main.py` | 643 | Post-stream reconciliation only runs when `classified_event_data` is truthy AND cosmos_manager is available | Info | Intentional — if Cosmos is unavailable, reconciliation silently skips. The orphaned doc is harmless (extra data). The client still receives the correct SSE stream. |

No blockers. No stubs. No placeholder implementations found in any gap-closure code.

---

## Test Coverage

| Test Suite | Tests | Status |
|------------|-------|--------|
| `test_classification.py` | 17 tests (incl. `test_request_misunderstood_*` x2, `test_classify_and_file_low_confidence`, `test_classify_and_file_confidence_clamping_*` x2) | 17/17 PASSING |
| `test_inbox_api.py` | 5 recategorize tests | 5/5 PASSING |
| `test_inbox_delete.py` | 5 delete tests | 5/5 PASSING |
| `test_cosmos_crud.py` | 7 CRUD tests | 7/7 PASSING |
| `test_auth.py` | 3 auth tests | 3/3 PASSING |
| `test_health.py` | 1 health test | 1/1 PASSING |
| `test_integration.py` | 3 integration tests | 3/3 PASSING |
| **All backend tests** | **43 total** | **43/43 PASSING** |

All 43 backend tests pass after Plans 07 and 08 changes. Two test updates were required:
- `test_classify_and_file_confidence_clamping_negative`: Updated to expect 0.75 (not 0.0) since confidence 0.0 now defaults to 0.75 (Plan 07).
- Return string assertions: Changed to `startswith()` + UUID suffix validation (Plan 08).

---

## Human Verification Required

### 1. Low-Confidence Capture — Non-Zero Confidence Scores

**Test:** Type an ambiguous thought (e.g., "Had coffee with Mike, he mentioned a project idea") and tap Send.
**Expected:** Step dots animate. Clean "Filed (needs review) -> People (0.55)" toast (NOT verbose reasoning, NOT "0.00" confidence). No bucket buttons appear. Screen auto-resets after ~2.5 seconds. Item appears in inbox with orange dot and a non-zero confidence value.
**Why human:** Requires live classifier. The 0.00 score issue (RETEST-UAT Test 2) is fixed by Plan 07's `_derive_scores_from_bucket` fallback, but this can only be verified end-to-end with a live Azure OpenAI call to confirm the Agent Framework is actually stripping params in production.

### 2. Misunderstood Follow-Up — No Duplicate Items

**Test:** Type "Aardvark" and tap Send. Confirm agent question bubble appears. WITHOUT replying yet, check the Inbox tab — exactly 1 item should appear. Return to capture, type "It's my friend's startup name", tap Reply.
**Expected:** Re-classification runs. If successful: "Filed -> Projects (0.80)" toast, screen resets. Open Inbox: the ORIGINAL "Aardvark" item is now classified (blue dot or no dot), showing the correct bucket metadata. No second "Aardvark" item. Total Inbox items for "Aardvark" = 1.
**Why human:** Requires live Azure OpenAI. Verifies the CLASSIFIED post-stream orphan reconciliation path in `follow_up_misunderstood` (RETEST-UAT Tests 3 and 4 root cause). Cannot be unit-tested without mocking the full Cosmos + workflow stack.

### 3. High-Confidence Capture: Clean Toast and Auto-Reset

**Test:** Type a clear, unambiguous thought (e.g., "Buy groceries tomorrow") and tap Send.
**Expected:** Step dots animate through Orchestrator and Classifier. Header shows clean "Filed -> Admin (0.90)" (NOT a wall of classifier reasoning text). Screen auto-resets after ~2.5 seconds.
**Why human:** Requires live Azure OpenAI to produce real classifier output. Verifies `_is_classifier_text` buffering correctly identifies and suppresses Classifier text-only deltas while yielding the clean result constructed from tool args.

### 4. Misunderstood Flow End-to-End

**Test:** Type a completely ambiguous single word (e.g., "Aardvark") and tap Send.
**Expected:** Instead of bucket buttons or a filed toast, an agent question bubble appears above the text input (blue left border, question text inside). Input is cleared. Send button shows "Reply". "Reply below (follow-up 1 of 2)" hint text visible. Type "It's my friend's startup name" and tap Reply. If re-classified: "Filed -> Projects (0.80)" toast and auto-reset. If still unclear: another question (follow-up 2 of 2). After 2 failed rounds: "Couldn't classify. Check inbox later." toast and state reset.
**Why human:** Requires live Azure OpenAI producing < 0.3 confidence result. Verifies `_has_misunderstood_tool_call` / `_extract_misunderstood_from_content` detect the `request_misunderstood` tool call in function_result content items.

### 5. Inbox Detail Card for Classified Item

**Test:** Open Inbox tab. Tap a classified item (no status dot).
**Expected:** Detail card opens showing Bucket / Confidence / Agent Chain metadata (not "Unknown"). 4 bucket buttons at bottom with "Move to bucket" label. Current bucket highlighted in blue. Tap a different bucket: "Moved to [Bucket]" toast, card closes, item updates in list.
**Why human:** Requires live backend with classified Cosmos DB items. Verifies removal of `showBucketButtons` guard.

### 6. Misunderstood Item in Inbox

**Test:** After a misunderstood capture, open Inbox.
**Expected:** Item shows orange dot and "Needs Clarification" label (not "Pending"). Badge count includes this item. Tap item: detail card shows "Needs Clarification" status (orange text) and the agent's original question under "Agent Question" (not "Unknown" bucket / "N/A"). Bucket buttons present with "File to bucket" label. Tap a bucket: item resolved.
**Why human:** Requires live backend with a misunderstood item in Cosmos DB.

---

## Gaps Summary

No gaps. All 33 observable truths verified (24 original regression checks + 9 Plan 07/08
must-haves). All 11 key artifacts substantive and wired. All 9 key links confirmed.
Requirements CLAS-04 and APPX-04 satisfied. 43/43 backend tests passing.

The 4 RETEST-UAT issues were each closed by targeted code changes in Plans 07 and 08:

- **Test 2 (0.00 confidence scores):** Fixed by Plan 07's `_derive_scores_from_bucket` helper.
  When the Agent Framework strips the four score params (they arrive as 0.0), `classify_and_file`
  now derives synthetic allScores from `bucket + confidence` rather than using zero-filled values.
  When `confidence` itself is 0.0 with a valid bucket, it defaults to 0.75. Debug logging confirms
  what values are actually received by the tool.

- **Tests 3 and 4 (follow-up creates duplicate):** Fixed by Plan 08's three-part change.
  `classify_and_file` return string now includes `| {inbox_doc_id}` UUID suffix. The workflow
  adapter extracts this UUID and emits a CLASSIFIED CustomEvent (not yielded to client, used
  internally only). The follow-up endpoint intercepts CLASSIFIED events post-stream and
  copies classification metadata to the original inbox item, deletes the orphaned doc, and
  updates the bucket doc's `inboxRecordId` to point to the original.

- **Test 7 (compound):** Resolved by Tests 2 and 3/4 fixes above.

**Note on ROADMAP.md tracking:** The roadmap shows Plans 07 and 08 as `[ ]` (unchecked), but
this is a tracking artifact. Summaries `04.3-07-SUMMARY.md` and `04.3-08-SUMMARY.md` both exist.
Git commits `3ee7756`, `73baefa`, `e0e39f2`, `e2d3795`, and `db4eb66` are all verified in git
log. Code is fully implemented.

---

_Verified: 2026-02-24_
_Verifier: Claude (gsd-verifier)_
_Re-verification after RETEST-UAT gap closure (Plans 07 and 08)_
