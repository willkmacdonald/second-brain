---
status: diagnosed
phase: 04.3-agent-user-ux-with-unclear-item
source: [04.3-01-SUMMARY.md, 04.3-02-SUMMARY.md, 04.3-03-SUMMARY.md, 04.3-04-SUMMARY.md]
started: 2026-02-24T04:15:00Z
updated: 2026-02-24T04:50:00Z
---

## Current Test

[testing complete]

## Tests

### 1. High-Confidence Capture Files Silently
expected: Type a clear, unambiguous thought (e.g., "Buy groceries tomorrow") and tap Send. The agent chain processes it, and you see a "Filed -> Admin (0.xx)" result with NO clarification question or bucket buttons. The capture screen auto-resets after ~2.5 seconds.
result: issue
reported: "After deploy, bucket buttons are gone (fixed). But screen still does not auto-reset -- stays on result screen. Also classifier reasoning text is streaming through (verbose scores breakdown) instead of just the 'Filed -> Admin (0.90)' tool result."
severity: major

### 2. Low-Confidence Capture Files Silently as Pending
expected: Type an ambiguous thought that could fit multiple buckets (e.g., "Had coffee with Mike, he mentioned a new project idea"). After sending, the item files silently -- you should see a "Filed (needs review)" toast instead of bucket buttons or a clarification question. The screen auto-resets. No HITL interruption.
result: issue
reported: "Core behavior correct -- no clarification question asked, silently filed with best guess (People 0.55). But same UI issues as Test 1: verbose classifier reasoning text streams through instead of just 'Filed (needs review)', screen does not auto-reset, bucket buttons may still be showing."
severity: minor

### 3. Misunderstood Capture Triggers Conversation
expected: Type something very unclear (e.g., a single ambiguous word like "Aardvark" or random text). After sending, instead of filing or showing bucket buttons, the capture screen shows a conversational question from the agent above the text input (in a blue-bordered bubble). The input is cleared for your reply. You see "Reply" on the send button and "follow-up 1 of 2" hint text.
result: issue
reported: "Classifier correctly asked open-ended question ('I'm not quite sure what you meant by Aardvark. Could you tell me more?'). But UI shows old HITL bucket buttons instead of entering conversation mode -- no agent question bubble, text input not cleared for reply, no 'Reply' button or 'follow-up 1 of 2' hint. MISUNDERSTOOD event not triggering conversation mode on capture screen."
severity: major

### 4. Follow-Up Reply Re-Classifies
expected: After receiving the agent's question (from Test 3), type a clarifying reply (e.g., "It's the name of my friend's new startup project") and tap Reply. The system re-classifies with the combined context. If successful, you see a "Filed -> Projects" result and the screen resets.
result: skipped
reason: Blocked by Test 3 failure — conversation mode never entered, no reply possible

### 5. Inbox Status Dots
expected: Open the Inbox tab. Items that were filed as pending (from Test 2) show an orange dot next to them. Items filed with high confidence show no dot. If any unresolved items exist, they show a red dot.
result: pass

### 6. Inbox Detail Card for Classified Item
expected: Tap a classified (no dot) item in the inbox. A detail card modal opens showing the full text, bucket, confidence, agent chain, and timestamp. At the bottom, 4 bucket buttons appear (People, Projects, Ideas, Admin). The current bucket is highlighted in blue.
result: issue
reported: "No bucket buttons showing in the detail card for classified items"
severity: major

### 7. Recategorize a Classified Item
expected: From the detail card (Test 6), tap a different bucket button (e.g., if currently "Admin", tap "Projects"). The modal closes, the item's bucket label updates in the list, and a "Moved to Projects" toast appears briefly.
result: skipped
reason: Blocked by Test 6 failure — no bucket buttons on classified items to tap

### 8. Inbox Detail Card for Pending Item
expected: Tap a pending (orange dot) item in the inbox. A detail card modal opens (NOT the conversation screen). The card shows 4 bucket buttons labeled "File to bucket". Tapping a bucket files the item and removes the orange dot.
result: pass

### 9. Inbox Badge Counts Pending and Unresolved
expected: The Inbox tab badge count reflects the number of pending AND unresolved items combined. After resolving a pending item via bucket buttons, the badge count decreases.
result: issue
reported: "Badge works for pending items. But misunderstood items (e.g., Aardvark) show in inbox with 'unknown' bucket, no confidence score, no agent chain -- just dangling. Badge may not count misunderstood status. Misunderstood inbox items have broken display due to classificationMeta=None."
severity: minor

## Summary

total: 9
passed: 2
issues: 5
pending: 0
skipped: 2

## Gaps

- truth: "High-confidence capture files silently with no bucket buttons and auto-resets"
  status: failed
  reason: "User reported: Screen does not auto-reset after filing -- stays on result. Classifier reasoning text streams through (verbose scores) instead of just tool result. Bucket buttons fixed after deploy."
  severity: major
  test: 1
  root_cause: "Echo filter in workflow.py _is_orchestrator_text only suppresses Orchestrator text. Classifier reasoning tokens (chain-of-thought before tool call) pass through unfiltered, stream as TextMessageContentEvent to client. Auto-reset fires but delayed by streaming time, and toast shows verbose text instead of clean tool result."
  artifacts:
    - path: "backend/src/second_brain/agents/workflow.py"
      issue: "_is_orchestrator_text filter only checks author_name == Orchestrator; Classifier text passes through"
  missing:
    - "Add Classifier text filter in _stream_updates -- buffer Classifier text and only yield content matching tool result patterns (Filed/Misunderstood regexes)"
  debug_session: ".planning/debug/capture-no-auto-reset.md"

- truth: "Low-confidence capture files silently as pending with 'Filed (needs review)' toast and auto-resets"
  status: failed
  reason: "User reported: Core behavior correct (no HITL question, silently filed People 0.55). But verbose reasoning streams through, screen does not auto-reset, bucket buttons may still show."
  severity: minor
  test: 2
  root_cause: "Same root cause as Test 1 -- Classifier reasoning text passes through echo filter. Core low-confidence silent filing behavior is correct."
  artifacts:
    - path: "backend/src/second_brain/agents/workflow.py"
      issue: "Same echo filter issue as Test 1"
  missing:
    - "Fixed by same change as Test 1"
  debug_session: ".planning/debug/capture-no-auto-reset.md"

- truth: "Misunderstood capture enters conversation mode with agent question bubble and text reply input"
  status: failed
  reason: "User reported: Classifier correctly asked open-ended question but UI shows old HITL bucket buttons instead of conversation mode. No agent question bubble, text input not cleared, no Reply button or follow-up hint. MISUNDERSTOOD event not triggering conversation mode."
  severity: major
  test: 3
  root_cause: "Regex-based detection of request_misunderstood tool output in streamed text never matches because tool return values are consumed internally by the LLM -- they don't appear in AgentResponseUpdate.text. The LLM's text response is just the question (no 'Misunderstood → uuid |' prefix). Since _MISUNDERSTOOD_RE doesn't match and saw_request_info=True (non-autonomous agent always fires request_info), the fallback branch emits HITL_REQUIRED instead of MISUNDERSTOOD."
  artifacts:
    - path: "backend/src/second_brain/agents/workflow.py"
      issue: "_stream_updates regex detection of misunderstood text never matches -- tool results don't appear in update.text"
    - path: "backend/src/second_brain/agents/classifier.py"
      issue: "Classifier instructions don't require echoing exact tool output format"
  missing:
    - "Detect request_misunderstood via function_call content type in AgentResponseUpdate instead of regex-matching text output"
  debug_session: ".planning/debug/misunderstood-no-conversation-mode.md"

- truth: "Inbox detail card for classified items shows 4 bucket buttons with current bucket highlighted"
  status: failed
  reason: "User reported: No bucket buttons showing in the detail card for classified items"
  severity: major
  test: 6
  root_cause: "showBucketButtons condition in inbox.tsx only includes pending/low_confidence/classified statuses. Items with other statuses (unclassified from mark_as_junk, misunderstood, unresolved) have no status dot and look identical to classified items but get no bucket buttons."
  artifacts:
    - path: "mobile/app/(tabs)/inbox.tsx"
      issue: "showBucketButtons condition too narrow -- only checks pending/low_confidence/classified, misses other statuses"
  missing:
    - "Change showBucketButtons to always true (or selectedItem !== null). Use isPendingItem/isClassifiedItem only for label text and handler selection, not visibility."
  debug_session: ".planning/debug/inbox-no-classified-bucket-buttons.md"

- truth: "Inbox badge counts pending AND unresolved items; misunderstood items display correctly"
  status: failed
  reason: "User reported: Badge works for pending. But misunderstood items (Aardvark) show as 'unknown' bucket with no confidence or agent chain -- dangling in inbox with broken display due to classificationMeta=None."
  severity: minor
  test: 9
  root_cause: "Four frontend issues: (1) isPendingStatus in badge count excludes 'misunderstood', (2) detail card shows 'Unknown' bucket for null classificationMeta instead of clarificationText, (3) bucket buttons not shown for misunderstood items (same as Test 6), (4) list label says 'Pending' instead of 'Needs Clarification' for misunderstood."
  artifacts:
    - path: "mobile/app/(tabs)/inbox.tsx"
      issue: "isPendingStatus excludes misunderstood; detail card has no conditional rendering for null classificationMeta"
    - path: "mobile/components/InboxItem.tsx"
      issue: "List label says 'Pending' for misunderstood items instead of 'Needs Clarification'"
  missing:
    - "Add 'misunderstood' to isPendingStatus in badge count"
    - "Add conditional detail card rendering: show clarificationText for misunderstood items instead of Unknown metadata"
    - "Change InboxItem label from 'Pending' to 'Needs Clarification' for misunderstood status"
  debug_session: ".planning/debug/misunderstood-inbox-display.md"
