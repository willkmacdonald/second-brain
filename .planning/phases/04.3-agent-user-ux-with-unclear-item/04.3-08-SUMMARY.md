---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 08
subsystem: api
tags: [cosmos-db, sse, orphan-reconciliation, follow-up, workflow-adapter]

# Dependency graph
requires:
  - phase: 04.3-agent-user-ux-with-unclear-item
    plan: 07
    provides: "Score validation/fallback logic in classify_and_file"
provides:
  - "classify_and_file return string includes inbox_doc_id UUID suffix"
  - "CLASSIFIED CustomEvent emitted by workflow adapter with inbox ID"
  - "Post-stream orphan reconciliation in follow-up endpoint (3 paths)"
affects: [04.3-retest-uat]

# Tech tracking
tech-stack:
  added: []
  patterns: ["post-stream orphan reconciliation pattern for follow-up workflows"]

key-files:
  created: []
  modified:
    - backend/src/second_brain/tools/classification.py
    - backend/src/second_brain/agents/workflow.py
    - backend/src/second_brain/main.py
    - backend/tests/test_classification.py

key-decisions:
  - "CLASSIFIED event NOT yielded to client -- used internally for post-stream reconciliation only"
  - "Round 1 MISUNDERSTOOD re-emitted with ORIGINAL inbox_item_id (not orphan) to maintain client follow-up chain"
  - "Non-fatal error handling throughout reconciliation -- orphaned docs are harmless"

patterns-established:
  - "Post-stream orphan reconciliation: let workflow create docs freely, then copy metadata to original and clean up"
  - "| {uuid} separator convention for tool return strings enabling UUID extraction via shared regex"

requirements-completed: [CLAS-04, APPX-04]

# Metrics
duration: 3min
completed: 2026-02-24
---

# Phase 04.3 Plan 08: Follow-Up Orphan Reconciliation Summary

**Post-stream orphan reconciliation for follow-up endpoint: classify_and_file returns inbox_doc_id, workflow emits CLASSIFIED event, endpoint copies metadata to original and deletes orphans**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-24T14:04:51Z
- **Completed:** 2026-02-24T14:07:52Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- classify_and_file return string now includes ` | {inbox_doc_id}` UUID suffix for extraction by workflow adapter
- Workflow adapter emits CLASSIFIED CustomEvent with inboxItemId, bucket, and confidence at stream end
- Follow-up endpoint handles 3 reconciliation paths: CLASSIFIED (copy to original), MISUNDERSTOOD round 1 (update clarificationText), MISUNDERSTOOD round >= 2 (mark unresolved)
- All reconciliation paths delete orphaned inbox docs to prevent duplicates
- Bucket doc inboxRecordId updated to point to original inbox item (bi-directional link integrity)

## Task Commits

Each task was committed atomically:

1. **Task 1a: Include inbox_doc_id in classify_and_file return string** - `e0e39f2` (feat)
2. **Task 1b: Emit CLASSIFIED event from workflow adapter with extracted inbox ID** - `e2d3795` (feat)
3. **Task 2: Add post-stream orphan reconciliation to follow_up_misunderstood endpoint** - `db4eb66` (feat)

## Files Created/Modified
- `backend/src/second_brain/tools/classification.py` - Added `| {inbox_doc_id}` suffix to both return strings
- `backend/src/second_brain/agents/workflow.py` - Added classified_inbox_id tracking (4-tuple), CLASSIFIED CustomEvent emission
- `backend/src/second_brain/main.py` - Complete rewrite of follow-up generate() with 3-path orphan reconciliation
- `backend/tests/test_classification.py` - Updated return string assertions to match new UUID suffix format

## Decisions Made
- CLASSIFIED event is NOT yielded to client -- only used internally for post-stream reconciliation. Client already receives the text message "Filed -> Bucket (0.XX)" via SSE stream.
- Round 1 MISUNDERSTOOD is re-emitted to client with the ORIGINAL inbox_item_id (not the orphan's ID), ensuring the client's subsequent follow-up uses the correct item.
- Non-fatal error handling throughout -- if any reconciliation step fails, the endpoint logs a warning but still completes the SSE stream.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated test assertions for new return string format**
- **Found during:** Task 1a (classify_and_file return string)
- **Issue:** Two existing tests asserted exact return string equality, now failing due to UUID suffix
- **Fix:** Changed assertions to use `startswith()` and validate UUID suffix format separately
- **Files modified:** backend/tests/test_classification.py
- **Verification:** All 43 tests pass
- **Committed in:** e0e39f2 (Task 1a commit)

---

**Total deviations:** 1 auto-fixed (1 bug fix)
**Impact on plan:** Test update was necessary for correctness after changing the return string format. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 8 plans in Phase 04.3 are now complete
- Follow-up flow no longer creates duplicate inbox items
- Ready for final UAT retest to validate Tests 3, 4, and 7

---
## Self-Check: PASSED

All files verified present. All commit hashes verified in git log.

---
*Phase: 04.3-agent-user-ux-with-unclear-item*
*Completed: 2026-02-24*
