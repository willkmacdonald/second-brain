---
status: diagnosed
phase: 04.3-agent-user-ux-with-unclear-item
source: [04.3-05-SUMMARY.md, 04.3-06-SUMMARY.md]
started: 2026-02-24T06:10:00Z
updated: 2026-02-24T07:45:00Z
---

## Current Test

[testing complete]

## Tests

### 1. High-Confidence Capture — Clean Streaming + Auto-Reset
expected: Type a clear, unambiguous thought (e.g., "Buy groceries tomorrow") and tap Send. You should see ONLY a clean "Filed -> Admin (0.xx)" result — NO verbose classifier reasoning text (no scores breakdown). The capture screen auto-resets after ~2.5 seconds.
result: pass

### 2. Low-Confidence Capture — Clean Streaming + Auto-Reset
expected: Type an ambiguous thought that could fit multiple buckets (e.g., "Had coffee with Mike, he mentioned a new project idea"). After sending, you see a clean "Filed (needs review)" toast — no verbose reasoning. The screen auto-resets. No HITL interruption.
result: issue
reported: "All three ambiguous inputs got evaluated as 0.00 confidence and defaulted to People bucket. Classifier not differentiating on ambiguous inputs."
severity: major

### 3. Misunderstood Capture — Conversation Mode
expected: Type something very unclear (e.g., "Aardvark" or random text). Instead of filing or bucket buttons, the capture screen shows a conversational question from the agent in a blue-bordered bubble. The input is cleared for your reply. You see "Reply" on the send button and "follow-up 1 of 2" hint text.
result: issue
reported: "Evaluated as 0.00 confidence. Does ask for clarification and creates a 'Needs clarification' entry with red badge. But also creates a second new entry based on the clarification — duplicate instead of update."
severity: major

### 4. Follow-Up Reply Re-Classifies
expected: After receiving the agent's question (from Test 3), type a clarifying reply (e.g., "It's the name of my friend's new startup project") and tap Reply. The system re-classifies with the combined context. If successful, you see a "Filed -> Projects" result and the screen resets.
result: issue
reported: "Follow-up reply creates a NEW inbox record instead of updating the original misunderstood one. Original stays 'Needs clarification' forever."
severity: major

### 5. Inbox Detail Card for Classified Item — Bucket Buttons
expected: Tap a classified (no dot) item in the inbox. A detail card modal opens showing the full text, bucket, confidence, agent chain, and timestamp. At the bottom, 4 bucket buttons appear (People, Projects, Ideas, Admin). The current bucket is highlighted in blue.
result: pass

### 6. Recategorize a Classified Item
expected: From the detail card (Test 5), tap a different bucket button (e.g., if currently "Admin", tap "Projects"). The modal closes, the item's bucket label updates in the list, and a "Moved to Projects" toast appears briefly.
result: pass

### 7. Misunderstood Item in Inbox — Display + Badge
expected: Open the Inbox tab. Misunderstood items (e.g., "Aardvark") show "Needs Clarification" label in orange (not "Pending"). Badge count includes misunderstood items. Tapping a misunderstood item shows a detail card with the agent's question (clarificationText) and status label — not "Unknown" bucket or "N/A" metadata. 4 bucket buttons appear labeled "File to bucket".
result: issue
reported: "EVERYTHING is getting evaluated as 0.00 confidence — classification is broken. Original misunderstood item not updated from 'needs clarification' after follow-up. New duplicate item created instead."
severity: blocker

## Summary

total: 7
passed: 3
issues: 4
pending: 0
skipped: 0

## Gaps

- truth: "Low-confidence captures get differentiated confidence scores (not all 0.00) and file to appropriate buckets"
  status: failed
  reason: "User reported: All three ambiguous inputs got evaluated as 0.00 confidence and defaulted to People bucket. Classifier not differentiating on ambiguous inputs."
  severity: major
  test: 2
  root_cause: "The classify_and_file tool signature has four individual score parameters (people_score, projects_score, ideas_score, admin_score) as required floats with no defaults. When the LLM's function_call doesn't include them (or the Agent Framework strips them), they resolve to 0.0. The allScores dict is built directly from these 0.0 values with no validation. Additionally, the confidence arg itself may be arriving as 0.0 for the same reason. The classifier instructions DO tell the LLM to provide all four scores, but the framework may not be serializing them correctly in the function_call."
  artifacts:
    - path: "backend/src/second_brain/tools/classification.py"
      issue: "classify_and_file lines 53-56: four score params have no defaults; allScores built at lines 74-80 with no validation they're non-zero"
    - path: "backend/src/second_brain/agents/classifier.py"
      issue: "Instructions say 'provide ALL FOUR bucket scores' but LLM may not be including them in function_call args"
  missing:
    - "Add logging to classify_and_file to dump all received argument values"
    - "Add validation that scores sum to roughly 1.0 or fall back to using confidence for the primary bucket"
    - "Consider whether Agent Framework is stripping/defaulting the score parameters"
  debug_session: ""

- truth: "Follow-up reply updates the original misunderstood inbox item instead of creating a duplicate"
  status: failed
  reason: "User reported: Follow-up creates NEW inbox record, original stays 'Needs clarification' forever."
  severity: major
  test: 3,4
  root_cause: "The follow_up_misunderstood endpoint (main.py:486-626) re-runs the full workflow with combined text but does NOT pass the original inbox_item_id to the workflow. The request_misunderstood tool (classification.py:144-187) always creates a NEW inbox doc with uuid4(). At round 1, the MISUNDERSTOOD event passes through to the client — no orphan cleanup happens (cleanup only triggers at round >= 2). So: original item stays 'misunderstood', new duplicate item is created. If the re-classification succeeds (classify_and_file), yet ANOTHER new item is created. The respond endpoint (main.py:339-478) correctly uses upsert_item() on the original — follow-up should do the same."
  artifacts:
    - path: "backend/src/second_brain/main.py"
      issue: "follow_up_misunderstood (line 486) does not pass inbox_item_id to workflow; no update of original item after successful re-classification"
    - path: "backend/src/second_brain/tools/classification.py"
      issue: "request_misunderstood (line 166) always creates NEW inbox doc with uuid4(); classify_and_file (line 93) also creates NEW inbox doc"
  missing:
    - "After workflow stream ends, if classify_and_file was detected: copy classification metadata to original inbox item via upsert, delete the orphaned new item"
    - "After workflow stream ends, if request_misunderstood was detected at round 1: delete the orphaned new item, update original with new clarificationText"
    - "Pattern should match respond endpoint: read original, update fields, upsert_item()"
  debug_session: ""

- truth: "All classification scores are non-zero; misunderstood items display correctly in inbox with proper badge counting"
  status: failed
  reason: "User reported: EVERYTHING is getting evaluated as 0.00 confidence — classification is broken. Duplicate items from follow-up flow."
  severity: blocker
  test: 7
  root_cause: "Compound of Gap 1 (0.00 scores) and Gap 2 (duplicate items). The 0.00 scores mean every classification looks broken in the UI. The duplicate items from follow-up mean the inbox fills with orphaned misunderstood items that never get resolved."
  artifacts:
    - path: "backend/src/second_brain/tools/classification.py"
      issue: "Score params and duplicate creation (same as gaps 1 and 2)"
    - path: "backend/src/second_brain/main.py"
      issue: "Follow-up endpoint duplicate creation (same as gap 2)"
  missing:
    - "Fixed by resolving Gap 1 and Gap 2"
  debug_session: ""
