---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 03
subsystem: api, ui
tags: [fastapi, sse, react-native, ag-ui, misunderstood, follow-up, conversation]

# Dependency graph
requires:
  - phase: 04.3-agent-user-ux-with-unclear-item (plan 01)
    provides: request_misunderstood tool, MISUNDERSTOOD event emission, silent pending filing
provides:
  - POST /api/ag-ui/follow-up endpoint for misunderstood re-classification
  - Capture screen conversation mode with agent question display and follow-up replies
  - sendFollowUp AG-UI client function
  - onMisunderstood and onUnresolved streaming callbacks
  - Max 2 follow-up rounds with unresolved fallback
affects: [04.3-04-e2e-wiring-and-verification]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "SSE stream interception: wrapping adapter stream to intercept/replace events at endpoint level"
    - "Conversation mode state machine: followUpRound counter drives UI mode switching"
    - "Orphan cleanup: endpoint deletes duplicate inbox docs created by tool at max rounds"

key-files:
  created: []
  modified:
    - backend/src/second_brain/main.py
    - mobile/app/capture/text.tsx
    - mobile/lib/ag-ui-client.ts
    - mobile/lib/types.ts

key-decisions:
  - "Stream interception over client-side max-round logic: endpoint wraps SSE stream to replace MISUNDERSTOOD with UNRESOLVED at round >= 2, keeping unresolved marking server-side"
  - "Orphan cleanup at round 2: request_misunderstood tool creates a new inbox doc before endpoint can intercept, so endpoint deletes orphan after marking original as unresolved"
  - "handleFollowUpSubmit declared before handleSubmit to avoid TypeScript block-scoped variable error"
  - "datetime import moved from inline to module-level in main.py for use by both respond and follow-up endpoints"

patterns-established:
  - "SSE stream wrapping: endpoint-level stream interception for conditional event replacement"
  - "Conversation mode pattern: followUpRound > 0 switches capture screen from capture to reply mode"

requirements-completed: [CLAS-04, APPX-04]

# Metrics
duration: 4min
completed: 2026-02-24
---

# Phase 04.3 Plan 03: Follow-Up Conversation Flow Summary

**SSE follow-up endpoint for misunderstood re-classification with capture screen conversation mode, max 2 rounds, and unresolved fallback**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-24T03:57:55Z
- **Completed:** 2026-02-24T04:02:35Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- POST /api/ag-ui/follow-up endpoint that combines original text with user clarification and re-runs classification workflow via SSE
- At round >= 2, endpoint intercepts MISUNDERSTOOD events, marks inbox item as "unresolved", and emits UNRESOLVED event instead
- Capture screen enters conversation mode on MISUNDERSTOOD: shows agent question bubble above text input, user replies, re-classification streams
- sendFollowUp client function and onMisunderstood/onUnresolved callback types added to AG-UI client

## Task Commits

Each task was committed atomically:

1. **Task 1: Implement follow-up endpoint for misunderstood re-classification** - `a2695a2` (feat)
2. **Task 2: Update mobile capture screen for misunderstood conversation flow and silent pending** - `612af25` (feat)

## Files Created/Modified
- `backend/src/second_brain/main.py` - Added FollowUpRequest model and POST /api/ag-ui/follow-up endpoint with SSE stream interception
- `mobile/lib/types.ts` - Added onMisunderstood, onUnresolved callbacks and SendFollowUpOptions interface
- `mobile/lib/ag-ui-client.ts` - Added sendFollowUp function and MISUNDERSTOOD/UNRESOLVED event handling in attachCallbacks
- `mobile/app/capture/text.tsx` - Added conversation mode states, handleFollowUpSubmit, agent question bubble UI, follow-up round tracking

## Decisions Made
- Stream interception over client-side max-round logic: endpoint wraps SSE stream to replace MISUNDERSTOOD with UNRESOLVED at round >= 2, keeping unresolved marking server-side
- Orphan cleanup at round 2: request_misunderstood tool creates a new inbox doc before endpoint can intercept, so endpoint deletes orphan after marking original as unresolved
- handleFollowUpSubmit declared before handleSubmit to avoid TypeScript block-scoped variable error
- datetime import moved from inline to module-level in main.py for use by both respond and follow-up endpoints

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Reordered handleFollowUpSubmit before handleSubmit**
- **Found during:** Task 2 (TypeScript compilation)
- **Issue:** handleFollowUpSubmit was declared after handleSubmit but called from inside it, causing TypeScript "used before declaration" error (TS2448/TS2454)
- **Fix:** Moved handleFollowUpSubmit useCallback declaration to before handleSubmit
- **Files modified:** mobile/app/capture/text.tsx
- **Verification:** `npx tsc --noEmit` passes cleanly
- **Committed in:** 612af25 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Declaration order adjustment necessary for TypeScript compilation. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Follow-up conversation flow complete, ready for end-to-end wiring and verification (Plan 04)
- All three UX paths functional: high-confidence (silent file), low-confidence (silent pending), misunderstood (conversation follow-up)

---
*Phase: 04.3-agent-user-ux-with-unclear-item*
*Completed: 2026-02-24*
