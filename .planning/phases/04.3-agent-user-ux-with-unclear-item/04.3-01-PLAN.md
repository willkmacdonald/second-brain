---
phase: 04.3-agent-user-ux-with-unclear-item
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/tools/classification.py
  - backend/src/second_brain/agents/classifier.py
  - backend/src/second_brain/agents/workflow.py
  - backend/tests/test_classification.py
autonomous: true
requirements:
  - CLAS-04
  - APPX-04

must_haves:
  truths:
    - "Classifier agent distinguishes misunderstood input from low-confidence classification"
    - "Misunderstood input creates an inbox doc with status 'misunderstood' and a conversational question"
    - "Low-confidence input (0.3-0.59) calls classify_and_file with pending status instead of request_clarification"
    - "Adapter emits MISUNDERSTOOD custom event for misunderstood input (distinct from HITL_REQUIRED)"
    - "request_clarification tool is removed; request_misunderstood replaces it for the misunderstood flow"
  artifacts:
    - path: "backend/src/second_brain/tools/classification.py"
      provides: "request_misunderstood tool, updated classify_and_file pending status"
      contains: "request_misunderstood"
    - path: "backend/src/second_brain/agents/classifier.py"
      provides: "Updated classifier instructions with misunderstood vs low-confidence distinction"
      contains: "request_misunderstood"
    - path: "backend/src/second_brain/agents/workflow.py"
      provides: "MISUNDERSTOOD custom event detection and emission"
      contains: "MISUNDERSTOOD"
    - path: "backend/tests/test_classification.py"
      provides: "Tests for request_misunderstood tool and updated classify_and_file"
      contains: "test_request_misunderstood"
  key_links:
    - from: "backend/src/second_brain/agents/classifier.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "request_misunderstood tool registered on classifier agent"
      pattern: "classification_tools\\.request_misunderstood"
    - from: "backend/src/second_brain/agents/workflow.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "Adapter detects misunderstood pattern from tool return string"
      pattern: "Misunderstood.*→"
---

<objective>
Replace the Phase 4 `request_clarification` low-confidence flow with a dual-threshold classification system that distinguishes "misunderstood" (truly unclear input requiring conversational follow-up) from "low confidence" (uncertain between buckets, silently filed as pending).

Purpose: The existing single-threshold HITL flow interrupts the user for every low-confidence classification. Phase 04.3 splits this into: (1) misunderstood items that need a conversation, and (2) low-confidence items that are silently filed and resolved later in inbox.

Output: Updated classification tools, classifier instructions, workflow adapter, and tests.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-RESEARCH.md
@.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-CONTEXT.md
@backend/src/second_brain/tools/classification.py
@backend/src/second_brain/agents/classifier.py
@backend/src/second_brain/agents/workflow.py
@backend/src/second_brain/models/documents.py
@backend/tests/test_classification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request_misunderstood tool and update classify_and_file for silent pending</name>
  <files>
    backend/src/second_brain/tools/classification.py
    backend/tests/test_classification.py
  </files>
  <action>
    In `classification.py`:

    1. **Remove `request_clarification` tool entirely.** It is replaced by `request_misunderstood` (for truly unclear input) and by the existing `classify_and_file` (for low-confidence items that now silently file as pending).

    2. **Update `classify_and_file`** status logic. Currently it sets `status = "classified" if confidence >= self._threshold else "low_confidence"`. Change to use a dual-threshold:
       - `confidence >= self._threshold` (0.6): status = "classified" (unchanged)
       - `confidence < self._threshold`: status = "pending" (was "low_confidence")
       This means low-confidence items get `status = "pending"` and a bucket document is still created (best-guess filing). The "pending" status tells the inbox UI this needs manual review.
       Note: both "pending" and "low_confidence" are already treated as pending in the mobile app (`isPendingStatus`), so using "pending" is consistent.

    3. **Add `request_misunderstood` tool** as a new method on `ClassificationTools`. This tool:
       - Parameters: `raw_text` (str), `question_text` (str -- friendly open-ended question), `follow_up_round` (int, default 1)
       - Creates an InboxDocument with `status="misunderstood"`, `clarificationText=question_text`, `filedRecordId=None`, `classificationMeta=None`, `title=None`
       - Returns format: `"Misunderstood -> {inbox_doc_id} | {question_text}"` (similar pattern to old request_clarification for adapter regex matching)
       - Log: `logger.info("Misunderstood: '%s' (round %d)", raw_text[:80], follow_up_round)`

    In `test_classification.py`:

    4. **Remove tests for `request_clarification`**: Delete `test_request_clarification_creates_pending_inbox`, `test_request_clarification_returns_parseable_string`, `test_request_clarification_invalid_bucket`, and the `_CLARIFICATION_KWARGS` constant.

    5. **Add tests for `request_misunderstood`**:
       - `test_request_misunderstood_creates_misunderstood_inbox`: Verify it creates an Inbox doc with `status="misunderstood"`, `clarificationText` set, `filedRecordId=None`, `classificationMeta=None`, no bucket container writes.
       - `test_request_misunderstood_returns_parseable_string`: Verify return matches `r"Misunderstood\s*->\s*([a-f0-9\-]+)\s*\|\s*(.+)"` and contains a valid UUID.

    6. **Update `test_classify_and_file_low_confidence`**: Change the assertion from `status == "low_confidence"` to `status == "pending"` since low-confidence items now get "pending" status.
  </action>
  <verify>
    Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain && python3 -m pytest backend/tests/test_classification.py -v` -- all tests pass.
    Verify `request_clarification` no longer exists in classification.py.
    Verify `request_misunderstood` exists with the correct return format.
  </verify>
  <done>
    `request_misunderstood` tool creates misunderstood inbox docs. `classify_and_file` sets status="pending" for low-confidence. `request_clarification` is removed. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update classifier instructions and adapter for misunderstood detection</name>
  <files>
    backend/src/second_brain/agents/classifier.py
    backend/src/second_brain/agents/workflow.py
  </files>
  <action>
    In `classifier.py`:

    1. **Update the tool list** in `create_classifier_agent`: Replace `classification_tools.request_clarification` with `classification_tools.request_misunderstood` in the `tools=` list.

    2. **Rewrite the classifier instructions** to implement the dual-threshold system. Replace the existing "## Low Confidence Handling" section and update "## Rules" to describe the three-tier system:

       ```
       ## Classification Decision Flow

       After analyzing the text, follow this decision tree:

       1. **Junk/gibberish**: Call mark_as_junk
       2. **High confidence (>= 0.6)**: Call classify_and_file with your best bucket
       3. **Low confidence (0.3-0.59)**: Call classify_and_file with your best guess
          - The system will automatically mark it as pending for user review
          - Do NOT ask the user anything -- just file your best guess
       4. **Misunderstood (< 0.3 OR you genuinely cannot determine intent)**:
          Call request_misunderstood with a friendly question

       ## Misunderstood vs Low Confidence

       Low confidence means you UNDERSTAND the input but are torn between 2 buckets.
       Misunderstood means you genuinely CANNOT determine what the user meant.

       Signals of "misunderstood":
       - All 4 bucket scores within 0.10 of each other (no clear winner)
       - Text is a single ambiguous word or very short fragment with no context
       - Text could mean completely different things in different contexts
       - Your confidence for the top bucket is below 0.30

       For misunderstood, ask a conversational, friendly question:
       - Good: "I'm not quite sure what you meant by 'Aardvark'. Could you tell me more?"
       - Good: "This could mean a few different things. Were you thinking about a person, project, or something else?"
       - Bad: "Please clarify." (too terse)
       - Bad: "Which bucket: People, Projects, Ideas, or Admin?" (that's for low-confidence, not misunderstood)
       ```

       Keep all other instruction sections (Buckets, Multi-Bucket Rule, Confidence Calibration, Examples, Title Extraction, Junk Detection) unchanged.

       Update Rule 2 from "When confidence < 0.6, call request_clarification" to:
       "When confidence is 0.3-0.59, call classify_and_file with your best guess (it will be marked pending for user review)"

       Add Rule 7: "When confidence < 0.3 or you cannot determine intent, call request_misunderstood with a friendly open-ended question"

       Update Rule 3: "NEVER respond without calling classify_and_file, request_misunderstood, or mark_as_junk"

    In `workflow.py`:

    3. **Add regex for misunderstood pattern detection**. Add near the existing `_CLARIFICATION_RE`:
       ```python
       _MISUNDERSTOOD_RE = re.compile(
           r"Misunderstood\s*→\s*([a-f0-9\-]+)\s*\|\s*(.+)", re.DOTALL
       )
       ```
       Note: The arrow is Unicode → (\u2192), same as in the other regexes.

    4. **Add `_extract_misunderstood` static method** to `AGUIWorkflowAdapter`:
       ```python
       @staticmethod
       def _extract_misunderstood(text: str) -> tuple[str, str] | None:
           """Extract (inbox_item_id, question_text) from misunderstood output."""
           match = _MISUNDERSTOOD_RE.search(text)
           return (match.group(1), match.group(2)) if match else None
       ```

    5. **Update `_stream_updates`** to detect misunderstood pattern alongside clarification. Add a `detected_misunderstood: tuple[str, str] | None = None` variable. In each place where `detected_clarification` is checked, also check for misunderstood FIRST (misunderstood takes priority since it's a stronger signal):
       - Before checking `self._extract_clarification(update.text)`, check `self._extract_misunderstood(update.text)`
       - If misunderstood is detected, set `detected_misunderstood` and skip clarification check

    6. **Update the post-stream event emission** at the end of `_stream_updates`. Add a check for `detected_misunderstood` BEFORE the `detected_clarification` check:
       ```python
       if detected_misunderstood is not None:
           inbox_item_id, question_text = detected_misunderstood
           logger.info(
               "Misunderstood detected for inbox item %s, emitting MISUNDERSTOOD",
               inbox_item_id,
           )
           yield CustomEvent(
               name="MISUNDERSTOOD",
               value={
                   "threadId": thread_id,
                   "inboxItemId": inbox_item_id,
                   "questionText": question_text,
               },
           )
       elif detected_clarification is not None:
           # ... existing HITL_REQUIRED logic (keep as-is for respond endpoint compatibility)
       ```

    7. **Remove the low-confidence detection fallback** at the end of `_stream_updates`. The block that checks `detected_confidence < self._classification_threshold` and emits HITL_REQUIRED is no longer needed because low-confidence items are now silently filed as pending (classify_and_file handles it). Remove this block:
       ```python
       elif (
           detected_confidence is not None
           and detected_confidence < self._classification_threshold
       ):
           ...
       ```
       This ensures low-confidence captures complete normally (the capture screen shows the "Filed" result, not HITL buttons).
  </action>
  <verify>
    Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain && python3 -m pytest backend/tests/ -v` -- all tests pass.
    Verify `_MISUNDERSTOOD_RE` regex matches the format from `request_misunderstood` tool.
    Verify classifier instructions mention `request_misunderstood` (not `request_clarification`).
    Verify the `tools=` list in `create_classifier_agent` includes `request_misunderstood`.
    Verify the low-confidence HITL_REQUIRED emission block is removed from `_stream_updates`.
  </verify>
  <done>
    Classifier agent uses dual-threshold instructions (misunderstood < 0.3, low-confidence 0.3-0.59, high-confidence >= 0.6). Adapter emits MISUNDERSTOOD custom event for misunderstood items. Low-confidence items complete normally without HITL interruption. All backend tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python3 -m pytest backend/tests/ -v` -- all tests pass
2. `request_misunderstood` tool exists in classification.py with correct return format
3. `request_clarification` tool is removed from classification.py
4. Classifier instructions describe three-tier decision flow (misunderstood / low-confidence / high-confidence)
5. Adapter emits MISUNDERSTOOD event (not HITL_REQUIRED) for misunderstood input
6. Low-confidence items no longer trigger HITL_REQUIRED -- they complete normally with "Filed" result
</verification>

<success_criteria>
Backend classification pipeline distinguishes misunderstood from low-confidence. Misunderstood emits a MISUNDERSTOOD event; low-confidence silently files as pending. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-agent-user-ux-with-unclear-item/04.3-01-SUMMARY.md`
</output>
