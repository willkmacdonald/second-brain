---
phase: 06-foundry-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/agents/orchestrator.py
  - backend/src/second_brain/agents/perception.py
  - backend/src/second_brain/agents/echo.py
  - backend/src/second_brain/agents/workflow.py
  - backend/src/second_brain/tools/transcription.py
  - backend/tests/test_agui_endpoint.py
  - backend/tests/test_integration.py
  - backend/tests/conftest.py
  - backend/src/second_brain/main.py
autonomous: true
requirements:
  - INFRA-14
  - AGNT-04

must_haves:
  truths:
    - "No import of orchestrator, perception, echo, workflow, or transcription modules anywhere in the codebase"
    - "No AG-UI endpoint functions (ag_ui_endpoint, respond_to_hitl, follow_up_misunderstood, voice_capture) exist in main.py"
    - "main.py is a clean FastAPI shell with lifespan (Key Vault + Cosmos DB only), health router, inbox router, and middleware"
    - "ruff check passes with zero errors"
    - "No AG-UI request models (AGUIRunRequest, RespondRequest, FollowUpRequest) exist in the codebase"
  artifacts:
    - path: "backend/src/second_brain/main.py"
      provides: "Clean FastAPI shell without AG-UI endpoints or old agent imports"
    - path: "backend/tests/conftest.py"
      provides: "Test fixtures without AG-UI mock classes or AG-UI event imports"
  key_links:
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/api/health.py"
      via: "include_router(health_router)"
      pattern: "include_router.*health_router"
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/api/inbox.py"
      via: "include_router(inbox_router)"
      pattern: "include_router.*inbox_router"
---

<objective>
Delete all old orchestration code (HandoffBuilder, AGUIWorkflowAdapter, Orchestrator agent, Perception Agent, Echo agent, Whisper transcription) and all AG-UI endpoints from main.py. Remove AG-UI test files and fixtures. Leave a clean FastAPI shell.

Purpose: Establish a clean codebase with no dead code before adding Foundry infrastructure. The old code uses incompatible SDK patterns (AzureOpenAIChatClient, HandoffBuilder) that cannot coexist with the new AzureAIAgentClient.
Output: A clean main.py with only lifespan (Key Vault + Cosmos DB), health router, inbox router, and middleware. All old agent/workflow/transcription files deleted. Test fixtures cleaned.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundry-infrastructure/06-RESEARCH.md
@backend/src/second_brain/main.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old source and test files</name>
  <files>
    backend/src/second_brain/agents/orchestrator.py
    backend/src/second_brain/agents/perception.py
    backend/src/second_brain/agents/echo.py
    backend/src/second_brain/agents/workflow.py
    backend/src/second_brain/tools/transcription.py
    backend/tests/test_agui_endpoint.py
    backend/tests/test_integration.py
  </files>
  <action>
Delete these 7 files entirely:
- `backend/src/second_brain/agents/orchestrator.py` -- Orchestrator agent (AGNT-04: eliminated)
- `backend/src/second_brain/agents/perception.py` -- Perception agent
- `backend/src/second_brain/agents/echo.py` -- Phase 1 test agent
- `backend/src/second_brain/agents/workflow.py` -- HandoffBuilder + AGUIWorkflowAdapter (541 lines)
- `backend/src/second_brain/tools/transcription.py` -- Whisper transcription tool
- `backend/tests/test_agui_endpoint.py` -- AG-UI endpoint tests
- `backend/tests/test_integration.py` -- Integration tests that test AG-UI pipeline

Leave these INTACT (per locked decision -- Classifier stays for Phase 7):
- `backend/src/second_brain/agents/classifier.py`
- `backend/src/second_brain/agents/__init__.py`
- `backend/src/second_brain/db/blob_storage.py` (keep file, remove from lifespan in Task 2)
- All other test files (test_auth.py, test_classification.py, test_cosmos_crud.py, test_health.py, test_inbox_api.py, test_inbox_delete.py)

Use `rm` for each file. Verify each file is deleted.
  </action>
  <verify>
Run: `ls backend/src/second_brain/agents/orchestrator.py backend/src/second_brain/agents/perception.py backend/src/second_brain/agents/echo.py backend/src/second_brain/agents/workflow.py backend/src/second_brain/tools/transcription.py backend/tests/test_agui_endpoint.py backend/tests/test_integration.py 2>&1` -- all should report "No such file or directory".
Run: `ls backend/src/second_brain/agents/classifier.py` -- should exist.
  </verify>
  <done>All 7 files deleted. classifier.py and blob_storage.py still exist.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite main.py as clean FastAPI shell</name>
  <files>
    backend/src/second_brain/main.py
    backend/tests/conftest.py
  </files>
  <action>
**main.py:** Replace the entire file with a clean FastAPI shell. The new main.py must:

1. Keep the `load_dotenv()` -> early import pattern at the top (same as current)
2. Remove `configure_otel_providers()` call (will be replaced with `configure_azure_monitor()` in Plan 02)
3. Remove ALL AG-UI imports: `ag_ui.core.events.*`, `ag_ui.encoder.EventEncoder`, `agent_framework.AgentResponseUpdate`, `agent_framework.azure.AzureOpenAIChatClient`
4. Remove `from azure.identity import DefaultAzureCredential` (sync credential -- no longer needed)
5. Remove ALL old agent/workflow imports: `create_orchestrator_agent`, `create_classifier_agent`, `AGUIWorkflowAdapter`, `StreamItem`, `create_capture_workflow`, `BlobStorageManager`, `transcribe_audio`, `ClassificationTools`
6. Remove `CONTAINER_MODELS`, `ClassificationMeta` imports (only used by deleted endpoints)
7. Remove ALL AG-UI SSE helpers: `_convert_update_to_events()`, `_stream_sse()`
8. Remove ALL request models: `AGUIRunRequest`, `RespondRequest`, `FollowUpRequest`
9. Remove ALL endpoint functions: `ag_ui_endpoint`, `respond_to_hitl`, `follow_up_misunderstood`, `voice_capture`, and the `_MAX_AUDIO_SIZE`/`_MIN_AUDIO_SIZE` constants
10. Remove from lifespan: Blob Storage initialization block, AzureOpenAIChatClient creation, ClassificationTools, agent creation, workflow creation, and the `app.state.workflow_agent`/`app.state.classification_tools` assignments
11. Remove from lifespan cleanup: Blob Storage close
12. Remove imports no longer needed: `asyncio`, `uuid`, `AsyncGenerator`, `datetime`, `UTC`, `File`, `UploadFile`, `StreamingResponse`, `BaseModel`, `pydantic`

Keep in main.py:
- `load_dotenv()` at top
- `from contextlib import asynccontextmanager`
- `import logging`
- `AsyncDefaultAzureCredential` import from `azure.identity.aio`
- `KeyVaultSecretClient` import
- `FastAPI`, `Request` imports
- `health_router`, `inbox_router` imports
- `APIKeyMiddleware` import
- `get_settings` import
- `CosmosManager` import
- Lifespan with: Key Vault API key fetch, Cosmos DB init, yield, Cosmos cleanup, credential close
- `app = FastAPI(title="Second Brain API", lifespan=lifespan)`
- Middleware and router registration
- `if __name__ == "__main__"` block

The lifespan async credential should now PERSIST across the entire lifespan (not close immediately after Key Vault fetch as it currently does). Store on `app.state.credential` for future Foundry use in Plan 02. Close in finally block.

Update app title from "Second Brain AG-UI Server" to "Second Brain API".

**conftest.py:** Rewrite to remove all AG-UI dependencies:

1. Remove imports: `ag_ui.core.*`, `ag_ui.encoder.EventEncoder`, `agent_framework_ag_ui._types.AGUIRequest`, `StreamingResponse`
2. Remove `MockAgentFrameworkAgent` class entirely
3. Remove AG-UI mock endpoint from `app_with_mocks` fixture (no more `/api/ag-ui` endpoint registration)
4. Remove `AsyncGenerator` import (no longer needed)
5. Keep: `settings` fixture (update to remove `azure_openai_endpoint` and `azure_openai_chat_deployment_name` fields -- they are being removed from config in Plan 02, but for now just keep the fixture with existing fields so remaining tests pass)
6. Keep: `mock_cosmos_manager` fixture (unchanged)
7. Keep: `app_with_mocks` fixture (simplified: just FastAPI + health router + API key on state + middleware)
8. Keep: `async_client` fixture (unchanged)
  </action>
  <verify>
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -c "from second_brain.main import app; print('Import OK')"` -- should succeed without ImportError.
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/second_brain/main.py` -- zero errors.
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check tests/conftest.py` -- zero errors.
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/ tests/` -- zero errors across entire codebase.
  </verify>
  <done>main.py is a clean FastAPI shell (~80 lines) with only Key Vault, Cosmos DB, health, inbox, and middleware. conftest.py has no AG-UI imports or mocks. `ruff check` passes on entire backend with zero errors.</done>
</task>

</tasks>

<verification>
1. `ruff check backend/src/ backend/tests/` -- zero errors (no unused imports, no missing references)
2. `grep -r "ag_ui\|AGUIWorkflowAdapter\|HandoffBuilder\|orchestrator\|perception\|echo\|transcription\|AzureOpenAIChatClient" backend/src/second_brain/ --include="*.py"` -- zero matches (no dead references)
3. `grep -r "ag_ui\|agent_framework_ag_ui\|MockAgentFrameworkAgent\|AGUIRequest" backend/tests/ --include="*.py"` -- zero matches
4. `ls backend/src/second_brain/agents/classifier.py` -- exists (kept for Phase 7)
5. `ls backend/src/second_brain/db/blob_storage.py` -- exists (kept, removed from lifespan only)
</verification>

<success_criteria>
- All 7 old files deleted (orchestrator.py, perception.py, echo.py, workflow.py, transcription.py, test_agui_endpoint.py, test_integration.py)
- main.py is a clean FastAPI shell with no AG-UI code (~80 lines)
- conftest.py has no AG-UI imports or mock classes
- `ruff check` passes on entire backend
- No dangling references to deleted modules anywhere in the codebase
- classifier.py and blob_storage.py remain intact
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundry-infrastructure/06-01-SUMMARY.md`
</output>
