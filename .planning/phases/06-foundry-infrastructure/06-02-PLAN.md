---
phase: 06-foundry-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - backend/pyproject.toml
  - backend/src/second_brain/config.py
  - backend/src/second_brain/main.py
  - backend/src/second_brain/api/health.py
  - backend/.env.example
autonomous: true
requirements:
  - INFRA-10
  - INFRA-11
  - INFRA-13

must_haves:
  truths:
    - "pyproject.toml no longer depends on agent-framework-ag-ui, agent-framework-orchestrations, or agent-framework-devui"
    - "pyproject.toml depends on agent-framework-azure-ai and azure-monitor-opentelemetry"
    - "config.py has azure_ai_project_endpoint, azure_ai_classifier_agent_id, and applicationinsights_connection_string fields"
    - "config.py no longer has azure_openai_endpoint, azure_openai_chat_deployment_name, azure_openai_whisper_deployment_name, enable_instrumentation, or enable_sensitive_data fields"
    - "main.py calls configure_azure_monitor() after load_dotenv() and before other imports"
    - "main.py creates AzureAIAgentClient in lifespan with async credential and stores on app.state"
    - "main.py lifespan raises on Foundry client failure (fail fast)"
    - "GET /health returns foundry connectivity status alongside cosmos status"
    - ".env.example documents AZURE_AI_PROJECT_ENDPOINT, AZURE_AI_CLASSIFIER_AGENT_ID, and APPLICATIONINSIGHTS_CONNECTION_STRING"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "Updated dependencies with Foundry SDK and observability packages"
    - path: "backend/src/second_brain/config.py"
      provides: "Settings class with Foundry and AppInsights env vars"
    - path: "backend/src/second_brain/main.py"
      provides: "FastAPI app with configure_azure_monitor(), AzureAIAgentClient in lifespan"
    - path: "backend/src/second_brain/api/health.py"
      provides: "Health endpoint returning foundry and cosmos connectivity status"
    - path: "backend/.env.example"
      provides: "Documentation of all required environment variables"
  key_links:
    - from: "backend/src/second_brain/main.py"
      to: "azure.monitor.opentelemetry"
      via: "configure_azure_monitor() call at module level"
      pattern: "configure_azure_monitor"
    - from: "backend/src/second_brain/main.py"
      to: "agent_framework.azure.AzureAIAgentClient"
      via: "client creation in lifespan stored on app.state.foundry_client"
      pattern: "AzureAIAgentClient"
    - from: "backend/src/second_brain/api/health.py"
      to: "app.state.foundry_client"
      via: "request.app.state access in health endpoint"
      pattern: "foundry_client"
---

<objective>
Update dependencies (remove old AG-UI/orchestrations packages, add Foundry + AppInsights packages), update config.py with new Foundry env vars, wire AzureAIAgentClient + configure_azure_monitor() into main.py, and enhance the health endpoint to report Foundry connectivity.

Purpose: Establish the Foundry Agent Service connection and Application Insights telemetry so the backend can authenticate to the Foundry project and emit traces.
Output: A backend that initializes AzureAIAgentClient at startup (fail fast), sends telemetry to AppInsights, and reports Foundry status via GET /health.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundry-infrastructure/06-RESEARCH.md
@.planning/phases/06-foundry-infrastructure/06-01-SUMMARY.md
@backend/src/second_brain/main.py
@backend/src/second_brain/config.py
@backend/src/second_brain/api/health.py
@backend/pyproject.toml
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pyproject.toml dependencies and config.py settings</name>
  <files>
    backend/pyproject.toml
    backend/src/second_brain/config.py
    backend/.env.example
  </files>
  <action>
**pyproject.toml:**

1. Update project description from "AG-UI backend server with multi-agent orchestration" to "The Active Second Brain - FastAPI backend with Azure AI Foundry Agent Service"

2. Replace dependencies section. Remove:
   - `agent-framework-ag-ui`
   - `agent-framework-orchestrations`

   Add:
   - `agent-framework-azure-ai` (Foundry Agent Service client)
   - `azure-monitor-opentelemetry>=1.8.6` (Application Insights via OTel distro)
   - `azure-core-tracing-opentelemetry` (trace propagation through Azure SDK)

   Keep unchanged:
   - `azure-cosmos`, `azure-identity`, `azure-keyvault-secrets`, `azure-storage-blob`
   - `aiohttp`, `python-multipart`, `pydantic-settings`, `python-dotenv`

3. In `[project.optional-dependencies]` dev section, remove `agent-framework-devui`. Keep `ruff`.

4. Update ruff per-file-ignores comment for main.py from "configure_otel_providers()" to "configure_azure_monitor()"

5. Add a note in dependencies about `--prerelease=allow` being needed:
   ```toml
   # Agent Framework -- Foundry integration (RC, requires --prerelease=allow for uv install)
   "agent-framework-azure-ai",
   ```

**IMPORTANT:** Do NOT pin `azure-ai-agents` or `azure-ai-projects` directly. Let `agent-framework-azure-ai` manage its transitive dependencies (per Pitfall 1 from research).

**config.py:**

Replace the entire Settings class. Remove these fields:
- `azure_openai_endpoint`
- `azure_openai_chat_deployment_name`
- `azure_openai_whisper_deployment_name`
- `enable_instrumentation`
- `enable_sensitive_data`

Add these fields:
- `azure_ai_project_endpoint: str = ""` -- Foundry project endpoint
- `azure_ai_classifier_agent_id: str = ""` -- Classifier agent ID (Phase 7 populates)
- `applicationinsights_connection_string: str = ""` -- AppInsights connection string

Keep these fields unchanged:
- `cosmos_endpoint`, `key_vault_url`, `api_key_secret_name`, `blob_storage_url`, `classification_threshold`, `database_name`

Keep `model_config` dict unchanged.

**.env.example:**

Replace contents with all current env vars:
```
# Azure AI Foundry
AZURE_AI_PROJECT_ENDPOINT=https://your-foundry-resource.services.ai.azure.com/api/projects/your-project

# Azure AI Foundry Agent IDs (populated after agent registration in Phase 7+)
AZURE_AI_CLASSIFIER_AGENT_ID=

# Application Insights
APPLICATIONINSIGHTS_CONNECTION_STRING=InstrumentationKey=...;IngestionEndpoint=...

# Cosmos DB
COSMOS_ENDPOINT=https://your-cosmos-account.documents.azure.com:443/

# Azure Key Vault (API key stored as secret "second-brain-api-key", fetched at startup)
KEY_VAULT_URL=https://wkm-shared-kv.vault.azure.net/

# Azure Blob Storage (voice recordings -- kept for future use)
BLOB_STORAGE_URL=https://your-storage-account.blob.core.windows.net/
```

Remove from .env.example: `AZURE_OPENAI_ENDPOINT`, `AZURE_OPENAI_CHAT_DEPLOYMENT_NAME`, `ENABLE_INSTRUMENTATION`, `ENABLE_SENSITIVE_DATA`.
  </action>
  <verify>
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/second_brain/config.py` -- zero errors.
Run: `grep -c "agent-framework-ag-ui\|agent-framework-orchestrations\|agent-framework-devui" pyproject.toml` -- should be 0.
Run: `grep -c "agent-framework-azure-ai" pyproject.toml` -- should be 1.
Run: `grep -c "azure-monitor-opentelemetry" pyproject.toml` -- should be 1.
Run: `grep -c "azure_openai_endpoint\|azure_openai_chat_deployment_name\|whisper\|enable_instrumentation\|enable_sensitive_data" src/second_brain/config.py` -- should be 0.
Run: `grep -c "azure_ai_project_endpoint\|applicationinsights_connection_string" src/second_brain/config.py` -- should be 2.
  </verify>
  <done>pyproject.toml has Foundry + AppInsights deps, no old AG-UI deps. config.py has new Foundry settings, no old OpenAI/Whisper settings. .env.example documents all new vars.</done>
</task>

<task type="auto">
  <name>Task 2: Wire configure_azure_monitor(), AzureAIAgentClient, and enhanced health endpoint</name>
  <files>
    backend/src/second_brain/main.py
    backend/src/second_brain/api/health.py
  </files>
  <action>
**main.py:**

Update the module-level initialization section (after `load_dotenv()`, before FastAPI imports):

1. Replace `from agent_framework.observability import configure_otel_providers` with `from azure.monitor.opentelemetry import configure_azure_monitor`
2. Replace `configure_otel_providers()` call with `configure_azure_monitor()` -- it reads `APPLICATIONINSIGHTS_CONNECTION_STRING` from env automatically
3. Add import: `from agent_framework.azure import AzureAIAgentClient` (after configure_azure_monitor call, with `# noqa: E402`)

Update the lifespan function:

1. After Key Vault fetch, after Cosmos DB init, add a new "Foundry Agent Service" initialization block:
   ```python
   # --- Foundry Agent Service (fail fast) ---
   try:
       foundry_client = AzureAIAgentClient(
           credential=credential,
           project_endpoint=settings.azure_ai_project_endpoint,
       )
       app.state.foundry_client = foundry_client
       logger.info(
           "Foundry client initialized: %s",
           settings.azure_ai_project_endpoint,
       )
   except Exception:
       logger.error("FATAL: Could not initialize Foundry client", exc_info=True)
       raise  # Fail fast -- backend is useless without Foundry
   ```

2. The async credential (`AsyncDefaultAzureCredential`) is already persisted across lifespan from Plan 01. Store it as `app.state.foundry_credential = credential` alongside the client.

3. Store settings on app.state: `app.state.settings = settings`

**health.py:**

Replace the simple health endpoint with an enhanced version:

```python
"""Health check endpoint with Foundry connectivity status."""

from fastapi import APIRouter, Request

router = APIRouter()


@router.get("/health")
async def health_check(request: Request) -> dict:
    """Return service health status including Foundry connectivity."""
    foundry_status = "not_configured"
    foundry_client = getattr(request.app.state, "foundry_client", None)

    if foundry_client is not None:
        foundry_status = "connected"

    cosmos_status = (
        "connected"
        if getattr(request.app.state, "cosmos_manager", None) is not None
        else "not_configured"
    )

    overall = "ok" if foundry_status == "connected" else "degraded"

    return {
        "status": overall,
        "foundry": foundry_status,
        "cosmos": cosmos_status,
    }
```

Note: The health endpoint uses `getattr` with defaults for safety. The Foundry status is "connected" if the client was created successfully in lifespan (which validates the endpoint format). Actual auth validation happens when the client is used in Phase 7+. The fail-fast in lifespan already guarantees the client exists when the app is running.

After these changes, lock dependencies:
```bash
cd backend && uv lock
```

This may require `--prerelease=allow` flag if `agent-framework-azure-ai` is still RC:
```bash
cd backend && uv lock --prerelease=allow
```
  </action>
  <verify>
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/second_brain/main.py` -- zero errors.
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/second_brain/api/health.py` -- zero errors.
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/ tests/` -- zero errors across entire backend.
Run: `grep "configure_azure_monitor" src/second_brain/main.py` -- should match.
Run: `grep "AzureAIAgentClient" src/second_brain/main.py` -- should match.
Run: `grep "foundry_client" src/second_brain/api/health.py` -- should match.
  </verify>
  <done>main.py calls configure_azure_monitor() at startup, creates AzureAIAgentClient in lifespan (fail fast), stores on app.state. Health endpoint reports foundry + cosmos status. Dependencies locked. `ruff check` passes.</done>
</task>

</tasks>

<verification>
1. `ruff check backend/src/ backend/tests/` -- zero errors
2. `grep "configure_azure_monitor" backend/src/second_brain/main.py` -- present
3. `grep "AzureAIAgentClient" backend/src/second_brain/main.py` -- present
4. `grep "foundry_client" backend/src/second_brain/api/health.py` -- present
5. `grep -c "agent-framework-ag-ui\|agent-framework-orchestrations" backend/pyproject.toml` -- 0
6. `grep "azure_ai_project_endpoint" backend/src/second_brain/config.py` -- present
7. `grep "applicationinsights_connection_string" backend/src/second_brain/config.py` -- present
8. `cat backend/.env.example` -- shows new Foundry + AppInsights vars
</verification>

<success_criteria>
- pyproject.toml has agent-framework-azure-ai and azure-monitor-opentelemetry, no old AG-UI packages
- config.py has Foundry + AppInsights fields, no old OpenAI/Whisper/OTel fields
- main.py calls configure_azure_monitor() before other imports
- main.py creates AzureAIAgentClient in lifespan with fail-fast behavior
- health endpoint returns `{status, foundry, cosmos}` JSON
- .env.example documents all new env vars
- `ruff check` passes on entire backend
- uv.lock regenerated with new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundry-infrastructure/06-02-SUMMARY.md`
</output>
