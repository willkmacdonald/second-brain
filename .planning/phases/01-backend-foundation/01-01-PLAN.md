---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/.env.example
  - backend/.python-version
  - backend/src/second_brain/__init__.py
  - backend/src/second_brain/config.py
  - backend/src/second_brain/main.py
  - backend/src/second_brain/agents/__init__.py
  - backend/src/second_brain/agents/echo.py
  - backend/src/second_brain/db/__init__.py
  - backend/src/second_brain/models/__init__.py
  - backend/src/second_brain/tools/__init__.py
  - backend/tests/__init__.py
  - backend/tests/conftest.py
  - backend/tests/test_agui_endpoint.py
  - backend/tests/test_health.py
  - .gitignore
autonomous: true
requirements:
  - INFRA-01
  - INFRA-04

user_setup:
  - service: Azure OpenAI
    why: "LLM backend for the echo agent"
    env_vars:
      - name: AZURE_OPENAI_ENDPOINT
        source: "Azure Portal -> Azure OpenAI resource -> Keys and Endpoint"
      - name: AZURE_OPENAI_CHAT_DEPLOYMENT_NAME
        source: "Azure AI Studio -> Deployments -> deployment name (e.g., gpt-4o)"
    dashboard_config:
      - task: "Deploy a gpt-4o model"
        location: "Azure AI Studio -> Deployments -> Deploy model"
  - service: Azure CLI
    why: "DefaultAzureCredential uses az login for local dev auth"
    env_vars: []
    dashboard_config:
      - task: "Run az login"
        location: "Terminal"

must_haves:
  truths:
    - "A POST request to the AG-UI endpoint returns a streaming SSE response with RUN_STARTED, TEXT_MESSAGE_CONTENT, and RUN_FINISHED events"
    - "A GET request to /health returns 200 with status ok"
    - "OpenTelemetry traces are emitted when ENABLE_INSTRUMENTATION=true (visible via console exporter or DevUI)"
    - "The server starts cleanly with uvicorn and loads configuration from .env"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "Project definition with uv, dependency groups (core, dev, test)"
      contains: "agent-framework-ag-ui"
    - path: "backend/src/second_brain/main.py"
      provides: "FastAPI app with AG-UI endpoint and lifespan"
      min_lines: 30
    - path: "backend/src/second_brain/config.py"
      provides: "Pydantic-settings configuration loading from .env"
      contains: "BaseSettings"
    - path: "backend/src/second_brain/agents/echo.py"
      provides: "Phase 1 test agent that echoes back user messages"
      contains: "AzureOpenAIChatClient"
    - path: "backend/.env.example"
      provides: "Environment variable template with placeholder values"
      contains: "AZURE_OPENAI_ENDPOINT"
  key_links:
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/agents/echo.py"
      via: "import and register with add_agent_framework_fastapi_endpoint"
      pattern: "add_agent_framework_fastapi_endpoint"
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/config.py"
      via: "import Settings for configuration"
      pattern: "from second_brain.config import"
    - from: "backend/src/second_brain/agents/echo.py"
      to: "agent_framework.azure"
      via: "AzureOpenAIChatClient for LLM access"
      pattern: "AzureOpenAIChatClient"
---

<objective>
Create the project scaffold and a working AG-UI server with an echo agent and OpenTelemetry tracing.

Purpose: Establish the monorepo backend structure, install all dependencies, and prove that a POST request to the AG-UI endpoint returns a streaming SSE response with agent messages. This is the absolute foundation everything else builds on.

Output: A runnable FastAPI server at `backend/` with an AG-UI endpoint that streams SSE responses from an echo agent, with OpenTelemetry tracing enabled.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md
@.planning/phases/01-backend-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffold with pyproject.toml and directory structure</name>
  <files>
    backend/pyproject.toml
    backend/.python-version
    backend/.env.example
    backend/src/second_brain/__init__.py
    backend/src/second_brain/config.py
    backend/src/second_brain/agents/__init__.py
    backend/src/second_brain/db/__init__.py
    backend/src/second_brain/models/__init__.py
    backend/src/second_brain/tools/__init__.py
    backend/tests/__init__.py
    backend/tests/conftest.py
    .gitignore
  </files>
  <action>
    Create the monorepo backend directory structure per the locked CONTEXT.md decision:
    - Monorepo with `/backend` directory (mobile comes in Phase 2)
    - Domain-based packages: `agents/`, `db/`, `models/`, `tools/`
    - Use `src/second_brain/` layout (src layout for proper packaging)

    **pyproject.toml:**
    - Use `[project]` table with `name = "second-brain-backend"`, `requires-python = ">=3.12"`
    - Core dependencies: `agent-framework-ag-ui` (with `--prerelease=allow` note in comments), `azure-cosmos`, `azure-identity`, `pydantic-settings`, `python-dotenv`
    - Dev dependency group: `ruff`, `agent-framework-devui`
    - Test dependency group: `pytest`, `pytest-asyncio`, `httpx`
    - Configure ruff: line-length = 88, rules E/F/I/UP/B/SIM/N per global CLAUDE.md
    - Configure pytest: asyncio_mode = "auto"

    **.python-version:** Set to `3.12`

    **.env.example:**
    ```
    # Azure OpenAI
    AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
    AZURE_OPENAI_CHAT_DEPLOYMENT_NAME=gpt-4o

    # Cosmos DB
    COSMOS_ENDPOINT=https://your-cosmos-account.documents.azure.com:443/

    # API Key (for mobile app authentication)
    API_KEY=your-secure-api-key-here

    # OpenTelemetry
    ENABLE_INSTRUMENTATION=true
    ENABLE_SENSITIVE_DATA=false
    ```

    **config.py:**
    - Create a `Settings` class using `pydantic_settings.BaseSettings`
    - Fields: `azure_openai_endpoint: str`, `azure_openai_chat_deployment_name: str`, `cosmos_endpoint: str`, `api_key: str`, `enable_instrumentation: bool = True`, `enable_sensitive_data: bool = False`, `database_name: str = "second-brain"`
    - Configure `model_config` with `env_file = ".env"` and `case_sensitive = False`
    - Create a module-level `get_settings()` function that returns a cached Settings instance (use `@lru_cache`)

    **conftest.py:**
    - Import pytest
    - Add a `settings` fixture that provides test settings (with test-safe defaults)
    - Placeholder for future fixtures

    **.gitignore:** Update repo root .gitignore to include:
    - `backend/.venv/`, `backend/.env`, `__pycache__/`, `*.pyc`, `.pytest_cache/`, `.ruff_cache/`
    - Do NOT ignore `.env.example`

    Run `cd backend && uv venv .venv && uv pip install -e ".[dev,test]" --prerelease=allow` to install dependencies.
    Run `uv run ruff check .` to verify ruff config works.
  </action>
  <verify>
    1. `ls backend/src/second_brain/agents/ backend/src/second_brain/db/ backend/src/second_brain/models/ backend/src/second_brain/tools/` shows __init__.py in each
    2. `cd backend && uv run python -c "from second_brain.config import get_settings; print('config OK')"` succeeds
    3. `cd backend && uv run ruff check .` returns no errors
    4. `cat backend/.env.example` shows all expected environment variables
  </verify>
  <done>
    Project scaffold exists with all directories, pyproject.toml installs cleanly via uv, config module loads settings from environment, ruff is configured and passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI app with echo agent, AG-UI endpoint, and OpenTelemetry</name>
  <files>
    backend/src/second_brain/agents/echo.py
    backend/src/second_brain/main.py
    backend/tests/test_agui_endpoint.py
    backend/tests/test_health.py
  </files>
  <action>
    **agents/echo.py:**
    - Create a function `create_echo_agent()` that:
      - Creates `AzureOpenAIChatClient` with `credential=DefaultAzureCredential()` (from `azure.identity.aio`), reading endpoint and deployment from the Settings object
      - Creates an agent via `chat_client.as_agent()` (per research Pattern A — recommended approach)
      - Agent name: `"SecondBrainEcho"`
      - Instructions: "You are a test agent for the Second Brain system. Echo back what the user says and confirm the system is working. Keep responses brief."
      - Returns the agent instance
    - NOTE: Use `azure.identity.aio.DefaultAzureCredential` (async version) since this runs in async FastAPI

    **main.py:**
    - Call `load_dotenv()` at the TOP of the file, before any other imports that read env vars (per Pitfall 1 from research)
    - Call `configure_otel_providers()` immediately after load_dotenv (per research Pattern 4)
    - Create FastAPI app with `title="Second Brain AG-UI Server"` and a lifespan context manager
    - In the lifespan:
      - Create the echo agent via `create_echo_agent()`
      - Store the agent on `app.state.agent` for future reference
      - Register the AG-UI endpoint: `add_agent_framework_fastapi_endpoint(app, agent, "/api/ag-ui")` per locked decision (single POST `/api/ag-ui` endpoint)
      - NOTE: The agent and endpoint must be registered INSIDE the lifespan because `AzureOpenAIChatClient` needs the DefaultAzureCredential which requires async context. If `add_agent_framework_fastapi_endpoint` does not work inside lifespan, create the chat client and agent at module level and register the endpoint at module level (following the research Pattern 1 example).
    - Add a `/health` GET endpoint returning `{"status": "ok"}`
    - Add `if __name__ == "__main__"` block running uvicorn on 127.0.0.1:8000

    **IMPORTANT CONSTRAINTS:**
    - The research shows `add_agent_framework_fastapi_endpoint(app, agent, "/")` at module level. The CONTEXT decision says endpoint path is `/api/ag-ui`. Use `/api/ag-ui` per locked decision.
    - If registering the endpoint at module level (outside lifespan), create the agent at module level too. The research example does this. Follow the working pattern.
    - Do NOT add auth middleware yet — that is Plan 01-03.

    **tests/test_health.py:**
    - Test that GET `/health` returns 200 with `{"status": "ok"}`
    - Use `httpx.AsyncClient` with FastAPI's `ASGITransport`
    - Mock the lifespan to avoid needing real Azure credentials in tests

    **tests/test_agui_endpoint.py:**
    - Test that POST `/api/ag-ui` with a valid AG-UI message body returns SSE response (content-type: text/event-stream)
    - Test that the response contains expected AG-UI event types (RUN_STARTED, TEXT_MESSAGE_CONTENT, RUN_FINISHED)
    - Mock `AzureOpenAIChatClient` to avoid real LLM calls in tests
    - Use `pytest.mark.asyncio` for async tests

    Run the tests: `cd backend && uv run pytest tests/ -v`
  </action>
  <verify>
    1. `cd backend && uv run pytest tests/test_health.py tests/test_agui_endpoint.py -v` — all tests pass
    2. `cd backend && uv run ruff check . && uv run ruff format --check .` — no lint/format issues
    3. If Azure credentials are available: `cd backend && cp .env.example .env` (fill in real values), then `uv run uvicorn second_brain.main:app --reload` starts without errors, and `curl -s http://127.0.0.1:8000/health` returns `{"status":"ok"}`
  </verify>
  <done>
    FastAPI server starts cleanly, /health endpoint returns 200, AG-UI endpoint at /api/ag-ui accepts POST and returns streaming SSE responses, OpenTelemetry is configured via configure_otel_providers(), all tests pass.
  </done>
</task>

</tasks>

<verification>
1. Project structure matches the locked CONTEXT.md decision (monorepo, domain-based packages)
2. pyproject.toml installs all dependencies with uv
3. /health returns 200
4. POST to /api/ag-ui returns SSE response with AG-UI events
5. OpenTelemetry configured (ENABLE_INSTRUMENTATION env var respected)
6. All tests pass: `cd backend && uv run pytest -v`
7. No lint issues: `cd backend && uv run ruff check .`
</verification>

<success_criteria>
- The backend project scaffold exists at `backend/` with all expected directories and config
- `uv run uvicorn second_brain.main:app` starts without errors
- A POST to `/api/ag-ui` streams SSE events (RUN_STARTED, TEXT_MESSAGE_CONTENT, RUN_FINISHED)
- `/health` returns 200 with `{"status": "ok"}`
- `configure_otel_providers()` is called at startup
- All pytest tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>
