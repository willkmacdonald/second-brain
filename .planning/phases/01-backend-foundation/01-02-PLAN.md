---
phase: 01-backend-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - backend/src/second_brain/models/documents.py
  - backend/src/second_brain/db/cosmos.py
  - backend/src/second_brain/tools/cosmos_crud.py
  - backend/src/second_brain/main.py
  - backend/tests/test_cosmos_crud.py
  - backend/tests/conftest.py
autonomous: true
requirements:
  - INFRA-02

user_setup:
  - service: Azure Cosmos DB
    why: "NoSQL database for all document storage"
    env_vars:
      - name: COSMOS_ENDPOINT
        source: "Azure Portal -> Cosmos DB account -> Keys -> URI"
    dashboard_config:
      - task: "Create a Cosmos DB for NoSQL account (serverless capacity mode for hobby use)"
        location: "Azure Portal -> Create a resource -> Azure Cosmos DB -> NoSQL"
      - task: "Create database named 'second-brain'"
        location: "Azure Portal -> Cosmos DB account -> Data Explorer -> New Database"
      - task: "Create 5 containers (Inbox, People, Projects, Ideas, Admin) each with partition key /userId"
        location: "Azure Portal -> Cosmos DB account -> Data Explorer -> New Container (inside second-brain database)"

must_haves:
  truths:
    - "A document can be created in each of the 5 Cosmos DB containers (Inbox, People, Projects, Ideas, Admin)"
    - "A document can be read back by ID from each container"
    - "All documents share a common base schema (id, userId, createdAt, updatedAt, rawText, classificationMeta)"
    - "The Cosmos DB client is initialized once at startup and closed on shutdown (singleton pattern)"
    - "The echo agent can create and read documents via CRUD tools"
  artifacts:
    - path: "backend/src/second_brain/models/documents.py"
      provides: "Pydantic document schemas for all 5 containers"
      contains: "BaseDocument"
    - path: "backend/src/second_brain/db/cosmos.py"
      provides: "Cosmos DB async singleton client with container accessors"
      contains: "CosmosClient"
    - path: "backend/src/second_brain/tools/cosmos_crud.py"
      provides: "Agent Framework @tool functions for CRUD operations"
      contains: "@tool"
    - path: "backend/tests/test_cosmos_crud.py"
      provides: "Tests for CRUD tool operations"
      contains: "test_create"
  key_links:
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/db/cosmos.py"
      via: "lifespan initializes and closes Cosmos client"
      pattern: "cosmos"
    - from: "backend/src/second_brain/tools/cosmos_crud.py"
      to: "backend/src/second_brain/db/cosmos.py"
      via: "CRUD tools use container references from CosmosManager"
      pattern: "cosmos"
    - from: "backend/src/second_brain/tools/cosmos_crud.py"
      to: "backend/src/second_brain/models/documents.py"
      via: "Tools create/validate documents using Pydantic models"
      pattern: "BaseDocument"
    - from: "backend/src/second_brain/agents/echo.py"
      to: "backend/src/second_brain/tools/cosmos_crud.py"
      via: "Echo agent registered with CRUD tools"
      pattern: "tools="
---

<objective>
Create the Cosmos DB data layer: document schemas, async singleton client, CRUD tools for agents, and wire into the echo agent.

Purpose: Enable the backend to persist and retrieve documents in all 5 containers. The echo agent gains the ability to create and read documents via Agent Framework tools, proving the full data path works.

Output: Pydantic document models, Cosmos DB client singleton, @tool-decorated CRUD functions, tests, and the echo agent updated with CRUD tools.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md
@.planning/phases/01-backend-foundation/01-CONTEXT.md
@.planning/phases/01-backend-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic document models and Cosmos DB singleton client</name>
  <files>
    backend/src/second_brain/models/documents.py
    backend/src/second_brain/db/cosmos.py
    backend/src/second_brain/main.py
  </files>
  <action>
    **models/documents.py:**
    Create Pydantic models for the Cosmos DB document schemas per the locked CONTEXT.md decision: "Shared base schema across all containers (id, userId, createdAt, updatedAt, rawText, classificationMeta) with bucket-specific extensions."

    - `BaseDocument(BaseModel)`: Shared fields across all containers
      - `id: str` (default factory: `uuid4()` as string)
      - `userId: str` (default: `"will"` — single-user app per PROJECT.md)
      - `createdAt: datetime` (default factory: `datetime.utcnow`)
      - `updatedAt: datetime` (default factory: `datetime.utcnow`)
      - `rawText: str` (the original captured text)
      - `classificationMeta: dict | None = None` (classification details, populated by Classifier in Phase 3)

    - `InboxDocument(BaseDocument)`: No additional fields for Phase 1 (Inbox is the raw capture log)
      - Add `source: str = "text"` (capture source: text, voice, photo, video — only "text" for Phase 1)

    - `PeopleDocument(BaseDocument)`: Bucket-specific extensions
      - `name: str`
      - `context: str | None = None`
      - `birthday: str | None = None`
      - `contacts: dict | None = None`
      - `lastInteraction: datetime | None = None`

    - `ProjectsDocument(BaseDocument)`:
      - `title: str`
      - `status: str = "active"`
      - `nextAction: str | None = None`

    - `IdeasDocument(BaseDocument)`:
      - `title: str`
      - `tags: list[str] = []`

    - `AdminDocument(BaseDocument)`:
      - `title: str`
      - `nextAction: str | None = None`
      - `dueDate: str | None = None`

    Add a `CONTAINER_MODELS` dict mapping container name to model class: `{"Inbox": InboxDocument, "People": PeopleDocument, ...}`

    **db/cosmos.py:**
    Create a `CosmosManager` class that manages the async Cosmos DB client singleton. This class is justified per CLAUDE.md guidelines — it manages a stateful client with lifecycle (connection pool, startup/shutdown).

    - `CosmosManager`:
      - `__init__(self, endpoint: str, database_name: str)`: Store config, client not yet created
      - `async def initialize(self) -> None`: Create `DefaultAzureCredential` (from `azure.identity.aio`), create `AsyncCosmosClient` (from `azure.cosmos.aio`), get database client, get container clients for all 5 containers. Store containers in `self.containers: dict[str, ContainerProxy]`
      - `async def close(self) -> None`: Close Cosmos client and credential
      - `def get_container(self, name: str) -> ContainerProxy`: Return container by name, raise ValueError if not found
      - Container names constant: `CONTAINER_NAMES = ["Inbox", "People", "Projects", "Ideas", "Admin"]`
      - Partition key path constant: `PARTITION_KEY = "/userId"`

    IMPORTANT: Use `from azure.cosmos.aio import CosmosClient` (ASYNC, not sync — per Pitfall 2 from research). All Cosmos operations must be `await`ed.

    **main.py updates:**
    - Import `CosmosManager` from `db.cosmos`
    - In the lifespan context manager:
      - Create `CosmosManager(endpoint=settings.cosmos_endpoint, database_name=settings.database_name)`
      - Call `await cosmos_manager.initialize()`
      - Store `app.state.cosmos_manager = cosmos_manager`
      - In cleanup (after yield): `await cosmos_manager.close()`
  </action>
  <verify>
    1. `cd backend && uv run python -c "from second_brain.models.documents import BaseDocument, InboxDocument, PeopleDocument, ProjectsDocument, IdeasDocument, AdminDocument, CONTAINER_MODELS; print('Models OK:', list(CONTAINER_MODELS.keys()))"` — prints all 5 container names
    2. `cd backend && uv run python -c "from second_brain.db.cosmos import CosmosManager; print('CosmosManager OK')"` — imports without error
    3. `cd backend && uv run ruff check . && uv run ruff format --check .` — no lint/format issues
  </verify>
  <done>
    Pydantic document models exist for all 5 containers with shared base schema and bucket-specific extensions. CosmosManager class initializes async Cosmos client and provides container accessors. Lifespan in main.py creates and closes CosmosManager.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CRUD tools, wire into echo agent, and add tests</name>
  <files>
    backend/src/second_brain/tools/cosmos_crud.py
    backend/src/second_brain/agents/echo.py
    backend/tests/test_cosmos_crud.py
    backend/tests/conftest.py
  </files>
  <action>
    **tools/cosmos_crud.py:**
    Create Agent Framework @tool functions for Cosmos DB CRUD operations. Use the class-based tool pattern from the research (recommended for binding Cosmos container references without module-level globals).

    `CosmosCrudTools` class:
    - `__init__(self, cosmos_manager: CosmosManager)`: Store manager reference
    - This class is justified per CLAUDE.md — it manages stateful references to Cosmos containers (not a single-method class or namespace).

    Tools (all async, all decorated with `@tool`):
    - `create_document(self, container_name: Annotated[str, "Target container: Inbox, People, Projects, Ideas, or Admin"], raw_text: Annotated[str, "The raw captured text"], title: Annotated[str, "Title or name for the record"] = "") -> str`:
      Create a document using the appropriate Pydantic model from CONTAINER_MODELS. Set `userId="will"`. Return confirmation with document ID.
    - `read_document(self, container_name: Annotated[str, "Container name"], document_id: Annotated[str, "Document ID to read"]) -> str`:
      Read a single document by ID. Partition key is `"will"`. Return JSON string of the document.
    - `list_documents(self, container_name: Annotated[str, "Container name"], max_items: Annotated[int, "Maximum items to return"] = 10) -> str`:
      Query documents from container. Use `query_items()` with `SELECT TOP @max_items * FROM c WHERE c.userId = @userId`. Return JSON string of results.

    NOTE: All tool return types MUST be `str` (per research tool type constraints). Serialize complex data with `json.dumps()`.

    **agents/echo.py updates:**
    - Update `create_echo_agent()` to accept a `cosmos_manager: CosmosManager` parameter
    - Create `CosmosCrudTools(cosmos_manager)` instance
    - Pass tool instance methods to the agent: `tools=[crud_tools.create_document, crud_tools.read_document, crud_tools.list_documents]`
    - Update instructions to mention the agent can create and read documents: "You are a test agent for the Second Brain system. You can create and read documents in the Inbox, People, Projects, Ideas, and Admin containers. Echo back what the user says and confirm operations."

    **main.py updates:**
    - Pass `cosmos_manager` to `create_echo_agent()` in the lifespan

    **tests/conftest.py updates:**
    - Add a `mock_cosmos_manager` fixture that returns a mock CosmosManager with mock containers
    - Each mock container should have `create_item`, `read_item`, `query_items` async mocks

    **tests/test_cosmos_crud.py:**
    - Test `create_document` tool creates document with correct schema fields (id, userId, createdAt, rawText)
    - Test `create_document` uses the right Pydantic model for each container name
    - Test `read_document` reads from correct container with correct partition key
    - Test `list_documents` returns serialized JSON string
    - Test invalid container name returns error message (not exception)
    - All tests use mocked CosmosManager (no real Azure calls)

    Run: `cd backend && uv run pytest tests/ -v`
  </action>
  <verify>
    1. `cd backend && uv run pytest tests/test_cosmos_crud.py -v` — all CRUD tool tests pass
    2. `cd backend && uv run pytest tests/ -v` — all tests pass (including prior health and AG-UI tests)
    3. `cd backend && uv run ruff check . && uv run ruff format --check .` — no lint/format issues
    4. `cd backend && uv run python -c "from second_brain.tools.cosmos_crud import CosmosCrudTools; print('CRUD tools OK')"` — imports without error
  </verify>
  <done>
    CosmosCrudTools class provides create_document, read_document, and list_documents @tool functions. Echo agent is wired with CRUD tools. All tests pass with mocked Cosmos DB. Documents use correct Pydantic models per container.
  </done>
</task>

</tasks>

<verification>
1. All 5 Pydantic document models exist with shared base schema
2. CosmosManager initializes async client and provides container accessors
3. CRUD tools create/read/list documents using correct Pydantic models
4. Echo agent has CRUD tools registered
5. main.py lifespan initializes and closes CosmosManager
6. All tests pass: `cd backend && uv run pytest -v`
7. No lint issues: `cd backend && uv run ruff check .`
</verification>

<success_criteria>
- Pydantic models validate documents for all 5 containers with shared base + bucket extensions
- CosmosManager connects, provides containers, and cleans up on shutdown
- Agent @tool functions can create, read, and list documents (verified via unit tests with mocks)
- Echo agent is registered with CRUD tools
- All pytest tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-02-SUMMARY.md`
</output>
