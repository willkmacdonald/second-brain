---
phase: 07-classifier-agent-baseline
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - backend/src/second_brain/main.py
  - backend/tests/conftest.py
  - backend/tests/test_classifier_integration.py
  - backend/tests/test_health.py
autonomous: true
requirements: [AGNT-01, AGNT-03, AGNT-06]

must_haves:
  truths:
    - "Classifier agent is registered at app startup with self-healing (creates if missing, loads if existing)"
    - "Agent persists across process restarts via should_cleanup_agent=False and stored agent ID"
    - "Integration test creates a Foundry thread, sends a message, and verifies the agent calls file_capture"
    - "Middleware is attached to the agent and fires during agent runs"
    - "App fails to start if Classifier agent registration fails"
  artifacts:
    - path: "backend/src/second_brain/main.py"
      provides: "Agent registration in lifespan + ClassifierTools and agent on app.state"
      contains: "ensure_classifier_agent"
    - path: "backend/tests/test_classifier_integration.py"
      provides: "Integration test for Classifier agent end-to-end"
      contains: "test_classifier_agent_classifies_text"
    - path: "backend/tests/conftest.py"
      provides: "Updated fixtures for Foundry agent testing"
      contains: "mock_cosmos_manager"
  key_links:
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/agents/classifier.py"
      via: "ensure_classifier_agent() called in lifespan"
      pattern: "ensure_classifier_agent"
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "ClassifierTools instantiated with cosmos_manager"
      pattern: "ClassifierTools"
    - from: "backend/src/second_brain/main.py"
      to: "backend/src/second_brain/agents/middleware.py"
      via: "AuditAgentMiddleware and ToolTimingMiddleware passed to create_agent()"
      pattern: "AuditAgentMiddleware|ToolTimingMiddleware"
---

<objective>
Wire agent registration into the FastAPI lifespan, create the Classifier agent on app.state with tools and middleware attached, and validate with an integration test.

Purpose: Connect all the building blocks from Plan 01 into the running application. After this plan, the backend starts up with a persistent Foundry Classifier agent ready to process classifications.

Output: Updated main.py with agent registration, integration test proving end-to-end classification
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-classifier-agent-baseline/07-CONTEXT.md
@.planning/phases/07-classifier-agent-baseline/07-RESEARCH.md
@.planning/phases/07-classifier-agent-baseline/07-01-SUMMARY.md
@.planning/phases/06-foundry-infrastructure/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire agent registration and tools into FastAPI lifespan</name>
  <files>
    backend/src/second_brain/main.py
  </files>
  <action>
Update the `lifespan()` function in `main.py` to register the Classifier agent and create it with tools and middleware:

**After** the existing Foundry client initialization block (the `app.state.foundry_client = foundry_client` section), add:

1. **Call `ensure_classifier_agent()`** to verify/create the Classifier agent in Foundry:
   ```python
   from second_brain.agents.classifier import ensure_classifier_agent

   classifier_agent_id = await ensure_classifier_agent(
       foundry_client=foundry_client,
       stored_agent_id=settings.azure_ai_classifier_agent_id,
   )
   app.state.classifier_agent_id = classifier_agent_id
   ```
   This is inside the existing try/except block where Foundry client init fails fast. If `ensure_classifier_agent` raises, the app crashes (per CONTEXT.md: hard dependency).

2. **Create ClassifierTools** with the CosmosManager:
   ```python
   from second_brain.tools.classification import ClassifierTools

   classifier_tools = ClassifierTools(
       cosmos_manager=cosmos_mgr,
       classification_threshold=settings.classification_threshold,
   )
   app.state.classifier_tools = classifier_tools
   ```
   NOTE: This must come AFTER the CosmosManager initialization block. If cosmos_mgr is None (Cosmos init failed), pass None -- the tools will fail at runtime when called, which is acceptable since Cosmos is a soft dependency for startup.

3. **Create TranscriptionTools** (optional -- only if blob storage is configured):
   ```python
   from second_brain.tools.transcription import TranscriptionTools
   from openai import AsyncAzureOpenAI
   from azure.identity.aio import get_bearer_token_provider

   # AsyncAzureOpenAI for gpt-4o-transcribe (separate from Foundry client)
   # Uses cognitiveservices scope (different from Foundry's ai.azure.com scope)
   if settings.azure_openai_endpoint:
       token_provider = get_bearer_token_provider(
           credential, "https://cognitiveservices.azure.com/.default"
       )
       openai_client = AsyncAzureOpenAI(
           azure_endpoint=settings.azure_openai_endpoint,
           azure_ad_token_provider=token_provider,
           api_version="2025-04-01-preview",
       )
       app.state.openai_client = openai_client
   else:
       openai_client = None
       app.state.openai_client = None
       logger.warning("AZURE_OPENAI_ENDPOINT not set -- transcription unavailable")
   ```
   NOTE: The `get_bearer_token_provider` is from `azure.identity.aio` (the async version). Per research pitfall #4, the transcription API uses the `cognitiveservices.azure.com` scope, NOT the Foundry `ai.azure.com` scope.

   If blob storage and OpenAI are configured, create the TranscriptionTools:
   ```python
   from second_brain.db.blob_storage import BlobStorageManager

   if openai_client and settings.blob_storage_url:
       blob_manager = BlobStorageManager(account_url=settings.blob_storage_url)
       await blob_manager.initialize()
       app.state.blob_manager = blob_manager

       transcription_tools = TranscriptionTools(
           openai_client=openai_client,
           blob_manager=blob_manager,
           credential=credential,
           deployment_name=settings.azure_openai_transcription_deployment,
       )
       app.state.transcription_tools = transcription_tools
   else:
       app.state.blob_manager = None
       app.state.transcription_tools = None
   ```

4. **Create the Classifier agent** using `AzureAIAgentClient.create_agent()` with tools and middleware:
   ```python
   from second_brain.agents.middleware import AuditAgentMiddleware, ToolTimingMiddleware

   # Build tool list (file_capture always, transcribe_audio only if configured)
   agent_tools = [classifier_tools.file_capture]
   if app.state.transcription_tools:
       agent_tools.append(app.state.transcription_tools.transcribe_audio)

   # Create a new AzureAIAgentClient with the validated agent_id
   classifier_client = AzureAIAgentClient(
       credential=credential,
       project_endpoint=settings.azure_ai_project_endpoint,
       agent_id=classifier_agent_id,
       should_cleanup_agent=False,
   )

   classifier_agent = classifier_client.create_agent(
       tools=agent_tools,
       middleware=[AuditAgentMiddleware(), ToolTimingMiddleware()],
   )
   app.state.classifier_agent = classifier_agent
   app.state.classifier_client = classifier_client
   ```
   NOTE: A separate `AzureAIAgentClient` is created for the classifier with `agent_id` set (different from the probe-only client created in Phase 6). The `should_cleanup_agent=False` flag is critical (AGNT-03).

5. **Add cleanup** in the `finally` or post-yield cleanup section:
   - Close `openai_client` if it exists
   - Close `blob_manager` if it exists
   - Close `classifier_client` if it exists

6. **Log summary**: After all initialization, log the agent state:
   ```python
   logger.info(
       "Classifier agent ready: id=%s tools=%d middleware=2",
       classifier_agent_id,
       len(agent_tools),
   )
   ```

**Important ordering in lifespan:**
1. Credential (existing)
2. Key Vault (existing)
3. Cosmos DB (existing)
4. Foundry probe client (existing)
5. **ensure_classifier_agent** (new -- uses foundry_client)
6. **ClassifierTools** (new -- uses cosmos_mgr)
7. **TranscriptionTools** (new -- uses openai_client + blob_manager)
8. **Classifier agent** (new -- uses classifier_agent_id + tools + middleware)
9. Yield
10. Cleanup (close clients in reverse order)

**Remove** the `model_deployment_name="gpt-4o"` parameter from the existing Foundry probe client creation -- per 06-02 SUMMARY decision, this was only needed because Phase 6 had no agent_id. Now that Phase 7 sets up the agent, the probe client can keep `model_deployment_name` for the probe-only client (it still has no agent_id). Leave it as-is.
  </action>
  <verify>
Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -c "from second_brain.main import app; print('main.py imports OK')"` -- must succeed (verifies no import errors in the wiring).

Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check src/second_brain/main.py` -- no errors.
  </verify>
  <done>
FastAPI lifespan registers the Classifier agent at startup via ensure_classifier_agent(), creates ClassifierTools and TranscriptionTools with dependency injection, creates the agent with tools and middleware via AzureAIAgentClient.create_agent(), and stores everything on app.state. Agent cleanup is handled on shutdown. should_cleanup_agent=False prevents agent deletion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration test and update test fixtures</name>
  <files>
    backend/tests/test_classifier_integration.py
    backend/tests/conftest.py
    backend/tests/test_health.py
  </files>
  <action>
**Create `test_classifier_integration.py`** -- new integration test file:

1. Mark with `@pytest.mark.integration` so it is skipped in normal test runs (per 06-03 pattern: `pytest -m "not integration"` for CI)
2. Add a `skipif` condition: skip if `AZURE_AI_PROJECT_ENDPOINT` or `AZURE_AI_CLASSIFIER_AGENT_ID` env vars are not set
3. Test function `test_classifier_agent_classifies_text`:
   - Create `AsyncDefaultAzureCredential`
   - Create `AzureAIAgentClient` with the agent_id from settings and `should_cleanup_agent=False`
   - Create `ClassifierTools` with a mock CosmosManager (use the `mock_cosmos_manager` fixture pattern from conftest.py, but inline since integration tests should be self-contained)
   - Create the agent via `client.create_agent(tools=[classifier_tools.file_capture], middleware=[])`
   - Run the agent: `result = await agent.run("Pick up prescription at Walgreens")`
   - Assert `result.text is not None` (the agent produced a response)
   - Assert the mock CosmosManager's Inbox container `create_item` was called (the agent invoked file_capture which wrote to Cosmos)
   - Inspect the Inbox create_item call body: assert `status` is one of ("classified", "pending", "misunderstood")
   - Clean up: close credential

4. Test function `test_classifier_agent_id_is_valid`:
   - Simpler test: just verify the stored agent_id is retrievable from Foundry
   - Create `AzureAIAgentClient`, call `agents_client.get_agent(agent_id)`
   - Assert the agent's name is "Classifier"
   - This validates AGNT-01 (agent visible in Foundry with stable ID)

**Update `conftest.py`**:
- No structural changes needed -- the existing `mock_cosmos_manager` fixture works for Plan 01's tests
- If any test files import the old `ClassificationTools` name, the rename to `ClassifierTools` in Plan 01's test updates already handles this

**Update `test_health.py`** (if needed):
- The health endpoint may need updating if the agent registration changes affect the health check
- Check: does `health.py` reference any agent state? If not, no changes needed
- If health.py was updated to report `foundry: connected` in Phase 6, it should still work since the Foundry probe client is still initialized the same way

Run the full test suite (excluding integration) to make sure nothing is broken:
```bash
cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend
python3 -m pytest tests/ -v -m "not integration"
```

Run lint on all test files:
```bash
ruff check tests/
```
  </action>
  <verify>
Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -m pytest tests/ -v -m "not integration"` -- all unit tests pass.

Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && python3 -c "from tests.test_classifier_integration import *; print('integration test imports OK')"` -- imports succeed (actual execution requires live Azure credentials).

Run `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && ruff check tests/` -- no lint errors.
  </verify>
  <done>
Integration test file exists with test_classifier_agent_classifies_text (sends text to Classifier, asserts tool invocation) and test_classifier_agent_id_is_valid (verifies agent is retrievable from Foundry). All unit tests pass. Integration tests are marked to skip without live Azure credentials.
  </done>
</task>

</tasks>

<verification>
1. `python3 -m pytest tests/ -v -m "not integration"` -- all unit tests pass
2. `python3 -c "from second_brain.main import app"` -- main.py imports cleanly with full wiring
3. `ruff check src/ tests/` -- no lint errors
4. `grep "ensure_classifier_agent" src/second_brain/main.py` -- agent registration wired in lifespan
5. `grep "should_cleanup_agent=False" src/second_brain/main.py` -- persistence flag set
6. `grep "AuditAgentMiddleware\|ToolTimingMiddleware" src/second_brain/main.py` -- middleware wired
7. Integration test exists at `tests/test_classifier_integration.py` with `@pytest.mark.integration`
</verification>

<success_criteria>
- Backend starts without errors when Foundry credentials are valid
- Classifier agent is registered at startup (creates if missing, loads if existing)
- Agent is created with file_capture tool and both middleware classes
- TranscriptionTools are initialized when AZURE_OPENAI_ENDPOINT is configured
- should_cleanup_agent=False prevents agent deletion on shutdown
- Integration test validates agent can classify text and invoke file_capture
- All unit tests pass (no regressions from Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/07-classifier-agent-baseline/07-02-SUMMARY.md`
</output>
