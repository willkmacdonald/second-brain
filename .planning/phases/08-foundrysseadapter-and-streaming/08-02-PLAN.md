---
phase: 08-foundrysseadapter-and-streaming
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - mobile/lib/types.ts
  - mobile/lib/ag-ui-client.ts
autonomous: true
requirements: [STRM-01, STRM-02, STRM-03]

must_haves:
  truths:
    - "Mobile event parser handles new top-level event types (CLASSIFIED, MISUNDERSTOOD, UNRESOLVED, COMPLETE, STEP_START, STEP_END, ERROR)"
    - "Mobile event parser also handles old event names during development (backward compatibility)"
    - "sendCapture sends to /api/capture with text field in JSON body"
    - "sendVoiceCapture sends to /api/capture/voice with multipart audio"
    - "CLASSIFIED event with value.bucket and value.confidence triggers onComplete with formatted result string"
    - "ERROR event triggers onError callback"
  artifacts:
    - path: "mobile/lib/types.ts"
      provides: "Updated AGUIEventType union with new event type strings"
      contains: "STEP_START"
    - path: "mobile/lib/ag-ui-client.ts"
      provides: "Updated event parser and endpoint URLs for v2 API"
      contains: "/api/capture"
  key_links:
    - from: "mobile/lib/ag-ui-client.ts"
      to: "backend POST /api/capture"
      via: "EventSource URL"
      pattern: "/api/capture"
    - from: "mobile/lib/ag-ui-client.ts"
      to: "backend POST /api/capture/voice"
      via: "EventSource URL"
      pattern: "/api/capture/voice"
---

<objective>
Update the mobile Expo app's SSE event parser and endpoint URLs to work with the new v2 streaming API (POST /api/capture with new event type names).

Purpose: The backend from Plan 01 emits new event types (STEP_START, CLASSIFIED, COMPLETE, etc.) at new URLs (/api/capture). The mobile client must understand these events for captures to work end-to-end.

Output: Updated types.ts and ag-ui-client.ts.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-foundrysseadapter-and-streaming/08-CONTEXT.md
@.planning/phases/08-foundrysseadapter-and-streaming/08-01-PLAN.md
@mobile/lib/types.ts
@mobile/lib/ag-ui-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types.ts with new event type strings</name>
  <files>mobile/lib/types.ts</files>
  <action>
Update `AGUIEventType` union to include both old and new event type strings for backward compatibility during development:

```typescript
export type AGUIEventType =
  | "message"
  // New v2 event types
  | "STEP_START"
  | "STEP_END"
  | "CLASSIFIED"
  | "MISUNDERSTOOD"
  | "UNRESOLVED"
  | "COMPLETE"
  | "ERROR"
  // Legacy v1 event types (backward compat during dev)
  | "RUN_STARTED"
  | "TEXT_MESSAGE_START"
  | "TEXT_MESSAGE_CONTENT"
  | "TEXT_MESSAGE_END"
  | "STEP_STARTED"
  | "STEP_FINISHED"
  | "TOOL_CALL_START"
  | "TOOL_CALL_END"
  | "CUSTOM"
  | "RUN_FINISHED"
  | "RUN_ERROR";
```

The `StreamingCallbacks` interface stays UNCHANGED -- the callback names (onStepStart, onStepFinish, onHITLRequired, onMisunderstood, onUnresolved, onComplete, onError) already match the behavior needed. The event parser in ag-ui-client.ts maps event types to these callbacks.

The `SendCaptureOptions`, `SendClarificationOptions`, `SendFollowUpOptions`, `SendVoiceCaptureOptions` interfaces stay UNCHANGED.
  </action>
  <verify>
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit --pretty 2>&1 | head -20` -- no TypeScript errors related to types.ts (some unrelated errors may exist from other files).
  </verify>
  <done>
AGUIEventType union includes both new v2 types (STEP_START, STEP_END, CLASSIFIED, MISUNDERSTOOD, UNRESOLVED, COMPLETE, ERROR) and legacy v1 types for backward compatibility. StreamingCallbacks interface unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ag-ui-client.ts event parser and endpoint URLs</name>
  <files>mobile/lib/ag-ui-client.ts</files>
  <action>
Two changes: (1) Update `attachCallbacks` to handle new event types, (2) Update endpoint URLs.

**1. Update `attachCallbacks` switch statement** to handle BOTH old and new event names:

Update the `AGUIEventPayload` interface to include the new fields that CLASSIFIED/MISUNDERSTOOD/UNRESOLVED carry at the top level:
```typescript
interface AGUIEventPayload {
  type?: string;
  delta?: string;
  name?: string;
  stepName?: string;
  message?: string;  // NEW: for ERROR events
  threadId?: string;  // NEW: for COMPLETE events
  runId?: string;     // NEW: for COMPLETE events
  value?: {
    threadId?: string;
    inboxItemId?: string;
    questionText?: string;
    bucket?: string;      // NEW: for CLASSIFIED
    confidence?: number;  // NEW: for CLASSIFIED
  };
}
```

Update the switch statement in `attachCallbacks` to handle new event types alongside old ones:

```typescript
switch (parsed.type) {
  // --- New v2 events ---
  case "STEP_START":
  case "STEP_STARTED":  // legacy compat
    callbacks.onStepStart?.(parsed.stepName ?? "Unknown");
    break;

  case "STEP_END":
  case "STEP_FINISHED":  // legacy compat
    callbacks.onStepFinish?.(parsed.stepName ?? "Unknown");
    break;

  case "CLASSIFIED":
    // New v2: CLASSIFIED is top-level, result in value
    if (parsed.value) {
      const bucket = parsed.value.bucket ?? "?";
      const confidence = parsed.value.confidence ?? 0;
      const inboxItemId = parsed.value.inboxItemId ?? "";
      result = `Filed -> ${bucket} (${confidence.toFixed(2)})`;
      callbacks.onComplete(result);
    }
    break;

  case "MISUNDERSTOOD":
    // New v2: MISUNDERSTOOD is top-level
    if (parsed.value?.inboxItemId) {
      hitlTriggered = true;
      callbacks.onMisunderstood?.(
        parsed.value.threadId ?? "",
        parsed.value.questionText ?? "",
        parsed.value.inboxItemId,
      );
    }
    break;

  case "UNRESOLVED":
    // New v2: UNRESOLVED is top-level
    if (parsed.value?.inboxItemId) {
      callbacks.onUnresolved?.(parsed.value.inboxItemId);
    }
    break;

  case "COMPLETE":
  case "RUN_FINISHED":  // legacy compat
    if (!hitlTriggered) {
      // For COMPLETE: if result was already set by CLASSIFIED, onComplete already fired.
      // For RUN_FINISHED (legacy): fire onComplete with accumulated result.
      if (parsed.type === "RUN_FINISHED") {
        callbacks.onComplete(result);
      }
    }
    es.close();
    break;

  case "ERROR":
  case "RUN_ERROR":  // legacy compat
    callbacks.onError(parsed.message ?? "Run failed");
    es.close();
    break;

  // --- Legacy v1 events (keep during dev) ---
  case "TEXT_MESSAGE_CONTENT":
    if (parsed.delta) {
      result += parsed.delta;
      callbacks.onTextDelta?.(parsed.delta);
    }
    break;

  case "CUSTOM":
    // Legacy v1 wrapper -- handle for backward compat
    if (parsed.name === "HITL_REQUIRED" && parsed.value?.threadId) {
      hitlTriggered = true;
      const questionText = parsed.value.questionText || result;
      const inboxItemId = parsed.value.inboxItemId;
      callbacks.onHITLRequired?.(parsed.value.threadId, questionText, inboxItemId);
    }
    if (parsed.name === "MISUNDERSTOOD" && parsed.value?.inboxItemId) {
      hitlTriggered = true;
      callbacks.onMisunderstood?.(
        parsed.value.threadId ?? "",
        parsed.value.questionText ?? "",
        parsed.value.inboxItemId,
      );
    }
    if (parsed.name === "UNRESOLVED" && parsed.value?.inboxItemId) {
      callbacks.onUnresolved?.(parsed.value.inboxItemId);
    }
    break;
}
```

IMPORTANT edge case: With the new v2 events, `CLASSIFIED` calls `onComplete` immediately (result is in the event payload). Then `COMPLETE` follows but should NOT call onComplete again. Guard this by checking: in the COMPLETE handler, only call `onComplete(result)` for legacy `RUN_FINISHED` events. For `COMPLETE` events, just close the EventSource since CLASSIFIED already handled the callback.

**2. Update `sendCapture` endpoint URL and request body:**

Change from:
```typescript
const es = new EventSource<AGUIEventType>(`${API_BASE_URL}/api/ag-ui`, {
  ...
  body: JSON.stringify({
    messages: [{ id: ..., role: "user", content: message }],
    thread_id: threadId,
    run_id: runId,
  }),
```

To:
```typescript
const es = new EventSource<AGUIEventType>(`${API_BASE_URL}/api/capture`, {
  ...
  body: JSON.stringify({
    text: message,
    thread_id: threadId,
    run_id: runId,
  }),
```

The new backend expects `{ text: string, thread_id?: string, run_id?: string }` -- NOT the old `{ messages: [...] }` format.

**3. Update `sendVoiceCapture` endpoint URL:**

Change from `${API_BASE_URL}/api/voice-capture` to `${API_BASE_URL}/api/capture/voice`.

**4. Keep `sendClarification` and `sendFollowUp` unchanged for now** -- their endpoints (/api/ag-ui/respond and /api/ag-ui/follow-up) will be updated in Phase 9 when HITL parity is addressed. They still use the old event format which the backward-compat parser handles.

Update the JSDoc comment on `attachCallbacks` to document that it handles both v1 and v2 event types.
  </action>
  <verify>
Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit --pretty 2>&1 | head -30` -- no TypeScript errors in ag-ui-client.ts or types.ts.
Manually verify: grep for "/api/capture" in ag-ui-client.ts -- should appear for sendCapture and sendVoiceCapture.
Manually verify: grep for "STEP_START" in ag-ui-client.ts -- new event types handled.
Manually verify: grep for "CUSTOM" in ag-ui-client.ts -- legacy handler still present for backward compat.
  </verify>
  <done>
Event parser handles both v2 (STEP_START, STEP_END, CLASSIFIED, MISUNDERSTOOD, UNRESOLVED, COMPLETE, ERROR) and legacy v1 (STEP_STARTED, STEP_FINISHED, CUSTOM, RUN_FINISHED, TEXT_MESSAGE_CONTENT) event types. sendCapture points to /api/capture with `{text}` body. sendVoiceCapture points to /api/capture/voice. sendClarification and sendFollowUp unchanged (Phase 9). No double-firing of onComplete when CLASSIFIED is followed by COMPLETE.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx tsc --noEmit --pretty 2>&1 | head -30` -- no TypeScript errors in modified files
2. Verify /api/capture URL in sendCapture function
3. Verify /api/capture/voice URL in sendVoiceCapture function
4. Verify STEP_START, CLASSIFIED, COMPLETE cases in switch statement
5. Verify legacy CUSTOM, RUN_FINISHED, TEXT_MESSAGE_CONTENT cases still present
6. Verify CLASSIFIED fires onComplete with formatted bucket string, and COMPLETE does not double-fire
</verification>

<success_criteria>
- types.ts has new event type strings in AGUIEventType union
- ag-ui-client.ts handles both new v2 and legacy v1 event types
- sendCapture sends to /api/capture with text field (not messages array)
- sendVoiceCapture sends to /api/capture/voice
- No TypeScript compilation errors in modified files
- Backward compatibility maintained for sendClarification and sendFollowUp (Phase 9 scope)
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundrysseadapter-and-streaming/08-02-SUMMARY.md`
</output>
