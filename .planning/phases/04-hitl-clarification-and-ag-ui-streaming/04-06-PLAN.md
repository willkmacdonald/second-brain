---
phase: 04-hitl-clarification-and-ag-ui-streaming
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/agents/workflow.py
  - backend/src/second_brain/main.py
  - mobile/app/conversation/[threadId].tsx
  - mobile/app/(tabs)/inbox.tsx
autonomous: true
requirements: [CLAS-04, APPX-04]
gap_closure: true

must_haves:
  truths:
    - "Ambiguous capture triggers HITL clarifying question on capture screen instead of being auto-filed"
    - "Selecting a bucket on conversation screen files the capture and updates status from pending to classified"
    - "Navigating back to inbox after filing shows the updated (non-pending) item without manual pull-to-refresh"
  artifacts:
    - path: "backend/src/second_brain/agents/workflow.py"
      provides: "Classifier removed from autonomous mode to allow HITL pause"
      contains: "with_autonomous_mode"
    - path: "backend/src/second_brain/main.py"
      provides: "Respond endpoint returns error when inbox_item_id is missing"
      contains: "RUN_ERROR"
    - path: "mobile/app/conversation/[threadId].tsx"
      provides: "Fixed useCallback dependency array includes item"
      contains: "item"
    - path: "mobile/app/(tabs)/inbox.tsx"
      provides: "Auto-refresh on screen focus via useFocusEffect"
      contains: "useFocusEffect"
  key_links:
    - from: "mobile/app/conversation/[threadId].tsx"
      to: "/api/ag-ui/respond"
      via: "sendClarification with inboxItemId from item.id"
      pattern: "inboxItemId:\\s*item\\?\\.id"
    - from: "backend/src/second_brain/agents/workflow.py"
      to: "HandoffBuilder"
      via: "autonomous_mode only includes orchestrator"
      pattern: "agents=\\[self\\._orchestrator\\]"
---

<objective>
Close two UAT gaps from Phase 04 user acceptance testing:

1. HITL clarification not triggering (Test 5): Classifier in autonomous mode gets re-run after request_clarification, overriding the HITL flow.
2. Filing from conversation screen fails silently (Test 11): useCallback closure bug sends null inboxItemId, backend skips DB write but claims success.

Purpose: These are the final two blockers preventing the HITL clarification flow from working end-to-end.
Output: Fixed backend workflow and respond endpoint, fixed mobile conversation and inbox screens.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-UAT.md
@.planning/debug/hitl-not-triggering.md
@.planning/debug/filing-remains-pending.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — Remove Classifier from autonomous mode and harden respond endpoint</name>
  <files>
    backend/src/second_brain/agents/workflow.py
    backend/src/second_brain/main.py
  </files>
  <action>
**workflow.py — Remove Classifier from autonomous mode (root cause of Test 5):**

In `_create_workflow()` method (around line 97), change the `with_autonomous_mode` call to only include the Orchestrator:

```python
.with_autonomous_mode(
    agents=[self._orchestrator],
    prompts={
        self._orchestrator.name: "Route this input to the Classifier.",
    },
)
```

Remove `self._classifier` from the agents list and remove `self._classifier.name: "Classify this text and file it."` from the prompts dict. This is the complete fix: without autonomous mode, after the Classifier calls `request_clarification`, the framework emits a `request_info` event and the workflow pauses. The adapter already detects the "Clarification -> ..." text in the stream and emits HITL_REQUIRED. For high-confidence cases, the Classifier calls `classify_and_file`, produces its response, framework emits `request_info`, adapter detects "Filed -> ..." text and completes normally.

Update the docstring on `_create_workflow` to reflect that only the Orchestrator runs in autonomous mode (the Classifier pauses for HITL when it calls request_clarification).

**main.py — Harden respond endpoint error handling (secondary fix for Test 11):**

1. When `body.inbox_item_id` is None or empty, return an error via SSE instead of silently claiming success. After the `RunStartedEvent`, add a guard:

```python
if not body.inbox_item_id:
    yield encoder.encode(
        TextMessageStartEvent(message_id=msg_id, role="assistant")
    )
    yield encoder.encode(
        TextMessageContentEvent(
            message_id=msg_id,
            delta="Error: No inbox item ID provided",
        )
    )
    yield encoder.encode(TextMessageEndEvent(message_id=msg_id))
    yield encoder.encode(RunFinishedEvent(thread_id=body.thread_id, run_id=run_id))
    return
```

2. Replace the bare `except Exception:` on the inner try/except (around line 414) with proper error reporting. Log the full exception with `logger.exception(...)` and emit an error message via SSE text events so the client knows filing actually failed:

```python
except Exception:
    logger.exception(
        "Failed to process inbox item %s", body.inbox_item_id
    )
    result = "Error: Could not file capture. Please try again."
```

This ensures the client receives truthful error messages instead of fake success.
  </action>
  <verify>
Run the backend tests to ensure nothing is broken:

```bash
cd backend && python3 -m pytest tests/ -v
```

Verify workflow.py changes by grepping:
```bash
grep -n "with_autonomous_mode" backend/src/second_brain/agents/workflow.py
grep -n "agents=\[self._orchestrator\]" backend/src/second_brain/agents/workflow.py
```

Verify respond endpoint error guard:
```bash
grep -n "inbox_item_id" backend/src/second_brain/main.py
```
  </verify>
  <done>
Classifier is NOT in the autonomous mode agents list. Only the Orchestrator is autonomous. Respond endpoint returns an error SSE message when inbox_item_id is missing. Bare except is replaced with logger.exception and error message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile — Fix useCallback closure bug, add inbox auto-refresh, deduplicate FlatList keys</name>
  <files>
    mobile/app/conversation/[threadId].tsx
    mobile/app/(tabs)/inbox.tsx
  </files>
  <action>
**conversation/[threadId].tsx — Fix useCallback dependency array (root cause of Test 11):**

Add `item` to the `useCallback` dependency array for `handleBucketSelect` (line 99):

```typescript
[threadId, isResolving, item]
```

This ensures the callback re-creates when `item` loads from the API, so `item?.id` is the real Cosmos document ID (not null). The `inboxItemId: item?.id` in `sendClarification` will then send the correct value to the backend.

**inbox.tsx — Add auto-refresh on screen focus:**

1. Add `useFocusEffect` import from `@react-navigation/native` (expo-router re-exports this):

```typescript
import { router, useNavigation, useFocusEffect } from "expo-router";
```

2. Replace the `useEffect` on mount (around line 69-72) with a `useFocusEffect` that refetches inbox data every time the screen gains focus. This handles the case where the user files an item on the conversation screen and navigates back:

```typescript
useFocusEffect(
  useCallback(() => {
    void fetchInbox();
  }, [fetchInbox])
);
```

Remove the old `useEffect([], [])` that only fetched on mount.

3. **Deduplicate items in handleLoadMore** to fix the "two children with same key" React warning. When appending paginated results, filter out items whose IDs already exist in the current list:

```typescript
if (append) {
  setItems((prev) => {
    const existingIds = new Set(prev.map((i) => i.id));
    const newItems = data.items.filter((i: InboxItemData) => !existingIds.has(i.id));
    return [...prev, ...newItems];
  });
} else {
  setItems(data.items);
}
```

Update the pending count calculation to use the functional state updater's result instead of the stale `items` closure:

```typescript
const allItems = append
  ? [...items, ...data.items.filter((i: InboxItemData) => !new Set(items.map(x => x.id)).has(i.id))]
  : data.items;
const pendingCount = allItems.filter((i) => isPendingStatus(i.status)).length;
```

Actually, simpler approach: move the badge count update to a separate `useEffect` that depends on `items`, so it always reflects the current state regardless of pagination:

After the `useFocusEffect`, add:

```typescript
useEffect(() => {
  const isPendingStatus = (s: string) => s === "pending" || s === "low_confidence";
  const pendingCount = items.filter((i) => isPendingStatus(i.status)).length;
  navigation.setOptions({
    tabBarBadge: pendingCount > 0 ? pendingCount : undefined,
  });
}, [items, navigation]);
```

And remove the badge count logic from inside `fetchInbox`.
  </action>
  <verify>
Check TypeScript compilation:
```bash
cd mobile && npx tsc --noEmit
```

Verify the dependency array fix:
```bash
grep -A2 "useCallback" mobile/app/conversation/\[threadId\].tsx | grep "item"
```

Verify useFocusEffect is used:
```bash
grep "useFocusEffect" mobile/app/\(tabs\)/inbox.tsx
```

Verify deduplication logic:
```bash
grep "existingIds" mobile/app/\(tabs\)/inbox.tsx
```
  </verify>
  <done>
handleBucketSelect dependency array includes `item`. Inbox screen auto-refreshes on focus via useFocusEffect. FlatList items are deduplicated by ID on append. Badge count derives from items state in a separate useEffect.
  </done>
</task>

</tasks>

<verification>
Both UAT gaps should now be resolved:

1. **Test 5 (HITL on capture screen):** Submit an ambiguous capture like "Had coffee with Mike, he mentioned a new project idea". The Classifier should call request_clarification (not classify_and_file), the adapter should detect the clarification text and emit HITL_REQUIRED, and the capture screen should show bucket buttons with a specific clarifying question.

2. **Test 11 (Filing from conversation screen):** Tap a pending inbox item, select a bucket, and verify:
   - The item.id is correctly sent as inbox_item_id to the respond endpoint
   - The backend creates a bucket document and updates the inbox document status to "classified"
   - Navigating back to inbox shows the item is no longer pending (no manual refresh needed)
   - No duplicate key React warnings

3. **Test 6 (HITL resolution from capture screen):** This was blocked by Test 5. After fixing Test 5, tapping a bucket button on the capture screen should file the capture and show confirmation before resetting.
</verification>

<success_criteria>
- Ambiguous captures trigger HITL clarifying question (not auto-filed)
- Bucket selection on conversation screen actually files the capture in Cosmos DB
- Inbox auto-refreshes when navigating back from conversation screen
- No "two children with same key" React warnings
- Backend respond endpoint returns error messages (not fake success) when inbox_item_id is missing
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-06-SUMMARY.md`
</output>
