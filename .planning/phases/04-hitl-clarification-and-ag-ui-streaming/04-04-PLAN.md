---
phase: 04-hitl-clarification-and-ag-ui-streaming
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/tools/classification.py
  - backend/src/second_brain/models/documents.py
  - backend/src/second_brain/agents/classifier.py
  - backend/src/second_brain/agents/workflow.py
  - backend/src/second_brain/main.py
  - backend/src/second_brain/api/inbox.py
  - backend/tests/test_classification.py
autonomous: true
gap_closure: true
requirements: [CLAS-04, APPX-04]

must_haves:
  truths:
    - "When confidence < 0.6, the Classifier calls request_clarification instead of classify_and_file, creating a pending Inbox document with no bucket container record"
    - "request_clarification returns LLM-generated clarification text with top-2 bucket reasoning, stored as clarificationText on the InboxDocument"
    - "HITL_REQUIRED custom event includes inboxItemId in its value payload so the client can pass it back for resolution"
    - "POST /api/ag-ui/respond with inbox_item_id updates the existing pending Inbox document status to 'classified' and files to the chosen bucket container"
    - "GET /api/inbox/{id} returns clarificationText field for conversation screen display"
  artifacts:
    - path: "backend/src/second_brain/tools/classification.py"
      provides: "request_clarification tool that creates pending Inbox doc with clarificationText"
      contains: "request_clarification"
    - path: "backend/src/second_brain/models/documents.py"
      provides: "clarificationText field on InboxDocument"
      contains: "clarificationText"
    - path: "backend/src/second_brain/agents/classifier.py"
      provides: "Low Confidence Handling section in classifier instructions"
      contains: "request_clarification"
    - path: "backend/src/second_brain/agents/workflow.py"
      provides: "HITL detection from request_clarification output with inboxItemId"
      contains: "inboxItemId"
    - path: "backend/src/second_brain/main.py"
      provides: "respond endpoint that updates existing Inbox doc and files to bucket"
      contains: "upsert_item"
    - path: "backend/src/second_brain/api/inbox.py"
      provides: "clarificationText in InboxItemResponse"
      contains: "clarificationText"
  key_links:
    - from: "backend/src/second_brain/agents/classifier.py"
      to: "backend/src/second_brain/tools/classification.py"
      via: "request_clarification tool reference"
      pattern: "classification_tools\\.request_clarification"
    - from: "backend/src/second_brain/agents/workflow.py"
      to: "HITL_REQUIRED CustomEvent"
      via: "inboxItemId extracted from tool result text"
      pattern: "inboxItemId.*HITL_REQUIRED"
    - from: "backend/src/second_brain/main.py"
      to: "Cosmos DB Inbox container"
      via: "upsert_item to update status from pending to classified"
      pattern: "upsert_item"
---

<objective>
Fix 3 verification blockers on the backend: make the Classifier ask real clarifying questions before filing low-confidence captures, pass inboxItemId through the HITL event stream, and fix the respond endpoint to actually update the database.

Purpose: CLAS-04 requires "Classifier asks the user a focused clarifying question before filing." Currently the Classifier always files immediately and the adapter detects low confidence post-hoc. The respond endpoint cannot update the DB because inboxItemId is never provided. These are the backend half of the 3 gap closure blockers.

Output: Updated backend that creates pending Inbox documents for low-confidence captures (no bucket record), includes inboxItemId in the HITL_REQUIRED event, and correctly files + updates status on HITL resolution.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-VERIFICATION.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-01-SUMMARY.md

Key existing files to read before modifying:
@backend/src/second_brain/tools/classification.py
@backend/src/second_brain/models/documents.py
@backend/src/second_brain/agents/classifier.py
@backend/src/second_brain/agents/workflow.py
@backend/src/second_brain/main.py
@backend/src/second_brain/api/inbox.py
@backend/tests/test_classification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request_clarification tool, clarificationText field, and update classifier instructions</name>
  <files>
    backend/src/second_brain/tools/classification.py
    backend/src/second_brain/models/documents.py
    backend/src/second_brain/agents/classifier.py
    backend/tests/test_classification.py
  </files>
  <action>
**1. Add `clarificationText` field to InboxDocument** (`models/documents.py`):

Add one field to the InboxDocument class:
```python
clarificationText: str | None = None
```

This stores the LLM-generated clarification text (e.g., "I'm torn between People (0.55) and Projects (0.42). Which fits better?") for later display on the conversation screen.

**2. Add `request_clarification` tool** (`tools/classification.py`):

Add a new `@tool` method to `ClassificationTools` class:

```python
@tool
async def request_clarification(
    self,
    raw_text: Annotated[str, "The original captured text"],
    title: Annotated[str, "Brief title extracted from the text (3-6 words)"],
    top_bucket: Annotated[str, "Most likely bucket"],
    top_confidence: Annotated[float, "Confidence for top bucket (must be < 0.6)"],
    second_bucket: Annotated[str, "Second most likely bucket"],
    second_confidence: Annotated[float, "Confidence for second bucket"],
    clarification_text: Annotated[str, "A specific question explaining your top 2 buckets and why you're unsure. Example: 'I'm torn between People (0.55) and Projects (0.42) — this mentions Mike but also a potential relocation project. Which fits better?'"],
    people_score: Annotated[float, "Score 0.0-1.0 for People bucket"],
    projects_score: Annotated[float, "Score 0.0-1.0 for Projects bucket"],
    ideas_score: Annotated[float, "Score 0.0-1.0 for Ideas bucket"],
    admin_score: Annotated[float, "Score 0.0-1.0 for Admin bucket"],
) -> str:
    """Request human clarification when classification confidence is below 0.6.

    Creates a pending Inbox document (NO bucket container record) and returns
    the clarification text for streaming to the user. The capture will be
    filed to the correct bucket only after the user responds.
    """
```

Implementation:
- Validate `top_bucket` and `second_bucket` are in `VALID_BUCKETS`
- Create an `InboxDocument` with `status="pending"`, `filedRecordId=None`, `clarificationText=clarification_text`
- Build `ClassificationMeta` with `bucket=top_bucket`, `confidence=top_confidence`, all four scores
- Write ONLY to the Inbox container (no bucket container write)
- Return a string in a parseable format: `"Clarification → {inbox_doc_id} | {clarification_text}"`
  - The adapter will parse the inbox_doc_id from this return string
  - The clarification_text portion will be streamed to the user as TEXT_MESSAGE_CONTENT

**3. Update classifier instructions** (`classifier.py`):

Replace Rule 1 in the instructions string. Change:
```
"1. ALWAYS call classify_and_file with your best bucket and honest confidence score\n"
```
To:
```
"1. When confidence >= 0.6, call classify_and_file immediately with your best bucket\n"
"2. When confidence < 0.6, call request_clarification instead — do NOT call classify_and_file for low-confidence classifications\n"
```

Add a new section AFTER the Rules section:
```
"\n## Low Confidence Handling\n\n"
"When your confidence is below 0.6, you MUST call request_clarification "
"instead of classify_and_file. In your clarification_text parameter, explain "
"your top 2 bucket candidates with their scores and why you're torn. "
"Be specific to this capture — do NOT use generic questions.\n\n"
"Example clarification_text: 'I'm torn between People (0.55) and Projects "
"(0.42). This mentions Mike (a person) but also discusses a potential "
"relocation which could be a life project. Which fits better?'\n"
```

Renumber the remaining rules accordingly (old 2 becomes 3, old 3 becomes 4, old 4 becomes 5, old 5 becomes 6).

Also add `classification_tools.request_clarification` to the tools list in the agent creation:
```python
tools=[
    classification_tools.classify_and_file,
    classification_tools.request_clarification,
    classification_tools.mark_as_junk,
],
```

**4. Update tests** (`tests/test_classification.py`):

Add tests for the new `request_clarification` tool:

- `test_request_clarification_creates_pending_inbox`: Call request_clarification, verify Inbox create_item called with status="pending", filedRecordId=None, clarificationText set. Verify NO bucket container write occurs.
- `test_request_clarification_returns_parseable_string`: Verify return string matches format "Clarification → {uuid} | {text}".
- `test_request_clarification_invalid_bucket`: Verify error return for invalid bucket names.

Update the existing `test_classify_and_file_low_confidence` test comment to note this is testing the tool directly (the classifier agent would call request_clarification instead for < 0.6, but classify_and_file still works if called directly).

Run all tests: `cd backend && uv run pytest tests/ -v`
  </action>
  <verify>
1. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run pytest tests/test_classification.py -v` — all tests pass including new request_clarification tests
2. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run ruff check src/ tests/` — no linting errors
3. Grep classifier.py for "request_clarification" — appears in tools list and instructions
4. Grep documents.py for "clarificationText" — field exists on InboxDocument
  </verify>
  <done>
- InboxDocument has clarificationText field
- request_clarification tool creates pending Inbox docs (no bucket record) with clarification text
- Classifier instructions have Low Confidence Handling section directing to request_clarification when < 0.6
- All tests pass including new tests for request_clarification
  </done>
</task>

<task type="auto">
  <name>Task 2: Update adapter HITL detection, respond endpoint, and Inbox API response</name>
  <files>
    backend/src/second_brain/agents/workflow.py
    backend/src/second_brain/main.py
    backend/src/second_brain/api/inbox.py
  </files>
  <action>
**1. Update adapter HITL detection** (`workflow.py`):

The current adapter detects HITL by parsing confidence from "Filed → Bucket (0.XX)" text. Now the Classifier will call `request_clarification` which returns "Clarification → {inbox_doc_id} | {clarification_text}". Update the detection:

Add a new regex at module level (alongside existing `_FILED_CONFIDENCE_RE`):
```python
_CLARIFICATION_RE = re.compile(r"Clarification\s*→\s*([a-f0-9\-]+)\s*\|\s*(.+)", re.DOTALL)
```

Add a new static method to `AGUIWorkflowAdapter`:
```python
@staticmethod
def _extract_clarification(text: str) -> tuple[str, str] | None:
    """Extract (inbox_item_id, clarification_text) from request_clarification output."""
    match = _CLARIFICATION_RE.search(text)
    return (match.group(1), match.group(2)) if match else None
```

In `_stream_updates`, update the text scanning logic. Currently `detected_confidence` is tracked. Replace/augment this with `detected_clarification`:

Add a new tracking variable:
```python
detected_clarification: tuple[str, str] | None = None  # (inbox_item_id, clarification_text)
```

In the text scanning sections (both the WorkflowEvent output branch and the direct AgentResponseUpdate branch), add clarification detection BEFORE confidence detection:
```python
if update.text and detected_clarification is None:
    clar = self._extract_clarification(update.text)
    if clar is not None:
        detected_clarification = clar
    elif detected_confidence is None:
        conf = self._extract_confidence(update.text)
        if conf is not None:
            detected_confidence = conf
```

Update the HITL_REQUIRED emission at the end of `_stream_updates`. Currently it only fires for low confidence. Add clarification detection FIRST (prioritized):

```python
# After workflow completes: emit HITL if clarification was requested
if detected_clarification is not None:
    inbox_item_id, clarification_text = detected_clarification
    logger.info(
        "Clarification requested for inbox item %s, emitting HITL_REQUIRED",
        inbox_item_id,
    )
    yield CustomEvent(
        name="HITL_REQUIRED",
        value={
            "threadId": thread_id,
            "inboxItemId": inbox_item_id,
            "questionText": clarification_text,
        },
    )
elif (
    detected_confidence is not None
    and detected_confidence < self._classification_threshold
):
    # Legacy fallback for any edge case where classify_and_file is called at low confidence
    logger.info(
        "Low-confidence detected (%.2f < %.2f), emitting HITL_REQUIRED",
        detected_confidence,
        self._classification_threshold,
    )
    yield CustomEvent(
        name="HITL_REQUIRED",
        value={"threadId": thread_id},
    )
```

**2. Fix respond endpoint** (`main.py`):

The current respond endpoint creates a NEW Inbox+bucket document pair when inbox_item_id is provided. Per the decision: "When user picks a bucket: file to the chosen bucket container AND update Inbox document status from 'pending' to 'classified'."

Rewrite the `generate()` inner function in `respond_to_hitl`:

When `body.inbox_item_id` is provided and `cosmos_manager` is available:
1. Read the existing Inbox document via `container.read_item(item=body.inbox_item_id, partition_key="will")`
2. Extract `raw_text`, `title`, `clarificationText` from the existing document
3. Create a NEW bucket container document (People/Projects/Ideas/Admin) using the user's chosen bucket at confidence 0.85
4. Update the EXISTING Inbox document:
   - Set `status = "classified"`
   - Set `filedRecordId = bucket_doc_id`
   - Update `classificationMeta.bucket = bucket`, `classificationMeta.confidence = 0.85`
   - Use `container.upsert_item(body=updated_doc)` to update in place
5. Return `"Filed → {bucket} (0.85)"`

Replace the current `classify_and_file` re-call approach. Do NOT create a second Inbox document. The key change is using `upsert_item` on the existing Inbox document instead of calling `classify_and_file` which creates a new one.

```python
if body.inbox_item_id and cosmos_manager:
    inbox_container = cosmos_manager.get_container("Inbox")
    try:
        # Read existing pending inbox item
        existing = await inbox_container.read_item(
            item=body.inbox_item_id, partition_key="will"
        )
        raw_text = existing.get("rawText", "")
        title = existing.get("title", "Untitled")

        if raw_text:
            # Create bucket document
            bucket_doc_id = str(uuid.uuid4())
            from second_brain.models.documents import (
                CONTAINER_MODELS,
                ClassificationMeta,
            )
            from datetime import UTC, datetime

            classification_meta = ClassificationMeta(
                bucket=bucket,
                confidence=0.85,
                allScores={
                    "People": 0.85 if bucket == "People" else 0.05,
                    "Projects": 0.85 if bucket == "Projects" else 0.05,
                    "Ideas": 0.85 if bucket == "Ideas" else 0.05,
                    "Admin": 0.85 if bucket == "Admin" else 0.05,
                },
                classifiedBy="User",
                agentChain=["Orchestrator", "Classifier", "User"],
                classifiedAt=datetime.now(UTC),
            )

            model_class = CONTAINER_MODELS[bucket]
            kwargs: dict = {
                "id": bucket_doc_id,
                "rawText": raw_text,
                "classificationMeta": classification_meta,
                "inboxRecordId": body.inbox_item_id,
            }
            if bucket == "People":
                kwargs["name"] = title
            else:
                kwargs["title"] = title

            bucket_doc = model_class(**kwargs)
            target_container = cosmos_manager.get_container(bucket)
            await target_container.create_item(body=bucket_doc.model_dump(mode="json"))

            # Update existing inbox document in place
            existing["status"] = "classified"
            existing["filedRecordId"] = bucket_doc_id
            existing["classificationMeta"] = classification_meta.model_dump(mode="json")
            existing["updatedAt"] = datetime.now(UTC).isoformat()
            await inbox_container.upsert_item(body=existing)

            result = f"Filed → {bucket} (0.85)"
        else:
            result = f"Filed → {bucket} (0.85)"
    except Exception:
        logger.warning("Could not process inbox item %s", body.inbox_item_id)
        result = f"Filed → {bucket} (0.85)"
else:
    result = f"Filed → {bucket} (0.85)"
```

Move the `from` imports to the top of the file (alongside existing imports) to avoid inline imports.

**3. Add `clarificationText` to InboxItemResponse** (`api/inbox.py`):

Add one field to the `InboxItemResponse` model:
```python
clarificationText: str | None = None  # noqa: N815
```

Update the response mapping in `list_inbox` to include it:
```python
clarificationText=item.get("clarificationText"),
```

**4. Verify everything works together:**

Run full test suite: `cd backend && uv run pytest tests/ -v`
Run ruff: `cd backend && uv run ruff check src/ tests/ && uv run ruff format --check src/ tests/`
  </action>
  <verify>
1. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run pytest tests/ -v` — all tests pass (31 existing + 3 new from Task 1)
2. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run ruff check src/ tests/` — no linting errors
3. `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run ruff format --check src/ tests/` — formatting OK
4. Grep workflow.py for "inboxItemId" — present in HITL_REQUIRED CustomEvent value
5. Grep workflow.py for "_CLARIFICATION_RE" — regex exists
6. Grep main.py for "upsert_item" — used in respond endpoint
7. Grep inbox.py for "clarificationText" — present in InboxItemResponse and response mapping
  </verify>
  <done>
- Adapter detects "Clarification →" tool output and emits HITL_REQUIRED with inboxItemId and questionText
- Respond endpoint reads existing pending Inbox doc, creates bucket record, updates Inbox status to "classified" via upsert
- InboxItemResponse includes clarificationText for conversation screen
- All backend tests pass
  </done>
</task>

</tasks>

<verification>
1. All backend tests pass: `cd backend && uv run pytest tests/ -v`
2. Ruff clean: `cd backend && uv run ruff check src/ tests/ && uv run ruff format --check src/ tests/`
3. Classifier instructions contain "request_clarification" and "Low Confidence Handling" section
4. InboxDocument model has clarificationText field
5. request_clarification tool creates pending Inbox docs with no bucket write
6. HITL_REQUIRED event payload includes inboxItemId when clarification is requested
7. respond endpoint uses upsert_item to update existing pending Inbox doc (not create new one)
8. InboxItemResponse includes clarificationText field
</verification>

<success_criteria>
- Classifier has two paths: classify_and_file (>= 0.6) and request_clarification (< 0.6)
- Low-confidence captures create pending Inbox records with clarificationText, NO bucket container records
- HITL_REQUIRED SSE event carries inboxItemId for the client to pass back
- POST /api/ag-ui/respond with inbox_item_id updates the existing Inbox doc status and files to bucket
- GET /api/inbox and GET /api/inbox/{id} return clarificationText
- All tests pass, ruff clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-04-SUMMARY.md`
</output>
