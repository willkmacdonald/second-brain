# Phase 4: HITL Clarification and AG-UI Streaming - Context

**Gathered:** 2026-02-22 (updated 2026-02-23 for gap fixes)
**Status:** Ready for planning (gap fix)

<domain>
## Phase Boundary

Transform fire-and-forget captures into a real-time interactive experience. Will sees agents working in real time (Orchestrator -> Classifier step progression) and can respond to clarification questions when the classifier is unsure (confidence < 0.6). Adds an Inbox view for capture history and a conversation screen for pending clarifications accessed from inbox. Voice capture, action sharpening, and search are separate phases.

**Gap fix scope:** Fix 3 blockers from verification — classifier must ask real questions before filing, HITL resolution must update the database, conversation screen must show real classifier reasoning.

</domain>

<decisions>
## Implementation Decisions

### Real-time processing feedback
- Step dots (horizontal pills) showing Orchestrator -> Classifier, each lights up as it activates (progress stepper pattern)
- Step dots appear below the text input on the capture screen — no modal or overlay
- Streamed text response appears live word-by-word as the agent generates it (ChatGPT typing effect)
- After successful classification, result auto-resets after 2-3 seconds — input clears, ready for next capture

### Clarification question design (GAP FIX)
- Classifier pauses BEFORE filing when confidence < 0.6 — nothing written to a bucket container until user responds
- Classifier shows its top 2 buckets with reasoning: "I'm torn between People (0.55) and Projects (0.42). Which fits better?"
- Clarification text is generated by the LLM per-capture, not a generic/hardcoded question
- 4 bucket buttons for resolution (bucket buttons only — no text input, voice input deferred to Phase 5)
- Top 2 suggested buckets are visually prominent (filled/primary buttons), other 2 are subdued (outline/secondary)
- No timeout on clarification — stays on screen until user taps a bucket or submits a new capture
- Classifier can ask up to 2 clarification exchanges before must-file with best guess
- If user ignores clarification and submits a new capture: pending item saves to inbox (status: pending, NOT filed to any bucket container)

### HITL resolution flow (GAP FIX)
- Pending captures are stored as Inbox documents with status 'pending' (no bucket container record yet)
- When user picks a bucket: file to the chosen bucket container AND update Inbox document status from 'pending' to 'classified'
- Inbox document ID flows to the client via the HITL_REQUIRED custom event data in the SSE stream (Claude's discretion on exact mechanism)
- Capture screen stores the inbox ID and passes it to sendClarification for resolution
- Conversation screen already has the item ID from the inbox fetch — passes it to sendClarification
- Pending items are always resolvable from inbox — no expiration, no stale warnings

### Conversation screen content (GAP FIX)
- Shows original captured text at the top, then classifier's top-2 bucket reasoning below, with 4 bucket buttons at the bottom
- Classifier reasoning text stored as a field on the Inbox document (e.g., clarificationText) — conversation screen fetches via GET /api/inbox/{id}
- Top 2 suggested buckets visually emphasized (filled/primary buttons), other 2 available but subdued (outline/secondary)
- After resolution: navigate back to inbox, item now shows as filed (orange dot gone, chosen bucket displayed)

### Inbox view
- Each item shows: text preview, bucket, relative time (e.g., "2 min ago")
- Pending clarification items have a colored accent/badge (e.g., orange dot) to stand out from filed items
- Tapping a filed item opens a detail card (full text, bucket, confidence, agent chain, timestamp)
- Tapping a pending item navigates to a conversation screen for that thread
- Show last 20 captures, pull up to load more older batches
- Pull-to-refresh for latest data

### Navigation and screen flow
- Bottom tab bar with Capture and Inbox tabs — always one tap away
- Capture tab is the default when opening the app (primary action)
- Keep the existing 4 large capture buttons (Voice, Photo, Video, Text) on the capture screen — tabs added below
- Conversation screen for pending clarifications pushes from inbox (stack navigation on top of tabs)
- After filing from conversation screen, navigate back to inbox (item now shows as filed)
- Inbox tab shows a badge count for pending clarifications
- Inbox syncs immediately when a capture triggers clarification — if user switches to inbox tab, pending item already visible

### Claude's Discretion
- Step dot visual design (colors, sizes, animation style)
- Exact auto-reset timing within 2-3 second range
- Detail card layout and styling
- Loading states and error handling
- Badge color and style for pending items
- How to handle the echo bug filter (server-side vs client-side approach)
- Conversation screen layout for clarification from inbox
- React Context vs other state management for syncing capture state to inbox
- Exact mechanism for returning inbox document ID in SSE stream (HITL_REQUIRED event data vs separate custom event)
- How to implement the classifier "pause before filing" flow (remove from autonomous mode, use request_info, or generate question text as tool output)

</decisions>

<specifics>
## Specific Ideas

- Step dots should feel like a progress stepper — each dot lights up sequentially as agents activate
- Clarification flow is designed for speed: see reasoning, tap bucket, done. No typing needed.
- Inline clarification on capture screen keeps you in flow; conversation screen from inbox is for revisiting pending items later
- Badge count on inbox tab creates gentle urgency to resolve pending items without being pushy
- Classifier reasoning should feel transparent: "Here's what I think and why" — not just a generic question
- Voice input for clarification responses is a Phase 5 enhancement (user prefers voice as default input for responding to questions)
- Top-2 bucket emphasis helps guide the user without hiding the override options

</specifics>

<deferred>
## Deferred Ideas

- Voice input for clarification responses — Phase 5 (user wants voice as default input for responding to agent questions, text from LLM)

</deferred>

---

*Phase: 04-hitl-clarification-and-ag-ui-streaming*
*Context gathered: 2026-02-22 (gap fix update: 2026-02-23)*
