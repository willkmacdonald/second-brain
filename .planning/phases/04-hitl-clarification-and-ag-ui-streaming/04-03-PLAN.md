---
phase: 04-hitl-clarification-and-ag-ui-streaming
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - mobile/app/(tabs)/inbox.tsx
  - mobile/app/conversation/[threadId].tsx
  - mobile/components/InboxItem.tsx
  - mobile/app/(tabs)/_layout.tsx
autonomous: false
requirements: [APPX-02, APPX-04]

must_haves:
  truths:
    - "Inbox view shows recent captures with text preview, bucket, and relative time"
    - "Pending clarification items have a colored accent (orange dot) to stand out from filed items"
    - "Tapping a filed item opens a detail card showing full text, bucket, confidence, agent chain, and timestamp"
    - "Tapping a pending item navigates to a conversation screen for that thread"
    - "Conversation screen shows agent's clarifying question with 4 bucket buttons for resolution"
    - "After filing from conversation screen, user navigates back to inbox with item now showing as filed"
    - "Pull-to-refresh updates the inbox list"
    - "Inbox tab shows badge count for pending clarifications"
  artifacts:
    - path: "mobile/app/(tabs)/inbox.tsx"
      provides: "Inbox list screen with FlatList, pull-to-refresh, detail card modal"
      contains: "InboxScreen"
    - path: "mobile/app/conversation/[threadId].tsx"
      provides: "Conversation screen for HITL clarification from inbox"
      contains: "ConversationScreen"
    - path: "mobile/components/InboxItem.tsx"
      provides: "Inbox list item component with status indicator"
      contains: "InboxItem"
  key_links:
    - from: "mobile/app/(tabs)/inbox.tsx"
      to: "/api/inbox"
      via: "fetch GET request"
      pattern: "fetch.*api/inbox"
    - from: "mobile/app/(tabs)/inbox.tsx"
      to: "mobile/app/conversation/[threadId].tsx"
      via: "router.push on pending item tap"
      pattern: "router.push.*conversation"
    - from: "mobile/app/conversation/[threadId].tsx"
      to: "mobile/lib/ag-ui-client.ts"
      via: "sendClarification function"
      pattern: "sendClarification"
---

<objective>
Inbox list view and conversation screen for HITL clarification

Purpose: Give Will a history of all captures with their classification status, and a way to revisit and resolve pending clarifications from the inbox. The inbox shows recent captures with visual distinction between filed and pending items. Tapping a pending item opens a focused conversation screen where the user can resolve the classification.

Output: Inbox screen with FlatList/pull-to-refresh/detail card, InboxItem component, and Conversation screen with bucket buttons for HITL resolution.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-CONTEXT.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-RESEARCH.md
@.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-01-SUMMARY.md

# Key source files:
@mobile/app/(tabs)/_layout.tsx
@mobile/lib/ag-ui-client.ts
@mobile/lib/types.ts
@mobile/constants/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inbox screen with FlatList, pull-to-refresh, detail card, and badge count</name>
  <files>
    mobile/app/(tabs)/inbox.tsx
    mobile/components/InboxItem.tsx
    mobile/app/(tabs)/_layout.tsx
  </files>
  <action>
    **InboxItem.tsx -- Reusable list item component:**

    1. Create `mobile/components/InboxItem.tsx`:
       ```typescript
       interface InboxItemProps {
         item: {
           id: string;
           rawText: string;
           title: string | null;
           status: string;
           createdAt: string;
           classificationMeta: {
             bucket: string;
             confidence: number;
             agentChain: string[];
           } | null;
         };
         onPress: () => void;
       }
       ```
    2. Render each item showing:
       - **Text preview**: `item.title || item.rawText.slice(0, 60)` -- truncated with ellipsis.
       - **Bucket name**: From `classificationMeta.bucket` (or "Pending" if status is "low_confidence").
       - **Relative time**: Convert `createdAt` to relative string (e.g., "2 min ago", "1 hr ago", "yesterday"). Write a simple `getRelativeTime(dateString)` utility function -- no library needed.
       - **Status indicator**: Orange dot (`#f97316`) for `status === "low_confidence"`, no dot for filed items.
    3. Style: Dark theme card/row. Pressable with subtle press effect. Orange dot is a small circle (8x8px) in the top-right or left side of the row.
    4. Per locked decision: "Pending clarification items have a colored accent/badge (e.g., orange dot) to stand out from filed items."

    **inbox.tsx -- Main inbox screen:**

    1. Create `mobile/app/(tabs)/inbox.tsx` as a functional component.
    2. State:
       ```typescript
       const [items, setItems] = useState<InboxItemData[]>([]);
       const [refreshing, setRefreshing] = useState(false);
       const [selectedItem, setSelectedItem] = useState<InboxItemData | null>(null);
       ```
    3. `fetchInbox` function:
       - `GET ${API_BASE_URL}/api/inbox?limit=20` with Bearer auth header.
       - Parse response and set items.
       - Handle error gracefully (empty list or error toast).
    4. Initial load: `useEffect(() => { fetchInbox(); }, [])`.
    5. Pull-to-refresh via FlatList's `refreshControl` prop with `RefreshControl`.
    6. `renderItem`: Use `InboxItem` component.
    7. **Item tap behavior** (per locked decisions):
       - If `item.status === "low_confidence"`: navigate to conversation screen: `router.push(\`/conversation/${item.id}\`)`.
       - If filed: show detail card modal (inline or bottom sheet). The detail card shows:
         - Full text (`item.rawText`)
         - Bucket name
         - Confidence percentage
         - Agent chain (e.g., "Orchestrator -> Classifier")
         - Timestamp (formatted date/time)
       - Implement detail card as a simple modal or overlay within the inbox screen (not a separate route). Use React Native Modal or a state-driven overlay.
    8. **Empty state**: Show "No captures yet" message when list is empty.
    9. **Load more** per locked decision ("pull up to load more"): Implement `onEndReached` on FlatList to fetch next page. Pass `offset` param to API: `GET /api/inbox?limit=20&offset={items.length}`.
    10. Style: Dark theme matching app. List items have subtle separators.

    **_layout.tsx (tabs) -- Add badge count:**

    1. Update the Inbox tab in `(tabs)/_layout.tsx` to show a badge for pending clarifications.
    2. Approach: Either use React Context (from a CaptureContext provider in root layout) or compute badge from inbox fetch.
    3. Simpler approach for now: The inbox screen fetches items. Count items where `status === "low_confidence"` and display as tab badge.
    4. To pass badge count UP to the tab layout, use `expo-router`'s navigation options or a shared state. Simplest: use a small shared module (e.g., `lib/inbox-state.ts`) with a callback or use React Context.
    5. If tab badge is complex to wire without Context, defer badge to a checkpoint and implement the visual inbox first. **Preferred**: Use `router.setParams` or `navigation.setOptions` from within the inbox screen to set the badge dynamically. With expo-router Tabs, the `tabBarBadge` can be set via `<Tabs.Screen options={{ tabBarBadge: count }}>`.
    6. Per locked decision: "Inbox tab shows a badge count for pending clarifications."
  </action>
  <verify>
    Verify files exist:
    ```bash
    ls mobile/app/\(tabs\)/inbox.tsx && ls mobile/components/InboxItem.tsx && echo "Inbox files OK"
    ```
    Verify TypeScript compiles:
    ```bash
    cd mobile && npx tsc --noEmit 2>&1 | head -50
    ```
  </verify>
  <done>
    Inbox screen shows recent captures as a list with text preview, bucket, relative time, and orange dot for pending items. Pull-to-refresh and load-more pagination work. Tapping a filed item shows a detail card overlay. Tapping a pending item navigates to conversation screen. Inbox tab shows badge count for pending clarifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conversation screen for HITL clarification from inbox</name>
  <files>
    mobile/app/conversation/[threadId].tsx
  </files>
  <action>
    **conversation/[threadId].tsx -- Focused clarification screen:**

    1. Create directory `mobile/app/conversation/` and file `[threadId].tsx`.
    2. This screen is accessed by tapping a pending (low_confidence) item in the inbox.
    3. Use `useLocalSearchParams<{ threadId: string }>()` from `expo-router` to get the thread ID.
    4. **Initial data load**: Fetch the inbox item detail from `GET /api/inbox/{threadId}` to display context (the original captured text and the agent's last message/question).
    5. **Layout** (per locked decisions -- conversation screen for pending clarifications from inbox):
       - Header: "Resolve Capture" or similar.
       - Show the original captured text in a card/quote block at the top.
       - Show the agent's clarifying question (from the inbox item or from the classification metadata). Note: The clarifying question may need to be stored in the inbox document. If not stored, show a generic prompt: "Which bucket does this belong to?"
       - Below the question: 4 bucket buttons (People / Projects / Ideas / Admin) -- same design as the inline capture screen buttons from Plan 04-02.
       - Just bucket names on buttons (no confidence scores per locked decision).
    6. **Bucket button handler**:
       - Call `sendClarification({ threadId, bucket, apiKey, callbacks })`.
       - Show a loading state while filing.
       - On success: show success toast, then navigate back to inbox: `router.back()`.
       - Per locked decision: "After filing from conversation screen, navigate back to inbox (item now shows as filed)."
    7. **Edge case**: If the thread_id is no longer in the backend's `_pending_sessions` (server restarted, TTL expired), the `/api/ag-ui/respond` endpoint will return an error. Handle this gracefully:
       - Show "This capture needs to be resubmitted" message.
       - Provide option to go back to inbox.
    8. **Stack screen config**: Set header title to "Resolve" or "Clarify" with back button. In `_layout.tsx` (root), the `conversation/[threadId]` screen should already be declared (from Plan 04-02). If not, add it.
    9. Style: Dark theme, consistent with app. Bucket buttons are large, tappable, and clearly labeled.
  </action>
  <verify>
    Verify file exists:
    ```bash
    ls mobile/app/conversation/\[threadId\].tsx && echo "Conversation screen OK"
    ```
    Verify TypeScript compiles:
    ```bash
    cd mobile && npx tsc --noEmit 2>&1 | head -50
    ```
    Verify the conversation route is declared in root layout:
    ```bash
    grep -l "conversation" mobile/app/_layout.tsx && echo "Route declared"
    ```
  </verify>
  <done>
    Conversation screen loads when tapping a pending inbox item. Shows original captured text, agent's question, and 4 bucket buttons. Tapping a bucket sends the selection to /api/ag-ui/respond, files the capture, and navigates back to inbox. Handles expired sessions gracefully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 4 UX flow</name>
  <files>none</files>
  <action>
    Complete Phase 4 implementation: real-time agent chain visibility (step dots + streaming text), inline HITL clarification with bucket buttons on capture screen, tab navigation (Capture + Inbox), inbox list with pull-to-refresh and detail cards, conversation screen for pending clarifications from inbox.

    Prerequisites: Backend running at localhost:8003, Azure OpenAI and Cosmos DB configured.

    1. **Tab navigation**: Open app. Verify bottom tab bar with "Capture" and "Inbox" tabs. Capture tab is active by default. See 4 capture buttons.

    2. **High-confidence capture**: Tap Text. Type "Pick up prescription at Walgreens". Tap Send.
       - Expected: Step dots appear (Orchestrator lights up, then Classifier).
       - Expected: Streamed text appears word-by-word below step dots.
       - Expected: Result toast shows "Filed -> Admin (0.9x)".
       - Expected: After ~2.5 seconds, everything resets (text cleared, step dots gone).

    3. **Inbox view**: Tap Inbox tab. Pull down to refresh.
       - Expected: See the prescription capture in the list with text preview, "Admin" bucket, and relative time.
       - Tap the item.
       - Expected: Detail card shows full text, bucket, confidence, agent chain, timestamp.

    4. **Low-confidence capture (HITL)**: Go back to Capture tab. Tap Text. Type "Interesting conversation with Mike about moving to Austin". Tap Send.
       - Expected: Step dots animate through Orchestrator -> Classifier.
       - Expected: Agent's clarifying question appears inline below step dots.
       - Expected: 4 bucket buttons appear (People / Projects / Ideas / Admin).
       - Tap "People".
       - Expected: Files immediately, success toast, auto-reset after ~2.5 seconds.

    5. **Inbox pending + conversation**: Go to Capture tab, type another ambiguous capture, submit, but this time switch to Inbox tab WITHOUT tapping a bucket button.
       - Expected: Pending item visible in inbox with orange dot.
       - Expected: Badge count on Inbox tab shows "1".
       - Tap the pending item.
       - Expected: Conversation screen opens with original text, question, and 4 bucket buttons.
       - Tap a bucket.
       - Expected: Files, navigates back to inbox, item now shows as filed (no orange dot).

    6. **Pull-to-refresh**: On inbox, pull down. List should refresh with latest data.
  </action>
  <verify>Type "approved" to complete Phase 4, or describe issues to fix.</verify>
  <done>All 6 verification steps pass. Phase 4 complete: real-time capture UX with step dots, streaming text, inline HITL clarification, inbox with detail cards, and conversation screen for pending items.</done>
</task>

</tasks>

<verification>
1. Inbox list shows captures with text preview, bucket, relative time, and orange dot for pending
2. Detail card shows full text, bucket, confidence, agent chain, timestamp
3. Conversation screen allows resolving pending clarifications with bucket buttons
4. Filing from conversation navigates back to inbox
5. Inbox badge count reflects pending clarification count
6. Pull-to-refresh works on inbox
7. TypeScript compiles without errors
</verification>

<success_criteria>
Inbox view displays all recent captures with status indicators and classification details. Pending clarification items are visually distinct (orange dot) and navigate to a focused conversation screen. After resolving, user returns to inbox and sees the item as filed. Badge count on inbox tab shows pending items.
</success_criteria>

<output>
After completion, create `.planning/phases/04-hitl-clarification-and-ag-ui-streaming/04-03-SUMMARY.md`
</output>
