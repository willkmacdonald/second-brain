---
phase: 09-hitl-parity-and-observability
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/second_brain/streaming/sse.py
  - backend/src/second_brain/streaming/adapter.py
  - backend/src/second_brain/api/capture.py
  - mobile/lib/types.ts
  - mobile/lib/ag-ui-client.ts
  - mobile/app/capture/text.tsx
  - mobile/app/(tabs)/index.tsx
autonomous: true
requirements: [HITL-01]
gap_closure: true

must_haves:
  truths:
    - "Low-confidence capture shows bucket buttons on the capture screen for instant filing"
    - "Classified captures still show the Filed toast without bucket buttons"
    - "Misunderstood captures still trigger the conversational follow-up flow"
    - "Follow-up re-classification returning LOW_CONFIDENCE triggers orphan reconciliation (not just CLASSIFIED)"
  artifacts:
    - path: "backend/src/second_brain/streaming/sse.py"
      provides: "LOW_CONFIDENCE SSE event constructor"
      contains: "def low_confidence_event"
    - path: "backend/src/second_brain/streaming/adapter.py"
      provides: "Emits LOW_CONFIDENCE for pending status instead of CLASSIFIED"
      contains: "low_confidence_event"
    - path: "backend/src/second_brain/api/capture.py"
      provides: "_stream_with_reconciliation handles both CLASSIFIED and LOW_CONFIDENCE for orphan cleanup"
      contains: "LOW_CONFIDENCE"
    - path: "mobile/lib/ag-ui-client.ts"
      provides: "LOW_CONFIDENCE event handler dispatching onLowConfidence callback"
      contains: "LOW_CONFIDENCE"
    - path: "mobile/lib/types.ts"
      provides: "onLowConfidence callback in StreamingCallbacks"
      contains: "onLowConfidence"
  key_links:
    - from: "backend/src/second_brain/streaming/adapter.py"
      to: "backend/src/second_brain/streaming/sse.py"
      via: "import low_confidence_event"
      pattern: "low_confidence_event"
    - from: "mobile/lib/ag-ui-client.ts"
      to: "mobile/app/capture/text.tsx"
      via: "onLowConfidence callback"
      pattern: "onLowConfidence"
    - from: "backend/src/second_brain/api/capture.py"
      to: "backend/src/second_brain/streaming/adapter.py"
      via: "_stream_with_reconciliation detects LOW_CONFIDENCE events from adapter"
      pattern: "LOW_CONFIDENCE"
---

<objective>
Add a LOW_CONFIDENCE SSE event type so the mobile app can distinguish pending captures from classified ones and show bucket buttons on the capture screen.

Purpose: Currently _emit_result_event treats status="pending" the same as "classified" -- both emit CLASSIFIED. The mobile app receives CLASSIFIED and calls onComplete, showing a Filed toast. There is no path for bucket buttons to appear on the capture screen after a low-confidence classification. This plan adds a new LOW_CONFIDENCE event that carries bucket, confidence, and inboxItemId, and the mobile app handles it by showing bucket buttons for instant PATCH filing. Additionally, _stream_with_reconciliation must detect LOW_CONFIDENCE events (not just CLASSIFIED) so follow-up re-classifications returning low-confidence still trigger orphan inbox document reconciliation.

Output: Backend emits LOW_CONFIDENCE for pending items; mobile shows bucket buttons on capture screen; reconciliation handles both event types.
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hitl-parity-and-observability/09-03-SUMMARY.md
@backend/src/second_brain/streaming/sse.py
@backend/src/second_brain/streaming/adapter.py
@backend/src/second_brain/api/capture.py
@mobile/lib/types.ts
@mobile/lib/ag-ui-client.ts
@mobile/app/capture/text.tsx
@mobile/app/(tabs)/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LOW_CONFIDENCE SSE event, emit it for pending status, and update reconciliation</name>
  <files>
    backend/src/second_brain/streaming/sse.py
    backend/src/second_brain/streaming/adapter.py
    backend/src/second_brain/api/capture.py
  </files>
  <action>
    In `sse.py`, add a `low_confidence_event` constructor function after `classified_event`:

    ```python
    def low_confidence_event(inbox_item_id: str, bucket: str, confidence: float) -> dict:
        """Construct a LOW_CONFIDENCE event payload for pending items."""
        return {
            "type": "LOW_CONFIDENCE",
            "value": {
                "inboxItemId": inbox_item_id,
                "bucket": bucket,
                "confidence": confidence,
            },
        }
    ```

    In `adapter.py`:
    1. Add `low_confidence_event` to the import from `second_brain.streaming.sse`
    2. In `_emit_result_event`, change the `if status in ("classified", "pending"):` block to distinguish between the two:
       - If `status == "classified"`: return `classified_event(item_id, bucket, confidence)` (unchanged)
       - If `status == "pending"`: return `low_confidence_event(item_id, bucket, confidence)`
       - The current combined check `if status in ("classified", "pending")` must be split into two separate if checks.

    In `capture.py` -- update `_stream_with_reconciliation` to handle `LOW_CONFIDENCE` events with the same reconciliation path as `CLASSIFIED`:
    1. In the event parsing loop (the `async for event in inner_generator:` block), add a check for `LOW_CONFIDENCE` alongside the existing `CLASSIFIED` check:
       ```python
       if event_type == "CLASSIFIED":
           value = payload.get("value", {})
           new_item_id = value.get("inboxItemId")
           is_classified = True

       elif event_type == "LOW_CONFIDENCE":
           value = payload.get("value", {})
           new_item_id = value.get("inboxItemId")
           is_classified = True  # Same reconciliation path as CLASSIFIED
       ```
    2. The existing reconciliation logic after the loop (`if is_classified and new_item_id:`) already handles the rest -- it reads the new doc, copies classificationMeta to original, deletes the orphan. This works identically for both CLASSIFIED and LOW_CONFIDENCE because file_capture creates the same inbox doc structure for both statuses.
    3. Update the docstring for `_stream_with_reconciliation` to mention LOW_CONFIDENCE: "Wrap follow-up stream to reconcile orphan inbox documents on CLASSIFIED or LOW_CONFIDENCE."

    Do NOT change the misunderstood or unresolved paths in adapter.py. Do NOT change stream_text_capture, stream_voice_capture, or stream_follow_up_capture generator logic -- only `_emit_result_event` needs to change in adapter.py.
  </action>
  <verify>
    `grep -n "low_confidence_event" backend/src/second_brain/streaming/sse.py` shows the function definition.
    `grep -n "low_confidence_event" backend/src/second_brain/streaming/adapter.py` shows the import and usage.
    `grep -n "status == .pending." backend/src/second_brain/streaming/adapter.py` confirms pending is handled separately from classified.
    `grep -n "LOW_CONFIDENCE" backend/src/second_brain/api/capture.py` shows the new event type check in _stream_with_reconciliation.
  </verify>
  <done>
    Backend emits LOW_CONFIDENCE event (type: "LOW_CONFIDENCE", value: {inboxItemId, bucket, confidence}) when file_capture returns status="pending". CLASSIFIED event still emitted for status="classified". _stream_with_reconciliation handles both CLASSIFIED and LOW_CONFIDENCE for orphan reconciliation. Misunderstood and unresolved paths unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle LOW_CONFIDENCE in mobile SSE client and show bucket buttons on capture screens</name>
  <files>
    mobile/lib/types.ts
    mobile/lib/ag-ui-client.ts
    mobile/app/capture/text.tsx
    mobile/app/(tabs)/index.tsx
  </files>
  <action>
    **types.ts:**
    1. Add `"LOW_CONFIDENCE"` to the `AGUIEventType` union type (in the v2 section)
    2. Add `onLowConfidence?: (inboxItemId: string, bucket: string, confidence: number) => void;` to `StreamingCallbacks`

    **ag-ui-client.ts:**
    1. Add `"LOW_CONFIDENCE"` to the `AGUIEventType` import (it comes from types.ts via the type)
    2. In the `attachCallbacks` function, add a new case in the switch statement BEFORE the `COMPLETE` case:

    ```typescript
    case "LOW_CONFIDENCE":
      // Low-confidence classification -- show bucket buttons for manual filing
      if (parsed.value) {
        hitlTriggered = true; // Prevents COMPLETE from firing onComplete
        callbacks.onLowConfidence?.(
          parsed.value.inboxItemId ?? "",
          parsed.value.bucket ?? "?",
          parsed.value.confidence ?? 0,
        );
      }
      break;
    ```

    Set `hitlTriggered = true` so the COMPLETE event just closes the EventSource without calling onComplete (same pattern as MISUNDERSTOOD).

    **text.tsx:**
    In `handleSubmit`'s `sendCapture` callbacks, add `onLowConfidence`:
    ```typescript
    onLowConfidence: (inboxItemId: string, bucket: string, _confidence: number) => {
      // Show bucket buttons for low-confidence classification
      setHitlInboxItemId(inboxItemId);
      setHitlQuestion(`Best guess: ${bucket}. Which bucket?`);
      setShowSteps(true); // CRITICAL: bucket buttons are gated on {showSteps && ...}
      setSending(false);
      // Extract top bucket from the agent's guess
      setHitlTopBuckets([bucket]);
    },
    ```
    IMPORTANT: `setShowSteps(true)` is required because the bucket button UI in text.tsx is rendered inside a `{showSteps && (...)}` conditional block. Without it, `hitlQuestion` will be set but the buttons will be invisible.

    **index.tsx (voice capture screen):**
    In `handleRecordToggle`'s `sendVoiceCapture` callbacks, add `onLowConfidence`:
    ```typescript
    onLowConfidence: (inboxItemId: string, bucket: string, _confidence: number) => {
      // Show bucket buttons for low-confidence classification
      setHitlInboxItemId(inboxItemId);
      setHitlQuestion(`Best guess: ${bucket}. Which bucket?`);
      setShowSteps(true); // CRITICAL: bucket buttons are gated on {showSteps && ...}
      setProcessing(false);
      setHitlTopBuckets([bucket]);
    },
    ```
    Same pattern -- reuse existing HITL bucket button UI. `setShowSteps(true)` is equally critical here if index.tsx uses the same conditional rendering pattern.

    Also add `onLowConfidence` to both `handleFollowUpSubmit` callbacks in text.tsx and index.tsx. For follow-up, if the re-classification comes back as low-confidence, treat it as a successful filing with a toast (the user already provided context, so auto-accept the pending result):
    ```typescript
    onLowConfidence: (inboxItemId: string, bucket: string, confidence: number) => {
      setIsReclassifying(false);
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
      setToast({ message: `Filed -> ${bucket} (${confidence.toFixed(2)})`, type: "success" });
      setTimeout(resetState, AUTO_RESET_MS);
    },
    ```
    (Use resetState for text.tsx, resetVoiceState for index.tsx)
  </action>
  <verify>
    `grep -n "LOW_CONFIDENCE" mobile/lib/types.ts` shows the type and callback.
    `grep -n "LOW_CONFIDENCE" mobile/lib/ag-ui-client.ts` shows the switch case.
    `grep -n "onLowConfidence" mobile/app/capture/text.tsx` shows the callback in both sendCapture and sendFollowUp.
    `grep -n "onLowConfidence" mobile/app/(tabs)/index.tsx` shows the callback in both sendVoiceCapture and sendFollowUp.
    `grep -n "setShowSteps(true)" mobile/app/capture/text.tsx` confirms showSteps is set in the onLowConfidence callback.
    `cd mobile && npx tsc --noEmit` passes with no type errors.
  </verify>
  <done>
    Mobile app handles LOW_CONFIDENCE SSE event by showing bucket buttons on both text and voice capture screens. setShowSteps(true) ensures the bucket button container is visible. User taps a bucket to PATCH recategorize (existing flow). Follow-up re-classification that returns low-confidence auto-accepts with a toast. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- Backend: `grep "LOW_CONFIDENCE" backend/src/second_brain/streaming/sse.py backend/src/second_brain/streaming/adapter.py` shows event constructor and usage
- Backend: `grep "LOW_CONFIDENCE" backend/src/second_brain/api/capture.py` shows reconciliation handling
- Mobile: `npx tsc --noEmit` in mobile/ passes
- Mobile: `grep -r "onLowConfidence" mobile/` shows callbacks in types.ts, ag-ui-client.ts, text.tsx, and index.tsx
- Mobile: `grep -r "setShowSteps(true)" mobile/app/capture/text.tsx` confirms bucket button visibility for low-confidence
- The CLASSIFIED case in ag-ui-client.ts is unchanged (still calls onComplete for high-confidence)
- The MISUNDERSTOOD case is unchanged (still calls onMisunderstood for follow-up)
</verification>

<success_criteria>
1. Backend emits LOW_CONFIDENCE event when status="pending" (not CLASSIFIED)
2. Backend still emits CLASSIFIED when status="classified"
3. _stream_with_reconciliation handles LOW_CONFIDENCE with same orphan cleanup as CLASSIFIED
4. Mobile shows bucket buttons on capture screen for low-confidence captures (showSteps is set to true)
5. Mobile shows Filed toast for high-confidence captures (unchanged)
6. Mobile misunderstood follow-up flow is unchanged
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-hitl-parity-and-observability/09-04-SUMMARY.md`
</output>
