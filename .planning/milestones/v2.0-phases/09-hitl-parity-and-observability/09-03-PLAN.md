---
phase: 09-hitl-parity-and-observability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/app/capture/text.tsx
  - mobile/app/(tabs)/index.tsx
  - mobile/lib/ag-ui-client.ts
  - backend/src/second_brain/streaming/adapter.py
  - backend/src/second_brain/api/capture.py
autonomous: true
gap_closure: true
requirements: [HITL-01, OBSV-01]

must_haves:
  truths:
    - "Tapping a bucket button during active capture (text or voice) instantly files the item via PATCH to /api/inbox/{id}/recategorize"
    - "sendClarification function and its v1 /api/ag-ui/respond references are removed from the codebase"
    - "capture.original_inbox_item_id OTel span attribute contains the actual Cosmos inbox item ID, not the Foundry thread ID"
  artifacts:
    - path: "mobile/app/capture/text.tsx"
      provides: "handleBucketSelect using fetch PATCH to recategorize endpoint"
      contains: "/api/inbox/"
    - path: "mobile/app/(tabs)/index.tsx"
      provides: "handleBucketSelect using fetch PATCH to recategorize endpoint"
      contains: "/api/inbox/"
    - path: "mobile/lib/ag-ui-client.ts"
      provides: "sendClarification removed, no /api/ag-ui/respond references"
    - path: "backend/src/second_brain/streaming/adapter.py"
      provides: "stream_follow_up_capture with original_inbox_item_id parameter"
      contains: "original_inbox_item_id"
    - path: "backend/src/second_brain/api/capture.py"
      provides: "Caller passes original_inbox_item_id to stream_follow_up_capture"
  key_links:
    - from: "mobile/app/capture/text.tsx"
      to: "/api/inbox/{id}/recategorize"
      via: "fetch PATCH in handleBucketSelect"
      pattern: "api/inbox.*recategorize"
    - from: "mobile/app/(tabs)/index.tsx"
      to: "/api/inbox/{id}/recategorize"
      via: "fetch PATCH in handleBucketSelect"
      pattern: "api/inbox.*recategorize"
---

<objective>
Fix two verification gaps from 09-VERIFICATION.md:

1. **HITL-01 blocker**: In-capture bucket selection (text.tsx and index.tsx) calls sendClarification() targeting deleted v1 endpoint /api/ag-ui/respond. Replace with direct fetch PATCH to /api/inbox/{id}/recategorize — the same pattern already used in inbox.tsx and conversation/[threadId].tsx. Also remove the now-dead sendClarification function from ag-ui-client.ts.

2. **OBSV-01 minor**: capture.original_inbox_item_id span attribute in stream_follow_up_capture set to foundry_thread_id instead of actual inbox item ID. Add original_inbox_item_id parameter and wire from caller.

Purpose: Complete HITL-01 parity — all bucket selection paths (inbox, conversation, and active capture) use the same instant PATCH pattern. Fix observability data accuracy.
Output: Modified mobile capture screens, cleaned ag-ui-client.ts, corrected OTel span in adapter.py
</objective>

<execution_context>
@/Users/willmacdonald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/willmacdonald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hitl-parity-and-observability/09-VERIFICATION.md
@.planning/phases/09-hitl-parity-and-observability/09-01-SUMMARY.md
@.planning/phases/09-hitl-parity-and-observability/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sendClarification with direct PATCH in capture screens and remove dead code</name>
  <files>
    mobile/app/capture/text.tsx
    mobile/app/(tabs)/index.tsx
    mobile/lib/ag-ui-client.ts
  </files>
  <action>
**text.tsx (mobile/app/capture/text.tsx):**

1. Add `API_BASE_URL` to the import from `../../constants/config` (line 13 already imports `API_KEY`).
2. Remove `sendClarification` from the import on line 12. The import becomes: `import { sendCapture, sendFollowUp } from "../../lib/ag-ui-client";`
3. Replace the `handleBucketSelect` function (lines 224-258) with a direct fetch PATCH. The new implementation:
   - Guard: `if (!hitlInboxItemId || isResolving) return;` (use `hitlInboxItemId` not `hitlThreadId` — the thread ID is irrelevant for PATCH)
   - Set `isResolving(true)` and hide question UI (`setHitlQuestion(null)`)
   - `fetch(`${API_BASE_URL}/api/inbox/${hitlInboxItemId}/recategorize`, { method: "PATCH", headers: { Authorization: "Bearer ${API_KEY}", "Content-Type": "application/json" }, body: JSON.stringify({ new_bucket: bucket }) })`
   - On `res.ok`: haptic success, toast "Filed", `setTimeout(resetState, AUTO_RESET_MS)`
   - On failure or catch: toast "Couldn't file. Try again."
   - Finally: `setIsResolving(false)`
   - Make the callback `async` (useCallback with async inner function, same pattern as conversation/[threadId].tsx line 59)
   - Update the dependency array: `[hitlInboxItemId, isResolving, resetState]` (drop `hitlThreadId`)
   - Do NOT assign to `cleanupRef.current` (no SSE connection to clean up)

**index.tsx (mobile/app/(tabs)/index.tsx):**

1. Add `API_BASE_URL` to the import from `../../constants/config` (line ~29 already imports `API_KEY`).
2. Remove `sendClarification` from the import on lines 24-28. The import becomes: `import { sendVoiceCapture, sendFollowUp } from "../../lib/ag-ui-client";`
3. Replace `handleBucketSelect` (lines 362-398) with the same PATCH pattern as text.tsx above, but:
   - Uses `resetVoiceState` instead of `resetState`
   - Dependency array: `[hitlInboxItemId, isResolving, resetVoiceState]`
   - Do NOT assign to `cleanupRef.current`

**ag-ui-client.ts (mobile/lib/ag-ui-client.ts):**

1. Delete the `sendClarification` function (lines 196-229) and its JSDoc comment.
2. Delete the `SendClarificationOptions` interface if it exists (grep for it).
3. Remove the line referencing "HITL sendClarification" in the comment on line 168 if it makes the comment incomplete — update to reflect current state.
4. The `sendClarification` export is no longer referenced anywhere after the text.tsx and index.tsx changes.
  </action>
  <verify>
    Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain && grep -r "sendClarification" mobile/ --include="*.ts" --include="*.tsx"` — should return zero results.
    Run: `grep -r "ag-ui/respond" mobile/ --include="*.ts" --include="*.tsx"` — should return zero results.
    Run: `grep "api/inbox.*recategorize" mobile/app/capture/text.tsx mobile/app/\(tabs\)/index.tsx` — should find PATCH calls in both files.
    Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/mobile && npx expo lint 2>&1 | tail -5` — no new lint errors.
  </verify>
  <done>
    Both capture screens (text and voice) use direct fetch PATCH to /api/inbox/{id}/recategorize for bucket selection. sendClarification function and all references to /api/ag-ui/respond are removed from the mobile codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix capture.original_inbox_item_id OTel span attribute in stream_follow_up_capture</name>
  <files>
    backend/src/second_brain/streaming/adapter.py
    backend/src/second_brain/api/capture.py
  </files>
  <action>
**adapter.py (backend/src/second_brain/streaming/adapter.py):**

1. Add `original_inbox_item_id: str` parameter to `stream_follow_up_capture` function signature (after `foundry_thread_id`).
2. Change line 351-352 from:
   ```python
   span.set_attribute(
       "capture.original_inbox_item_id", foundry_thread_id
   )
   ```
   To:
   ```python
   span.set_attribute(
       "capture.original_inbox_item_id", original_inbox_item_id
   )
   ```
3. Update the docstring to mention the `original_inbox_item_id` parameter.

**capture.py (backend/src/second_brain/api/capture.py):**

1. In the `follow_up` endpoint (line ~352), add `original_inbox_item_id=body.inbox_item_id` to the `stream_follow_up_capture()` call. The call becomes:
   ```python
   generator = stream_follow_up_capture(
       client=client,
       follow_up_text=body.follow_up_text,
       foundry_thread_id=foundry_thread_id,
       original_inbox_item_id=body.inbox_item_id,
       tools=tools,
       thread_id=foundry_thread_id,
       run_id=run_id,
   )
   ```
  </action>
  <verify>
    Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain && grep -n "original_inbox_item_id" backend/src/second_brain/streaming/adapter.py` — should show it as a parameter and in span.set_attribute.
    Run: `grep -n "original_inbox_item_id" backend/src/second_brain/api/capture.py` — should show it passed to stream_follow_up_capture.
    Run: `cd /Users/willmacdonald/Documents/Code/claude/second-brain/backend && uv run ruff check src/second_brain/streaming/adapter.py src/second_brain/api/capture.py` — no lint errors.
  </verify>
  <done>
    The capture.original_inbox_item_id OTel span attribute correctly records the Cosmos inbox item ID (not the Foundry thread ID). The parameter is threaded from the follow_up endpoint through to the span.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "sendClarification" mobile/` returns zero results
2. `grep -r "ag-ui/respond" mobile/` returns zero results
3. Both text.tsx and index.tsx contain `api/inbox.*recategorize` PATCH calls
4. adapter.py `stream_follow_up_capture` has `original_inbox_item_id` parameter
5. capture.py passes `original_inbox_item_id=body.inbox_item_id` to the generator
6. `ruff check` passes on modified backend files
7. `npx expo lint` passes on modified mobile files
</verification>

<success_criteria>
- All bucket selection paths (inbox, conversation, text capture, voice capture) use the same instant PATCH pattern to /api/inbox/{id}/recategorize
- No references to the deleted v1 endpoint /api/ag-ui/respond remain in the mobile codebase
- The capture_follow_up OTel span reports the actual Cosmos inbox item ID in its capture.original_inbox_item_id attribute
</success_criteria>

<output>
After completion, create `.planning/phases/09-hitl-parity-and-observability/09-03-SUMMARY.md`
</output>
